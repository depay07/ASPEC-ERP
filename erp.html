<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ASPEC ERP - Integrated System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 12px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal.active { display: flex; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        th { background-color: #f8fafc; color: #64748b; font-weight: 600; padding: 12px; text-align: center; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #334155; font-size: 0.9rem; }
        .input-box { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; }
        .input-box:focus { outline: none; border-color: #06b6d4; ring: 2px solid #06b6d4; }

        /* ì¸ì‡„ ì „ìš© ìŠ¤íƒ€ì¼ */
        @media print {
            @page { size: A4; margin: 10mm; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-2xl font-bold text-white tracking-wider">ASPEC <span class="text-cyan-400 text-xs align-top">ERP</span></h1>
            </div>
            <nav class="flex-1 py-4 space-y-1 overflow-y-auto">
                <div class="px-4 text-xs font-bold text-slate-500 uppercase mt-4 mb-2">ê¸°ì´ˆ ë“±ë¡</div>
                <button onclick="switchTab('partners')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-building"></i> ê±°ë˜ì²˜ ê´€ë¦¬</button>
                <button onclick="switchTab('products')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-box"></i> í’ˆëª© ê´€ë¦¬</button>
                
                <div class="px-4 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">êµ¬ë§¤ ê´€ë¦¬</div>
                <button onclick="switchTab('purchases')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-cart-flatbed"></i> êµ¬ë§¤ ë‚´ì—­</button>
                
                <div class="px-4 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">ì˜ì—… ê´€ë¦¬</div>
                <button onclick="switchTab('quotes')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-file-invoice"></i> ê²¬ì  ê´€ë¦¬</button>
                <button onclick="switchTab('orders')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-file-signature"></i> ì£¼ë¬¸(ìˆ˜ì£¼) ê´€ë¦¬</button>
                <button onclick="switchTab('sales')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white transition flex items-center gap-3"><i class="fa-solid fa-truck-fast"></i> íŒë§¤(ì¶œê³ ) ê´€ë¦¬</button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full bg-slate-800 py-2 rounded text-sm hover:text-white">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8 relative" id="mainContent">
            <div id="contentArea"></div>
        </main>
    </div>

    <div id="genericModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="modalTitle" class="text-2xl font-bold text-slate-800">ì…ë ¥</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 text-2xl"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="modalBody">
                </div>
        </div>
    </div>

    <div id="loadDataModal" class="modal" style="z-index: 60;">
        <div class="modal-content" style="max-width: 800px;">
            <h3 class="text-xl font-bold mb-4">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100">
                        <tr><th class="p-2">ë‚ ì§œ</th><th class="p-2">ê±°ë˜ì²˜</th><th class="p-2">ê¸ˆì•¡</th><th class="p-2">ì„ íƒ</th></tr>
                    </thead>
                    <tbody id="loadDataBody"></tbody>
                </table>
            </div>
            <button onclick="document.getElementById('loadDataModal').classList.remove('active')" class="mt-4 px-4 py-2 bg-slate-500 text-white rounded">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="printArea" class="hidden p-10 bg-white text-black">
        <div class="border-2 border-black p-1">
            <div class="border border-black p-8">
                <div class="flex justify-between items-center border-b-2 border-black pb-2 mb-6">
                    <div class="text-sm">
                        <div>ì¼ì: <span id="prtDate"></span></div>
                    </div>
                    <h1 class="text-4xl font-serif font-bold tracking-[1rem]">ê±° ë˜ ëª… ì„¸ ì„œ</h1>
                    <div class="text-sm text-right">
                        <div>No. <span id="prtNo"></span></div>
                    </div>
                </div>

                <div class="flex border border-black mb-6">
                    <div class="w-1/2 border-r border-black">
                        <div class="bg-slate-100 text-center font-bold border-b border-black py-1">ê³µê¸‰ ë°›ëŠ” ì</div>
                        <div class="p-2 grid grid-cols-1 gap-2 text-sm">
                            <div class="flex"><span class="w-16 font-bold">ìƒí˜¸</span> <span id="prtPartner" class="flex-1"></span></div>
                            <div class="flex"><span class="w-16 font-bold">ì£¼ì†Œ</span> <span class="flex-1">-</span></div>
                            <div class="flex"><span class="w-16 font-bold">ë‹´ë‹¹ì</span> <span id="prtManager" class="flex-1"></span></div>
                        </div>
                    </div>
                    <div class="w-1/2">
                        <div class="bg-slate-100 text-center font-bold border-b border-black py-1">ê³µ ê¸‰ ì</div>
                        <div class="p-2 grid grid-cols-1 gap-2 text-sm relative">
                            <div class="flex"><span class="w-16 font-bold">ë“±ë¡ë²ˆí˜¸</span> <span>130-86-72885</span></div>
                            <div class="flex"><span class="w-16 font-bold">ìƒí˜¸</span> <span>(ì£¼)ASPEC Tech</span> <span class="font-bold ml-4">ì„±ëª…</span> ì´ì°½í˜„</div>
                            <div class="flex"><span class="w-16 font-bold">ì£¼ì†Œ</span> <span>ê²½ê¸° ì•ˆì–‘ì‹œ...</span></div>
                            <div class="flex"><span class="w-16 font-bold">ì—…íƒœ</span> <span>ì œì¡°,ë„ì†Œë§¤</span> <span class="font-bold ml-4">ì¢…ëª©</span> ì „ìë¶€í’ˆ</div>
                            <div class="absolute right-4 top-8 opacity-50 border-2 border-red-500 rounded-full w-12 h-12 flex items-center justify-center text-red-500 text-xs font-bold transform -rotate-12">ì¸</div>
                        </div>
                    </div>
                </div>

                <div class="border border-black mb-6 p-2 flex justify-between font-bold">
                    <span>í•©ê³„ê¸ˆì•¡ (ê³µê¸‰ê°€ì•¡ + ì„¸ì•¡)</span>
                    <span class="text-lg">â‚© <span id="prtGrandTotal">0</span></span>
                </div>

                <table class="w-full text-sm border-collapse border border-black mb-4">
                    <thead>
                        <tr class="bg-slate-100 text-center">
                            <th class="border border-black p-1">ì›”/ì¼</th>
                            <th class="border border-black p-1">í’ˆëª©ëª…</th>
                            <th class="border border-black p-1">ê·œê²©</th>
                            <th class="border border-black p-1">ìˆ˜ëŸ‰</th>
                            <th class="border border-black p-1">ë‹¨ê°€</th>
                            <th class="border border-black p-1">ê³µê¸‰ê°€ì•¡</th>
                            <th class="border border-black p-1">ì„¸ì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="prtTableBody" class="text-center"></tbody>
                    <tfoot>
                        <tr class="font-bold bg-slate-50">
                            <td colspan="5" class="border border-black p-2 text-center">ì†Œ ê³„</td>
                            <td id="prtSupplyTotal" class="border border-black p-2 text-right"></td>
                            <td id="prtVatTotal" class="border border-black p-2 text-right"></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="flex justify-between text-sm mt-8">
                    <div>ì¸ìˆ˜ì: ________________ (ì¸)</div>
                    <div>ë‚©í’ˆì: ASPEC Tech (ì¸)</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì •] ë³¸ì¸ì˜ Supabase URL/Key ì…ë ¥ (ë”°ì˜´í‘œ ì£¼ì˜)
        // ==========================================
        const SUPABASE_URL = 'https://gqttpmdpqotrkbdbstuu.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdHRwbWRwcW90cmtiZGJzdHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjU4MjIsImV4cCI6MjA3ODk0MTgyMn0.pR6dL8yU2lpugzYWpdDkQh_l5WcVO4YMlOPhMlCJmP8'; 
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentTab = 'partners';
        let tempItems = []; 
        let partnerList = []; 
        let productList = []; 

        window.onload = async () => {
            await fetchData('partners');
            await fetchData('products');
            switchTab('partners'); 
        };

        async function switchTab(tab) {
            currentTab = tab;
            const container = document.getElementById('contentArea');
            let html = '';

            const titles = {
                'partners': 'ê¸°ì´ˆë“±ë¡ > ê±°ë˜ì²˜ ê´€ë¦¬',
                'products': 'ê¸°ì´ˆë“±ë¡ > í’ˆëª© ê´€ë¦¬',
                'purchases': 'êµ¬ë§¤ ê´€ë¦¬', // ìˆ˜ì •: DB í…Œì´ë¸”ëª…ê³¼ ì¼ì¹˜ì‹œí‚´
                'quotes': 'ì˜ì—… ê´€ë¦¬ > ê²¬ì ì„œ',
                'orders': 'ì˜ì—… ê´€ë¦¬ > ì£¼ë¬¸ì„œ(ìˆ˜ì£¼)',
                'sales': 'ì˜ì—… ê´€ë¦¬ > íŒë§¤(ì¶œê³ )'
            };

            html += `<div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">${titles[tab]}</h2>
                        <button onclick="openNewModal('${tab}')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg shadow-cyan-500/30 transition">
                            <i class="fa-solid fa-plus mr-2"></i> ì‹ ê·œ ë“±ë¡
                        </button>
                     </div>`;

            html += `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left border-collapse">`;
            
            if (tab === 'partners') {
                html += `<thead><tr><th>ìƒí˜¸</th><th>ë‹´ë‹¹ì</th><th>ì „í™”ë²ˆí˜¸</th><th>ì‚¬ì—…ìë²ˆí˜¸</th><th>ë¹„ê³ </th></tr></thead><tbody id="listBody"></tbody>`;
            } else if (tab === 'products') {
                html += `<thead><tr><th>í’ˆëª©ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ì…ê³ ë‹¨ê°€</th><th>íŒë§¤ë‹¨ê°€</th></tr></thead><tbody id="listBody"></tbody>`;
            } else if (tab === 'purchases') {
                // ìˆ˜ì •: ë‹¨ê°€ ë° ë¹„ê³ ë€ ë°˜ì˜
                html += `<thead><tr><th>ì¼ì</th><th>ë§¤ì…ì²˜</th><th>í’ˆëª©ëª…</th><th>ìˆ˜ëŸ‰</th><th>ë‹¨ê°€ (VATë³„ë„)</th><th>í•©ê³„</th><th>ë¹„ê³ </th></tr></thead><tbody id="listBody"></tbody>`;
            } else {
                html += `<thead><tr><th>ì¼ì</th><th>ê±°ë˜ì²˜</th><th>ë‹´ë‹¹ì</th><th>ì´ê¸ˆì•¡</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead><tbody id="listBody"></tbody>`;
            }
            
            html += `</table></div>`;
            container.innerHTML = html;
            
            loadListData(tab);
        }

        async function loadListData(tab) {
            const tbody = document.getElementById('listBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4">ë¡œë”©ì¤‘...</td></tr>';
            
            const { data, error } = await supabase.from(tab).select('*').order('created_at', { ascending: false });
            
            // ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œê·¸ ì¶œë ¥ ë° í™”ë©´ í‘œì‹œ
            if (error) { 
                console.error("Load Error:", error); 
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-red-500">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}</td></tr>`;
                return; 
            }

            tbody.innerHTML = '';
            if(!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(row => {
                let tr = `<tr class="hover:bg-slate-50 border-b">`;
                if (tab === 'partners') {
                    tr += `<td>${row.name}</td><td>${row.manager_name||'-'}</td><td>${row.phone||'-'}</td><td>${row.biz_num||'-'}</td><td>${row.note||''}</td>`;
                } else if (tab === 'products') {
                    tr += `<td class="font-mono text-cyan-600">${row.code}</td><td>${row.name}</td><td>${row.spec||'-'}</td>
                           <td class="text-right">${(row.cost_price||0).toLocaleString()}</td><td class="text-right font-bold">${(row.price||0).toLocaleString()}</td>`;
                } else if (tab === 'purchases') {
                    // ìˆ˜ì •: êµ¬ë§¤ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ (ë‹¨ê°€ í¬í•¨)
                    tr += `<td>${row.date}</td><td>${row.partner_name}</td><td>${row.item_name}</td><td class="text-center">${row.qty}</td>
                           <td class="text-right">${(row.unit_price||0).toLocaleString()}</td>
                           <td class="text-right font-bold text-slate-600">${(row.supply_price||0).toLocaleString()}</td>
                           <td>${row.note||''}</td>`;
                } else {
                    tr += `<td>${row.date}</td><td class="font-bold">${row.partner_name||'-'}</td><td>${row.manager||'-'}</td>
                           <td class="text-right text-cyan-700 font-bold">${(row.total_amount||0).toLocaleString()}ì›</td><td>${row.note||''}</td>
                           <td class="text-center">
                                ${tab === 'sales' ? `<button onclick='printTrans(${JSON.stringify(row)})' class="bg-slate-100 px-2 py-1 rounded text-xs border hover:bg-slate-200">ì¸ì‡„</button>` : ''}
                           </td>`;
                }
                tr += `</tr>`;
                tbody.innerHTML += tr;
            });
        }

        function openNewModal(tab) {
            const modal = document.getElementById('genericModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            tempItems = []; 

            modal.classList.add('active');
            
            if (tab === 'partners') {
                title.innerText = 'ê±°ë˜ì²˜ ì‹ ê·œ ë“±ë¡';
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-slate-500">ìƒí˜¸ (í•„ìˆ˜)</label><input type="text" id="pName" class="input-box" placeholder="(ì£¼)ASPEC"></div>
                        <div><label class="text-xs text-slate-500">ì‚¬ì—…ìë²ˆí˜¸</label><input type="text" id="pBiz" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ëŒ€í‘œì</label><input type="text" id="pOwner" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ë‹´ë‹¹ìëª…</label><input type="text" id="pManager" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ì „í™”ë²ˆí˜¸</label><input type="text" id="pPhone" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ì´ë©”ì¼</label><input type="text" id="pEmail" class="input-box"></div>
                        <div class="col-span-2"><label class="text-xs text-slate-500">ë¹„ê³ </label><input type="text" id="pNote" class="input-box"></div>
                    </div>
                    <button onclick="savePartner()" class="w-full mt-6 bg-cyan-600 text-white py-3 rounded-lg font-bold">ì €ì¥í•˜ê¸°</button>
                `;
            } else if (tab === 'products') {
                title.innerText = 'í’ˆëª© ì‹ ê·œ ë“±ë¡';
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 bg-blue-50 p-2 rounded text-xs text-blue-600 mb-2">ğŸ’¡ í’ˆëª©ëª…ì„ ì…ë ¥í•˜ë©´ í’ˆëª©ì½”ë“œê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>
                        <div><label class="text-xs text-slate-500">í’ˆëª©ëª…</label><input type="text" id="prodName" class="input-box" oninput="autoGenCode(this.value)"></div>
                        <div><label class="text-xs text-slate-500">í’ˆëª©ì½”ë“œ (ìë™)</label><input type="text" id="prodCode" class="input-box bg-slate-100" readonly></div>
                        <div class="col-span-2"><label class="text-xs text-slate-500">ê·œê²© (Spec)</label><input type="text" id="prodSpec" class="input-box" placeholder="ì˜ˆ: 1/3 inch sensor, 4K"></div>
                        <div><label class="text-xs text-slate-500">ì…ê³ ë‹¨ê°€</label><input type="number" id="prodCost" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">íŒë§¤ë‹¨ê°€</label><input type="number" id="prodPrice" class="input-box"></div>
                    </div>
                    <button onclick="saveProduct()" class="w-full mt-6 bg-cyan-600 text-white py-3 rounded-lg font-bold">ì €ì¥í•˜ê¸°</button>
                `;
            } else if (tab === 'purchases') {
                // ìˆ˜ì •: êµ¬ë§¤ë‚´ì—­ ì…ë ¥í¼ (ë‹¨ê°€ ì¶”ê°€)
                title.innerText = 'êµ¬ë§¤ ë‚´ì—­ ë“±ë¡';
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-slate-500">ì¼ì</label><input type="date" id="purDate" class="input-box" value="${new Date().toISOString().split('T')[0]}"></div>
                        <div><label class="text-xs text-slate-500">ë§¤ì…ì²˜</label><input type="text" id="purPartner" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">í’ˆëª©ëª…</label><input type="text" id="purItem" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ìˆ˜ëŸ‰</label><input type="number" id="purQty" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ë‹¨ê°€ (VAT ë³„ë„)</label><input type="number" id="purPrice" class="input-box" placeholder="0"></div>
                        <div class="col-span-2"><label class="text-xs text-slate-500">ë¹„ê³ </label><input type="text" id="purNote" class="input-box"></div>
                    </div>
                    <button onclick="savePurchase()" class="w-full mt-6 bg-cyan-600 text-white py-3 rounded-lg font-bold">ì €ì¥í•˜ê¸°</button>
                `;
            } else {
                renderSalesForm(tab, body);
            }
        }

        function closeModal() {
            document.getElementById('genericModal').classList.remove('active');
        }

        function autoGenCode(name) {
            if(!name) return;
            const code = 'P-' + Math.floor(Math.random() * 10000) + '-' + Date.now().toString().slice(-4);
            document.getElementById('prodCode').value = code;
        }

        async function savePartner() {
            const data = {
                name: document.getElementById('pName').value,
                biz_num: document.getElementById('pBiz').value,
                owner_name: document.getElementById('pOwner').value,
                manager_name: document.getElementById('pManager').value,
                phone: document.getElementById('pPhone').value,
                email: document.getElementById('pEmail').value,
                note: document.getElementById('pNote').value
            };
            if(!data.name) return alert('ìƒí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            await supabase.from('partners').insert(data);
            closeModal(); loadListData('partners'); fetchData('partners');
        }

        async function saveProduct() {
            const data = {
                name: document.getElementById('prodName').value,
                code: document.getElementById('prodCode').value,
                spec: document.getElementById('prodSpec').value,
                cost_price: document.getElementById('prodCost').value,
                price: document.getElementById('prodPrice').value
            };
            if(!data.name) return alert('í’ˆëª©ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            await supabase.from('products').insert(data);
            closeModal(); loadListData('products'); fetchData('products');
        }

        async function savePurchase() {
            // ìˆ˜ì •: êµ¬ë§¤ë‚´ì—­ ì €ì¥ (ë‹¨ê°€ ì €ì¥ ë° í•©ê³„ ìë™ê³„ì‚°)
            const qty = parseInt(document.getElementById('purQty').value) || 0;
            const price = parseInt(document.getElementById('purPrice').value) || 0;
            
            const data = {
                date: document.getElementById('purDate').value,
                partner_name: document.getElementById('purPartner').value,
                item_name: document.getElementById('purItem').value,
                qty: qty,
                unit_price: price,
                supply_price: qty * price, // í•©ê³„ ê³„ì‚°
                note: document.getElementById('purNote').value
            };
            
            const { error } = await supabase.from('purchases').insert(data);
            if(error) alert("ì €ì¥ ì˜¤ë¥˜: " + error.message);
            else {
                closeModal(); loadListData('purchases');
            }
        }

        function renderSalesForm(tab, container) {
            const today = new Date().toISOString().split('T')[0];
            let loadBtn = '';
            if(tab === 'orders') loadBtn = `<button onclick="openLoadModal('quotes')" class="bg-orange-500 text-white px-3 py-1 rounded text-xs ml-2">ê²¬ì  ë¶ˆëŸ¬ì˜¤ê¸°</button>`;
            if(tab === 'sales') loadBtn = `<button onclick="openLoadModal('orders')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs ml-2">ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>`;

            let dateLabel = tab === 'sales' || tab === 'orders' ? 'ë‚©ê¸°/ë‚©í’ˆì¼ì' : 'ì¼ì';
            let extraFields = '';
            if(tab === 'orders') extraFields = `<div><label class="text-xs text-slate-500">ë°œì£¼ë²ˆí˜¸(PO)</label><input type="text" id="sPO" class="input-box"></div>`;
            
            container.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
                    <div class="grid grid-cols-3 gap-4 mb-2">
                        <div><label class="text-xs text-slate-500">${dateLabel}</label><input type="date" id="sDate" class="input-box" value="${today}"></div>
                        <div class="relative">
                            <label class="text-xs text-slate-500">ê±°ë˜ì²˜ ê²€ìƒ‰</label>
                            <input type="text" id="sPartner" class="input-box" placeholder="ê²€ìƒ‰..." list="partnerOptions" onchange="fillPartnerInfo(this.value)">
                            <datalist id="partnerOptions"></datalist>
                        </div>
                        <div><label class="text-xs text-slate-500">ìš°ë¦¬ì¸¡ ë‹´ë‹¹ì</label><input type="text" id="sManager" class="input-box"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mb-2">
                        <div><label class="text-xs text-slate-500">ê±°ë˜ì²˜ ë‹´ë‹¹ì</label><input type="text" id="sPManager" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">ì´ë©”ì¼/ì—°ë½ì²˜</label><input type="text" id="sContact" class="input-box"></div>
                        ${extraFields}
                    </div>
                    <div><label class="text-xs text-slate-500">ë¹„ê³ </label><input type="text" id="sNote" class="input-box"></div>
                    <div class="mt-2 text-right">${loadBtn}</div>
                </div>

                <div class="bg-white border border-slate-200 rounded-lg p-2 mb-4">
                    <div class="flex gap-2 items-end">
                         <div class="w-1/4">
                            <label class="text-xs">í’ˆëª©ëª…</label>
                            <input type="text" id="iName" class="input-box" list="prodOptions" onchange="fillProdInfo(this.value)">
                            <datalist id="prodOptions"></datalist>
                        </div>
                        <div class="w-1/6"><label class="text-xs">ê·œê²©(ìë™)</label><input type="text" id="iSpec" class="input-box bg-slate-50" readonly></div>
                        <div class="w-20"><label class="text-xs">ìˆ˜ëŸ‰</label><input type="number" id="iQty" class="input-box" value="1"></div>
                        <div class="w-24"><label class="text-xs">ë‹¨ê°€</label><input type="number" id="iPrice" class="input-box"></div>
                        <div class="w-24"><label class="text-xs">ì…ê³ ê°€</label><input type="number" id="iCost" class="input-box"></div>
                        <button onclick="addTempItem()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold h-10">ì¶”ê°€</button>
                    </div>
                </div>

                <table class="w-full text-sm border-collapse border border-slate-200 text-center">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-2">í’ˆëª©ëª…</th>
                            <th class="p-2">ê·œê²©</th>
                            <th class="p-2">ìˆ˜ëŸ‰</th>
                            <th class="p-2">ë‹¨ê°€</th>
                            <th class="p-2">ê³µê¸‰ê°€ì•¡</th>
                            <th class="p-2">ë§ˆì§„ìœ¨</th>
                            <th class="p-2">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="tempItemBody"></tbody>
                </table>
                <div class="text-right mt-4 text-xl font-bold text-cyan-700">ì´ì•¡: <span id="sTotal">0</span>ì›</div>

                <button onclick="saveSalesData('${tab}')" class="w-full mt-6 bg-cyan-600 text-white py-3 rounded-lg font-bold">ë¬¸ì„œ ì €ì¥</button>
            `;

            fillDatalist('partnerOptions', partnerList);
            fillDatalist('prodOptions', productList);
        }

        async function fetchData(table) {
            const { data } = await supabase.from(table).select('*');
            if (table === 'partners') partnerList = data;
            if (table === 'products') productList = data;
        }

        function fillDatalist(id, list) {
            const dl = document.getElementById(id);
            if(!dl) return;
            dl.innerHTML = '';
            list.forEach(item => {
                const val = item.name;
                const opt = document.createElement('option');
                opt.value = val;
                dl.appendChild(opt);
            });
        }

        function fillPartnerInfo(name) {
            const p = partnerList.find(x => x.name === name);
            if(p) {
                document.getElementById('sPManager').value = p.manager_name || '';
                document.getElementById('sContact').value = (p.email || '') + ' ' + (p.phone || '');
            }
        }

        function fillProdInfo(name) {
            const p = productList.find(x => x.name === name);
            if(p) {
                document.getElementById('iSpec').value = p.spec || '';
                document.getElementById('iPrice').value = p.price || 0;
                document.getElementById('iCost').value = p.cost_price || 0;
            }
        }

        function addTempItem() {
            const name = document.getElementById('iName').value;
            if(!name) return;
            
            const qty = parseInt(document.getElementById('iQty').value) || 0;
            const price = parseInt(document.getElementById('iPrice').value) || 0;
            const cost = parseInt(document.getElementById('iCost').value) || 0;
            const spec = document.getElementById('iSpec').value;
            const supply = qty * price;
            
            let margin = 0;
            if (price > 0) margin = ((price - cost) / price * 100).toFixed(1);

            tempItems.push({ name, spec, qty, price, cost, supply, margin });
            renderTempItems();
            
            document.getElementById('iName').value = '';
            document.getElementById('iSpec').value = '';
        }

        function renderTempItems() {
            const tbody = document.getElementById('tempItemBody');
            tbody.innerHTML = '';
            let total = 0;
            tempItems.forEach((item, idx) => {
                total += item.supply;
                tbody.innerHTML += `
                    <tr>
                        <td class="p-2">${item.name}</td>
                        <td class="p-2 text-xs text-slate-500">${item.spec}</td>
                        <td class="p-2">${item.qty}</td>
                        <td class="p-2 text-right">${item.price.toLocaleString()}</td>
                        <td class="p-2 text-right font-bold">${item.supply.toLocaleString()}</td>
                        <td class="p-2 text-xs text-red-500">${item.margin}%</td>
                        <td class="p-2 cursor-pointer text-red-400" onclick="tempItems.splice(${idx},1); renderTempItems();"><i class="fa-solid fa-trash"></i></td>
                    </tr>
                `;
            });
            document.getElementById('sTotal').innerText = total.toLocaleString();
        }

        async function openLoadModal(sourceTab) {
            document.getElementById('loadDataModal').classList.add('active');
            const tbody = document.getElementById('loadDataBody');
            tbody.innerHTML = '<tr><td colspan="4">ë¡œë”©ì¤‘...</td></tr>';
            
            const { data } = await supabase.from(sourceTab).select('*').order('created_at', {ascending: false});
            tbody.innerHTML = '';
            
            data.forEach(row => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-2 text-xs">${row.date}</td>
                        <td class="p-2 font-bold">${row.partner_name}</td>
                        <td class="p-2 text-right text-xs">${(row.total_amount||0).toLocaleString()}</td>
                        <td class="p-2"><button onclick='applyLoadedData(${JSON.stringify(row)})' class="bg-cyan-600 text-white px-2 py-1 rounded text-xs">ì„ íƒ</button></td>
                    </tr>
                `;
            });
        }

        function applyLoadedData(row) {
            document.getElementById('sPartner').value = row.partner_name || '';
            document.getElementById('sManager').value = row.manager || '';
            if(row.items) {
                tempItems = row.items;
                renderTempItems();
            }
            document.getElementById('loadDataModal').classList.remove('active');
            alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
        }

        async function saveSalesData(tab) {
            if(tempItems.length === 0) return alert('í’ˆëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            
            const total = parseInt(document.getElementById('sTotal').innerText.replace(/,/g, ''));
            const data = {
                date: document.getElementById('sDate').value,
                partner_name: document.getElementById('sPartner').value,
                manager: document.getElementById('sManager').value,
                partner_manager: document.getElementById('sPManager').value, 
                phone: document.getElementById('sContact').value, 
                items: tempItems,
                total_amount: total,
                vat: Math.floor(total * 0.1), 
                note: document.getElementById('sNote').value
            };

            if(tab === 'orders') data.po_number = document.getElementById('sPO').value;

            const { error } = await supabase.from(tab).insert(data);
            if(error) alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            else {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
                loadListData(tab);
            }
        }

        function printTrans(row) {
            document.getElementById('prtDate').innerText = row.date;
            document.getElementById('prtNo').innerText = row.id; 
            document.getElementById('prtPartner').innerText = row.partner_name;
            document.getElementById('prtManager').innerText = row.partner_manager || ''; 
            
            const tbody = document.getElementById('prtTableBody');
            tbody.innerHTML = '';
            
            let supplyTotal = 0;
            let vatTotal = 0;

            if(row.items && Array.isArray(row.items)) {
                row.items.forEach(item => {
                    const supply = item.qty * item.price;
                    const vat = Math.floor(supply * 0.1);
                    supplyTotal += supply;
                    vatTotal += vat;
                    
                    const md = row.date.substring(5, 10); 

                    tbody.innerHTML += `
                        <tr>
                            <td class="border border-black p-1">${md}</td>
                            <td class="border border-black p-1 text-left pl-2">${item.name}</td>
                            <td class="border border-black p-1">${item.spec || ''}</td>
                            <td class="border border-black p-1">${item.qty}</td>
                            <td class="border border-black p-1 text-right pr-2">${item.price.toLocaleString()}</td>
                            <td class="border border-black p-1 text-right pr-2">${supply.toLocaleString()}</td>
                            <td class="border border-black p-1 text-right pr-2">${vat.toLocaleString()}</td>
                        </tr>
                    `;
                });
            }

            for(let i=0; i < 5 - (row.items?.length || 0); i++) {
                tbody.innerHTML += `<tr><td class="border border-black p-1">&nbsp;</td><td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td><td class="border border-black p-1"></td></tr>`;
            }

            document.getElementById('prtSupplyTotal').innerText = supplyTotal.toLocaleString();
            document.getElementById('prtVatTotal').innerText = vatTotal.toLocaleString();
            document.getElementById('prtGrandTotal').innerText = (supplyTotal + vatTotal).toLocaleString();

            window.print();
        }

        function logout() {
            supabase.auth.signOut().then(() => window.location.href = 'index.html');
        }
    </script>
</body>
</html>
