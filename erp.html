<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ASPEC ERP System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; font-size: 13px; background-color: #f1f5f9; }
        
        /* 모달 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 8px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal.active { display: flex; }

        /* 테이블 */
        .data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .data-table th { background-color: #e2e8f0; color: #475569; font-weight: 700; padding: 12px 8px; border-bottom: 2px solid #cbd5e1; text-align: center; font-size: 14px; }
        .data-table td { padding: 12px 8px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
        
        .input-box { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; transition: all 0.2s; font-size: 14px; }
        .input-box:focus { outline: none; border-color: #06b6d4; ring: 2px solid #e0f2fe; }
        .search-panel { background-color: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .search-label { font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 6px; display: block; text-transform: uppercase; }
        
        /* 대시보드 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 1s ease-out forwards; }

        /* 캘린더 스타일 */
        .calendar-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day-header { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; text-align: center; font-weight: 600; color: #64748b; font-size: 12px; }
        .calendar-day { border: 1px solid #e2e8f0; min-height: 120px; padding: 4px; background: white; cursor: pointer; transition: background 0.2s; position: relative; overflow: hidden; }
        .calendar-day:hover { background: #f8fafc; }
        .calendar-day.other-month { background: #f1f5f9; color: #94a3b8; }
        .calendar-day.today { background: #eff6ff; border: 2px solid #3b82f6; }
        .calendar-day-number { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: #1e293b; }
        .calendar-day.other-month .calendar-day-number { color: #94a3b8; }
        .calendar-day.today .calendar-day-number { color: #2563eb; font-weight: 700; }
        .calendar-event { font-size: 11px; padding: 2px 6px; margin: 2px 0; border-radius: 3px; cursor: pointer; transition: opacity 0.2s; word-wrap: break-word; white-space: normal; line-height: 1.3; }
        .calendar-event:hover { opacity: 0.8; }
        .calendar-event.allday { font-weight: 600; }
        .calendar-more-events { font-size: 11px; color: #64748b; cursor: pointer; padding: 2px 6px; margin: 2px 0; text-align: center; font-weight: 600; }
        .calendar-more-events:hover { background: #f1f5f9; border-radius: 3px; }

        /* 1. 요일 이름 (헤더: 일, 월, 화...) 색상 변경 */
        /* 일요일 (매주 첫 번째 칸) -> 빨간색 */
        .calendar-day-header:nth-child(7n+1) { 
            color: #ef4444 !important; 
        }
        /* 토요일 (매주 일곱 번째 칸) -> 파란색 */
        .calendar-day-header:nth-child(7n) { 
            color: #3b82f6 !important; 
        }
        
        /* 2. 날짜 숫자 (1, 2, 3...) 색상 변경 */
        /* 일요일 날짜 -> 빨간색 (단, 흐린 날짜 제외) */
        .calendar-day:nth-child(7n+1):not(.other-month) .calendar-day-number { 
            color: #ef4444 !important; 
        }
        /* 토요일 날짜 -> 파란색 (단, 흐린 날짜 제외) */
        .calendar-day:nth-child(7n):not(.other-month) .calendar-day-number { 
            color: #3b82f6 !important; 
        }


        
        
        /* 이벤트 색상 */
        .event-red { background-color: #fee2e2; color: #991b1b; }
        .event-orange { background-color: #fed7aa; color: #9a3412; }
        .event-yellow { background-color: #fef08a; color: #854d0e; }
        .event-green { background-color: #bbf7d0; color: #166534; }
        .event-blue { background-color: #bfdbfe; color: #1e40af; }
        .event-indigo { background-color: #c7d2fe; color: #3730a3; }
        .event-purple { background-color: #e9d5ff; color: #6b21a8; }
        .event-pink { background-color: #fbcfe8; color: #9f1239; }
        
        .color-selector { display: flex; gap: 8px; margin-top: 8px; }
        .color-option { width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 0 0 4px #1e293b; }

        /* 인쇄 전용 스타일 */
        @media print {
            @page { size: A4; margin: 0; }
            body { margin: 0; padding: 0; background: white; }
            body * { visibility: hidden; }
            
            #printContainer, #printContainer * { visibility: visible; box-sizing: border-box; }
            #printContainer { position: absolute; left: 0; top: 0; width: 100%; font-family: "Malgun Gothic", dotum, sans-serif; color: black !important; }
            
            .print-wrap { width: 100%; padding: 15mm; margin: 0 auto; }
            .print-title-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 2px solid black; padding-bottom: 5px; }
            .print-title-main { font-size: 36px; font-weight: 900; letter-spacing: -1px; }
            .print-title-sub { font-size: 16px; font-weight: normal; font-style: italic; margin-left: 10px; }
            .print-meta { text-align: right; font-size: 11px; line-height: 1.4; }
        
            .print-grid-box { display: flex; width: 100%; border: 1px solid black; margin-bottom: 10px; }
            .print-half { width: 50%; padding: 0; flex: 1; }
            .print-half:first-child { border-right: 1px solid black; }
        
            .print-info-table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; border: none; }
            .print-info-table th { background-color: #f3f3f3 !important; text-align: center; padding: 5px; border-bottom: 1px solid black; border-right: 1px solid black; width: 20%; font-weight: bold; height: 30px; -webkit-print-color-adjust: exact; }
            .print-info-table td { padding: 2px 5px; border-bottom: 1px solid black; height: 30px; vertical-align: middle; font-size: 11px; word-break: break-all; overflow: hidden; }
            .print-info-table tr:last-child th, .print-info-table tr:last-child td { border-bottom: none; }
            .print-header-cell { text-align: center; font-weight: bold; padding: 5px; border-bottom: 1px solid black; font-size: 14px; background-color: #e6e6e6 !important; -webkit-print-color-adjust: exact; }
        
            .print-items-table { width: 100%; border-collapse: collapse; margin-top: 30px; font-size: 11px; table-layout: fixed; }
            .print-items-table th { border: 1px solid black; background-color: #f3f3f3 !important; padding: 5px; text-align: center; -webkit-print-color-adjust: exact; }
            .print-items-table td { border: 1px solid black; padding: 5px; height: 35px; word-break: keep-all; white-space: normal; vertical-align: middle; }
            
            .addr-cell { height: 55px !important; vertical-align: top !important; padding-top: 5px !important; line-height: 1.4; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen overflow-hidden no-print">
        <aside class="w-52 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800">
                <a href="erp.html" class="block cursor-pointer hover:opacity-80 transition"><h1 class="text-2xl font-bold text-white">ASPEC <span class="text-cyan-400 text-sm">ERP</span></h1></a>
            </div>
    <nav class="flex-1 py-4 overflow-y-auto text-base">
        <button onclick="switchTab('dashboard')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3 bg-slate-800 text-white font-bold"><i class="fa-solid fa-house w-5"></i> 홈 화면</button>
        <button onclick="switchTab('calendar')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-calendar-days w-5"></i> 일정 관리</button>
        
        <button onclick="switchTab('bookkeeping')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-calculator w-5"></i> 기장 관리</button>
    
        <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-4 mb-2">영업 관리</div>
        <button onclick="switchTab('quotes')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-invoice w-5"></i> 견적 관리</button>
        <button onclick="switchTab('orders')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-signature w-5"></i> 주문 관리</button>
        <button onclick="switchTab('sales')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-truck-fast w-5"></i> 판매 관리</button>
        <button onclick="switchTab('collections')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-sack-dollar w-5"></i> 수금 관리</button>
    
        <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">자재/발주</div>
        <button onclick="switchTab('purchase_orders')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-import w-5"></i> 발주 관리 (PO)</button>
        <button onclick="switchTab('purchases')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-dolly w-5"></i> 구매 관리 (입고)</button>
        <button onclick="switchTab('inventory')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-warehouse w-5"></i> 재고 관리 현황</button>
        
        <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">기초 등록</div>
        <button onclick="switchTab('partners')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-building w-5"></i> 거래처 관리</button>
        <button onclick="switchTab('products')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-box w-5"></i> 품목 관리</button>
    </nav>
            <div class="p-6 border-t border-slate-800"><button onclick="logout()" class="w-full bg-slate-800 py-3 rounded text-sm hover:text-white font-bold">로그아웃</button></div>
        </aside>
        <main class="flex-1 overflow-y-auto p-8" id="mainContent">
            <div id="searchContainer"></div>
            <div id="contentArea"></div>
        </main>
    </div>

    <div id="genericModal" class="modal no-print"><div class="modal-content"><div class="flex justify-between items-center mb-6 border-b pb-4"><h2 id="modalTitle" class="text-2xl font-bold text-slate-800">입력</h2><button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-2xl"></i></button></div><div id="modalBody"></div></div></div>
    <div id="loadDataModal" class="modal no-print" style="z-index: 60;"><div class="modal-content" style="max-width: 800px;"><h3 class="text-xl font-bold mb-4" id="loadModalTitle">데이터 불러오기</h3><div class="overflow-y-auto max-h-96 border rounded"><table class="w-full text-left text-sm"><thead class="bg-slate-50"><tr><th class="p-3">날짜</th><th class="p-3">거래처</th><th class="p-3">총액</th><th class="p-3">선택</th></tr></thead><tbody id="loadDataBody"></tbody></table></div><div class="mt-6 text-right"><button onclick="document.getElementById('loadDataModal').classList.remove('active')" class="px-6 py-2 bg-slate-200 rounded text-sm font-bold">닫기</button></div></div></div>

    <!-- 일정 추가/수정 모달 -->
    <div id="eventModal" class="modal no-print">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="eventModalTitle" class="text-2xl font-bold text-slate-800">일정 추가</h2>
                <button onclick="closeEventModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-2xl"></i></button>
            </div>
            <div id="eventModalBody">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">일정 제목</label>
                    <input type="text" id="eventTitle" class="input-box" placeholder="일정 제목을 입력하세요">
                </div>
                
                <div class="mb-4">
                    <label class="flex items-center gap-2 text-sm font-semibold text-slate-700 mb-2">
                        <input type="checkbox" id="eventAllDay" onchange="toggleAllDay()">
                        <span>하루 종일</span>
                    </label>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">시작</label>
                        <input type="date" id="eventStartDate" class="input-box mb-2">
                        <input type="time" id="eventStartTime" class="input-box">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">종료</label>
                        <input type="date" id="eventEndDate" class="input-box mb-2">
                        <input type="time" id="eventEndTime" class="input-box">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">메모</label>
                    <textarea id="eventDescription" class="input-box" rows="3" placeholder="메모를 입력하세요"></textarea>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">색상 라벨</label>
                    <div class="color-selector">
                        <div class="color-option event-red" data-color="red" onclick="selectColor('red')"></div>
                        <div class="color-option event-orange" data-color="orange" onclick="selectColor('orange')"></div>
                        <div class="color-option event-yellow" data-color="yellow" onclick="selectColor('yellow')"></div>
                        <div class="color-option event-green selected" data-color="green" onclick="selectColor('green')"></div>
                        <div class="color-option event-blue" data-color="blue" onclick="selectColor('blue')"></div>
                        <div class="color-option event-indigo" data-color="indigo" onclick="selectColor('indigo')"></div>
                        <div class="color-option event-purple" data-color="purple" onclick="selectColor('purple')"></div>
                        <div class="color-option event-pink" data-color="pink" onclick="selectColor('pink')"></div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button id="deleteEventBtn" onclick="deleteEvent()" class="px-6 py-3 bg-red-500 text-white rounded font-bold hover:bg-red-600" style="display: none;">삭제</button>
                    <div class="flex-1"></div>
                    <button onclick="closeEventModal()" class="px-6 py-3 bg-slate-200 rounded font-bold hover:bg-slate-300 mr-2">취소</button>
                    <button onclick="saveEvent()" class="px-6 py-3 bg-blue-500 text-white rounded font-bold hover:bg-blue-600">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 일정 더보기 모달 -->
    <div id="allEventsModal" class="modal no-print">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 id="allEventsModalTitle" class="text-2xl font-bold text-slate-800">일정 목록</h2>
                <button onclick="closeAllEventsModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-2xl"></i></button>
            </div>
            <div id="allEventsModalBody" class="max-h-96 overflow-y-auto">
                <!-- 일정 목록이 여기에 표시됩니다 -->
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeAllEventsModal()" class="px-6 py-3 bg-slate-200 rounded font-bold hover:bg-slate-300">닫기</button>
            </div>
        </div>
    </div>

    <div id="printContainer" class="hidden">
        <div class="print-wrap">
            <div class="print-title-area">
                <div><span id="p_title_ko" class="print-title-main">견 적 서</span><span id="p_title_en" class="print-title-sub">QUOTATION</span></div>
                <div class="print-meta"><div>문서번호: <span id="p_no"></span></div><div>작성일자: <span id="p_date"></span></div>                   
            </div> </div>
            <div class="print-grid-box">
                <div class="print-half">
                    <div class="print-header-cell" id="p_left_role">공 급 받 는 자</div>
                    <table class="print-info-table">
                        <colgroup><col style="width: 20%;"><col style="width: 80%;"></colgroup>
                        <tr><th>상호</th><td id="p_left_name"></td></tr>
                        <tr id="print_row_addr_1"><th>주소</th><td id="p_left_addr" class="addr-cell"></td></tr>
                        <tr><th>담당자</th><td id="p_left_manager"></td></tr>
                        <tr><th>TEL</th><td id="p_left_phone"></td></tr>
                        <tr><th>E-mail</th><td id="p_left_email"></td></tr>
                    </table>
                </div>
                <div class="print-half">
                    <div class="print-header-cell" id="p_right_role">공 급 자</div>
                    <table class="print-info-table">
                        <colgroup><col style="width: 20%;"><col style="width: 80%;"></colgroup>
                        <tr><th>상호</th><td id="p_right_name">아스펙 (ASPEC)</td></tr>
                        <tr id="print_row_addr_2"><th>주소</th><td class="addr-cell" style="font-size: 10px;">경기도 화성시 메타폴리스로 42, 9층 902호<br>(반송동, 디앤씨빌딩)</td></tr>                   
                        <tr><th>담당자</th><td id="p_right_manager"></td></tr>
                        <tr><th>TEL</th><td id="p_right_mp"></td></tr>
                        <tr><th>E-mail</th><td id="p_right_email"></td></tr>
                    </table>
                </div>
            </div>
            <table class="print-items-table">
                <colgroup><col style="width: 5%;"><col style="width: 25%;"><col style="width: 30%;"><col style="width: 8%;"><col style="width: 8%;"><col style="width: 12%;"><col style="width: 12%;"></colgroup>
                <thead><tr><th>No</th><th>품명</th><th>규격</th><th>단위</th><th>수량</th><th>단가</th><th>공급가액</th></tr></thead>
                <tbody id="p_tbody"></tbody>
                <tfoot>
                    <tr style="background: #f8f8f8; font-weight: bold;"><td colspan="4" style="text-align: center; border-right: 1px solid black;">합 계 (Total)</td><td style="text-align: center; border-right: 1px solid black;" id="p_total_qty"></td><td style="text-align: right; border-right: 1px solid black;">VAT 포함</td><td style="text-align: right;" id="p_total_amt"></td></tr>
                    <tr style="background: #fff; border-top: 2px double black;"><td colspan="7" style="padding: 10px; text-align: left;"><strong>[비고]</strong> <span id="p_note"></span></td></tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gqttpmdpqotrkbdbstuu.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdHRwbWRwcW90cmtiZGJzdHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjU4MjIsImV4cCI6MjA3ODk0MTgyMn0.pR6dL8yU2lpugzYWpdDkQh_l5WcVO4YMlOPhMlCJmP8'; 
        if(!SUPABASE_URL || SUPABASE_URL.includes('YOUR_URL')) alert("API 키를 설정해주세요.");

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentTab = 'dashboard';
        let tempItems = []; 
        let partnerList = []; 
        let productList = [];
        let currentEditId = null; 
        let currentUserEmail = ""; 
        let globalDataStore = {};
        let sessionTimer;
        let currentLoadedOrderId = null; // 불러온 주문서 ID 저장용
        let currentLoadSource = '';      // 불러온 데이터가 견적(quotes)인지 주문(orders)인지 구분

        const quotes = [
            "할 수 있다고 믿는다면, 이미 절반은 해낸 것이다.",
    "위대한 업적은 대개 커다란 위험을 감수한 결과이다.",
    "실패는 성공으로 가는 이정표이다.",
    "오늘 걷지 않으면 내일은 뛰어야 한다.",
    "작은 기회로부터 종종 위대한 업적이 시작된다.",
    "성공의 비결은 시작하는 것이다.",
    "준비된 자에게만 기회가 온다.",
    "꿈을 꿀 수 있다면, 이룰 수도 있다.",
    "최고의 복수는 엄청난 성공이다.",
    "미래는 현재 우리가 무엇을 하는가에 달려 있다.",
    "멈추지 않는 이상, 얼마나 천천히 가는지는 문제가 되지 않는다.",
    "성공은 매일 반복되는 작은 노력들의 합이다.",
    "기회는 일어나는 것이 아니라 만들어내는 것이다.",
    "변화는 우리가 누군가를 기다리거나 무언가를 기다린다고 오지 않는다.",
    "위대한 것은 갑자기 이루어지지 않는다.",
    "행동 없는 말은 이상주의를 훼손한다.",
    "성공한 사람은 멈추지 않는다. 실수할 수는 있지만 포기하지 않는다.",
    "중요한 것은 꺾이지 않는 마음이다.",
    "탁월함은 행동이 아니라 습관이다.",
    "가장 큰 영광은 한 번도 실패하지 않음이 아니라, 실패할 때마다 다시 일어서는 데 있다.",
    "시련은 있어도 실패는 없다.",
    "성공하기 전에는 항상 불가능해 보인다.",
    "자신을 믿어라. 자신의 능력을 신뢰하라.",
    "고통 없이는 얻는 것도 없다.",
    "지금 자면 꿈을 꾸지만, 지금 공부하면 꿈을 이룬다.",
    "피할 수 없으면 즐겨라.",
    "늦었다고 생각할 때가 가장 빠른 때이다.",
    "오늘 할 일을 내일로 미루지 말라.",
    "생각하는 대로 살지 않으면 사는 대로 생각하게 된다.",
    "신용은 금고안의 돈보다 낫다."
        ];

        window.onload = async () => { 
            try { 
                const { data: { user } } = await supabase.auth.getUser();
                if(user) currentUserEmail = user.email;
                setupAutoTimeSync();
                await fetchData(); 
                switchTab('dashboard'); 
                startSessionTimer();
            } catch (e) { console.error("초기화 오류: ", e); }
        };

        // [신규 기능] 날짜/시간 자동 동기화 설정
function setupAutoTimeSync() {
    const sDate = document.getElementById('eventStartDate');
    const eDate = document.getElementById('eventEndDate');
    const sTime = document.getElementById('eventStartTime');
    const eTime = document.getElementById('eventEndTime');

    // 1. 시작 날짜가 변경되면 -> 종료 날짜도 똑같이 변경
    sDate.addEventListener('change', function() {
        eDate.value = this.value;
    });

    // 2. 시작 시간이 변경되면 -> 종료 시간은 '1시간 뒤'로 자동 설정
    sTime.addEventListener('change', function() {
        if (!this.value) return;

        // 현재 선택된 시간(HH:mm)을 가져와서 시/분으로 분리
        const [hours, mins] = this.value.split(':').map(Number);
        
        // 가상의 날짜 객체를 만들어 1시간을 더함
        const dateObj = new Date();
        dateObj.setHours(hours + 1);
        dateObj.setMinutes(mins);

        // 시간을 HH:mm 형식으로 다시 변환
        const newHour = String(dateObj.getHours()).padStart(2, '0');
        const newMin = String(dateObj.getMinutes()).padStart(2, '0');
        
        // 종료 시간에 적용
        eTime.value = `${newHour}:${newMin}`;

        // (선택사항) 만약 23시에서 1시간 더해서 00시가 되어 날짜가 넘어가는 경우, 
        // 종료 날짜가 시작 날짜보다 하루 늦어야 한다면 아래 주석 해제
        /*
        if (hours + 1 >= 24) {
             const startDateObj = new Date(sDate.value);
             startDateObj.setDate(startDateObj.getDate() + 1); // 하루 더하기
             eDate.value = startDateObj.toISOString().split('T')[0];
        } else {
             eDate.value = sDate.value; // 같은 날이면 날짜 맞춤
        }
        */
    });
}

        
        function startSessionTimer() {
            clearTimeout(sessionTimer);
            sessionTimer = setTimeout(() => {
                if(confirm("로그인 시간이 30분 지났습니다. 연장하시겠습니까?")) startSessionTimer(); else logout();
            }, 30 * 60 * 1000);
        }

        async function fetchData() {
            const pRes = await supabase.from('partners').select('*');
            const prodRes = await supabase.from('products').select('*').order('name');
            if(!pRes.error) partnerList = pRes.data || [];
            if(!prodRes.error) productList = prodRes.data || [];
        }

        function storeRowData(row) { const id = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); globalDataStore[id] = row; return id; }
        function getRowData(id) { return globalDataStore[id]; }

        // [수정됨] 수금 관리 검색창(체크박스 포함) 처리
        // [수정됨] 수금 관리 시 조회 기간을 5년 전부터 시작하도록 변경
        function renderSearchPanel(tab) {
            const panel = document.getElementById('searchContainer');
            if (tab === 'dashboard' || tab === 'calendar') { panel.innerHTML = ''; return; }
            
            const today = new Date(); 
            const currentDay = today.toISOString().split('T')[0];
            
            // ============================================================
            // [수정된 날짜 계산 로직]
            // 기본값은 '이번 달 1일'이지만, 수금 관리(collections)일 때는 '5년 전 오늘'로 설정
            // ============================================================
            let startObj = new Date(today.getFullYear(), today.getMonth(), 1); // 기본: 이번 달 1일
            
            if (tab === 'collections') {
                startObj = new Date(); 
                startObj.setFullYear(today.getFullYear() - 5); // 5년 전으로 설정
            }
            
            // toISOString() 사용 시 시차 문제 방지를 위한 간단한 포맷팅 (YYYY-MM-DD)
            // (한국 시간 기준 정확도를 위해 offset 보정 또는 간단히 문자열 처리)
            // 여기서는 기존 로직과 호환되게 ISOString 앞부분을 자릅니다.
            const firstDay = startObj.toISOString().split('T')[0];
            // ============================================================
            
            let html = `<div class="search-panel no-print"><div class="flex flex-wrap gap-6 items-end">`;
            
            // 기간 조회 필드 (수금 관리도 여기서 firstDay 변수를 사용하게 됨)
            if (!['partners', 'products', 'inventory'].includes(tab)) {
                html += `<div><span class="search-label">기간 조회</span><div class="flex items-center gap-2"><input type="date" id="searchStartDate" class="input-box" value="${firstDay}"><span class="text-slate-400">~</span><input type="date" id="searchEndDate" class="input-box" value="${currentDay}"></div></div>`;
            }
            
            if (tab === 'purchase_orders') html += `<div><span class="search-label">납품업체</span><input type="text" id="search_sPartner" class="input-box" placeholder="업체명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">EndUser</span><input type="text" id="search_sEndUser" class="input-box" placeholder="EndUser" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">품목명</span><input type="text" id="search_sItem" class="input-box" placeholder="품목명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            else if (tab === 'purchases') html += `<div><span class="search-label">매입처</span><input type="text" id="search_sPartner" class="input-box" placeholder="매입처" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">품목명</span><input type="text" id="search_sItem" class="input-box" placeholder="품목명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            else if (tab === 'partners') html += `<div><span class="search-label">상호명</span><input type="text" id="search_sName" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">담당자</span><input type="text" id="search_sManager" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            else if (tab === 'products' || tab === 'inventory') {
                html += `<div><span class="search-label">품목명</span><input type="text" id="search_sName" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">코드</span><input type="text" id="search_sCode" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            }
            else if (tab === 'collections') {
                html += `<div><span class="search-label">거래처</span><input type="text" id="search_sPartner" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            }
            else html += `<div><span class="search-label">거래처</span><input type="text" id="search_sPartner" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">담당자</span><input type="text" id="search_sManager" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">비고</span><input type="text" id="search_sNote" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
        
            let extraControls = '';
            if (tab === 'inventory') {
                extraControls = `<label class="flex items-center gap-2 cursor-pointer mr-4"><input type="checkbox" id="hideZeroStock" class="w-4 h-4" checked><span class="text-sm font-semibold text-slate-700">재고0개품목제외</span></label>`;
            } 
            else if (tab === 'collections') {
                extraControls = `<label class="flex items-center gap-2 cursor-pointer mr-4"><input type="checkbox" id="hideZeroReceivable" class="w-4 h-4" checked><span class="text-sm font-semibold text-slate-700">채권금액 0원은 제외</span></label>`;
            }
            else if (tab === 'bookkeeping') {
        html += `<div><span class="search-label">계정과목</span><select id="search_sCategory" class="input-box h-[38px]" onchange="runSearch('${tab}')"><option value="">전체</option><option>식대</option><option>여비교통비</option><option>소모품비</option><option>도서인쇄비</option><option>접대비</option><option>통신비</option><option>임차료</option><option>기타</option></select></div>
                 <div><span class="search-label">사용처/적요</span><input type="text" id="search_sUsage" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
    }
            html += `<div class="ml-auto flex items-center">${extraControls}<button onclick="runSearch('${tab}')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded font-bold shadow transition flex items-center gap-2 text-sm"><i class="fa-solid fa-magnifying-glass"></i> 조회</button></div></div></div>`;
            
            panel.innerHTML = html;
        }

        function handleSearchKeyPress(event, tab) { if (event.key === 'Enter') runSearch(tab); }

        // [수정됨] 수금 관리 로직 추가 (sales 테이블 조회 + 필터링)
        async function runSearch(tab) {
            const tbody = document.getElementById('listBody'); tbody.innerHTML = '<tr><td colspan="10" class="text-center p-8">데이터를 불러오는 중입니다...</td></tr>';
            
            if(tab === 'inventory') { await loadInventoryData(true); return; }
            
            // 수금 관리는 실제로는 'sales' 테이블을 조회합니다.
            const targetTable = (tab === 'collections') ? 'sales' : tab;
            
            let query = supabase.from(targetTable).select('*').order('created_at', { ascending: false });
            
            const sDate = document.getElementById('searchStartDate')?.value;
            const eDate = document.getElementById('searchEndDate')?.value;
            if(sDate && eDate && !['partners','products'].includes(tab)) query = query.gte('date', sDate).lte('date', eDate);

            if(tab === 'purchase_orders') { const p = document.getElementById('search_sPartner').value; const e = document.getElementById('search_sEndUser').value; if(p) query = query.ilike('partner_name', `%${p}%`); if(e) query = query.ilike('end_user', `%${e}%`); }
            else if (tab === 'purchases') { const p = document.getElementById('search_sPartner').value; const i = document.getElementById('search_sItem').value; if(p) query = query.ilike('partner_name', `%${p}%`); if(i) query = query.ilike('item_name', `%${i}%`); }
            else if (tab === 'partners') { const n = document.getElementById('search_sName').value; const m = document.getElementById('search_sManager').value; if(n) query = query.ilike('name', `%${n}%`); if(m) query = query.ilike('manager_name', `%${m}%`); }
            else if (tab === 'products') { const n = document.getElementById('search_sName').value; const c = document.getElementById('search_sCode').value; if(n) query = query.ilike('name', `%${n}%`); if(c) query = query.ilike('code', `%${c}%`); }
            else { 
                const p = document.getElementById('search_sPartner')?.value; 
                const m = document.getElementById('search_sManager')?.value; 
                const n = document.getElementById('search_sNote')?.value; 
                if(p) query = query.ilike('partner_name', `%${p}%`); 
                if(m && tab !== 'collections') query = query.ilike('manager', `%${m}%`); 
                if(n && tab !== 'collections') query = query.ilike('note', `%${n}%`); 
            }

            const { data, error } = await query;
            if(error) { alert("검색실패: "+error.message); return; }
            
            let resultData = data;

            // [추가] 수금 관리: 체크박스 확인하여 미수금 0원 제외
            if (tab === 'collections') {
                const hideZero = document.getElementById('hideZeroReceivable')?.checked;
                if (hideZero) {
                    resultData = data.filter(row => {
                        const total = row.total_amount || 0;
                        const collected = row.collected_amount || 0;
                        const balance = total - collected;
                        return balance !== 0; // 잔액이 0이 아닌 것만 남김
                    });
                }
            }
            // 발주/구매 품목 검색 필터
            else if(tab === 'purchase_orders' || tab === 'purchases') { const sItem = document.getElementById('search_sItem') ? document.getElementById('search_sItem').value.toLowerCase() : ''; if(sItem) { if(tab === 'purchases') resultData = data.filter(r => r.item_name && r.item_name.toLowerCase().includes(sItem)); else resultData = data.filter(r => r.items && r.items.some(i => i.name.toLowerCase().includes(sItem))); } }
            else if (tab === 'bookkeeping') {
                const cat = document.getElementById('search_sCategory').value;
                const usage = document.getElementById('search_sUsage').value;
                if(cat) query = query.eq('category', cat);
                if(usage) query = query.ilike('usage_desc', `%${usage}%`);
            }
            renderTable(tab, resultData);
        }

        // [수정됨] 수금 관리(collections) 탭 처리 추가
        async function switchTab(tab) {
            currentTab = tab; 
            
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white', 'font-bold');
                if (btn.getAttribute('onclick').includes(`'${tab}'`)) {
                    btn.classList.add('bg-slate-800', 'text-white', 'font-bold');
                }
            });
        
            const container = document.getElementById('contentArea');
            
            if (tab === 'dashboard') {
                renderSearchPanel(tab);
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-[80vh] animate-fade-in"><div class="bg-white p-10 rounded-2xl shadow-xl text-center border-l-8 border-blue-500 max-w-2xl"><h1 class="text-4xl font-extrabold text-slate-800 mb-6">ASPEC ERP System</h1><p class="text-2xl font-medium text-slate-600 italic leading-relaxed">"${randomQuote}"</p></div><p class="mt-8 text-slate-400 text-sm">오늘도 좋은 하루 되세요!</p></div>`;
                return;
            }
            
            if (tab === 'calendar') {
                renderSearchPanel(tab);
                await renderCalendar();
                return;
            }
        
            await fetchData(); 
            renderSearchPanel(tab);
        
            // [추가] 타이틀 맵에 수금 관리 추가
            const titles = {'partners':'거래처 관리','products':'품목 관리','purchase_orders':'발주 관리 (PO)','purchases':'구매 관리 (입고)','inventory':'재고 관리 현황','quotes':'견적 관리','orders':'주문 관리 (수주)','sales':'판매 관리 (출고)','collections':'수금 관리', 'bookkeeping':'기장 관리 (지출/비용)'};
            
            let buttonsHtml = '';
            const commonBtnClass = "bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2.5 rounded font-bold shadow-md text-sm flex items-center gap-2";
            
            // 수금 관리는 '신규 등록' 버튼이 필요 없음 (판매 내역을 불러오므로)
            if (tab === 'products') {
                buttonsHtml = `<div class="flex gap-2"><button onclick="openBOMModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2.5 rounded font-bold shadow-md text-sm flex items-center gap-2"><i class="fa-solid fa-layer-group"></i> 세트(BOM) 관리</button><button onclick="openNewModal('${tab}')" class="${commonBtnClass}"><i class="fa-solid fa-plus"></i> 신규 등록</button></div>`;
            } else if (tab === 'inventory') {
                buttonsHtml = `<button onclick="openNewModal('purchases')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded font-bold shadow-md text-sm flex items-center gap-2"><i class="fa-solid fa-plus"></i> 제품 입고</button>`;
            } else if (tab !== 'collections') {
                buttonsHtml = `<button onclick="openNewModal('${tab}')" class="${commonBtnClass}"><i class="fa-solid fa-plus"></i> 신규 등록</button>`;
            }
        
            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-slate-800 border-l-8 border-cyan-500 pl-4">${titles[tab]}</h2>
                    ${buttonsHtml}
                </div>
                <div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden">
                    <table class="data-table">`;
        
            if (tab === 'partners') html += `<thead><tr><th style="width:20%">상호</th><th style="width:15%">담당자</th><th style="width:20%">전화번호</th><th>비고</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'products') html += `<thead><tr><th style="width:15%">품목코드</th><th style="width:25%">품목명</th><th>규격</th><th style="width:8%">단위</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'purchase_orders') html += `<thead><tr><th style="width:12%">PO#</th><th style="width:15%">납품업체</th><th style="width:15%">EndUser</th><th>품목요약</th><th style="width:12%">총액</th><th style="width:10%">일자</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'purchases') html += `<thead><tr><th style="width:10%">일자</th><th style="width:10%">제조사</th><th style="width:15%">매입처</th><th>품목명</th><th style="width:6%">수량</th><th style="width:10%">단가</th><th style="width:10%">합계</th><th style="width:10%">시리얼</th><th style="width:10%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'inventory') html += `<thead><tr><th>품목명</th><th style="width:10%">제조사</th><th style="width:12%">입고처</th><th style="width:10%">입고단가</th><th style="width:8%">총재고</th><th style="width:8%">가용재고</th><th>비고</th><th style="width:10%">예약</th><th style="width:10%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            
            // [추가] 수금 관리 테이블 헤더
            else if (tab === 'collections') html += `<thead><tr><th style="width:10%">판매일자</th><th style="width:15%">거래처</th><th style="width:15%">매출총액(VAT포함)</th><th style="width:15%">기수금액</th><th style="width:15%">미수금(잔액)</th><th>비고</th><th style="width:10%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'bookkeeping') html += `<thead><tr><th style="width:10%">일자</th><th style="width:12%">계정과목</th><th style="width:20%">사용처(적요)</th><th style="width:10%">결제수단</th><th style="width:12%">금액</th><th>비고</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else html += `<thead><tr><th style="width:10%">일자</th><th style="width:18%">거래처</th><th style="width:12%">담당자</th><th style="width:12%">공급가액</th><th style="width:10%">부가세</th><th style="width:12%">합계</th><th>비고</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            
            html += `</table></div>`;
            container.innerHTML = html;
            runSearch(tab);
        }

        // [수정됨] 수금 관리 테이블 렌더링 로직 추가
        function renderTable(tab, data) {
            const tbody = document.getElementById('listBody'); tbody.innerHTML = '';
            if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="text-center p-8 text-slate-500">데이터가 없습니다.</td></tr>'; return; }

            data.forEach(row => {
                let tr = `<tr class="hover:bg-slate-50 border-b transition">`;
                const dataId = storeRowData(row);
                let actions = '<div class="flex justify-center items-center gap-3">';
                
                // 수금 관리 외 일반 버튼들
                if (tab !== 'collections') {
                    if(['quotes', 'orders', 'sales', 'purchase_orders'].includes(tab)) actions += `<button onclick="printDocument('${tab}', '${dataId}')" class="text-slate-600 hover:text-black p-2 rounded hover:bg-slate-200 transition" title="인쇄"><i class="fa-solid fa-print fa-lg"></i></button>`;
                    if(tab !== 'inventory') actions += `<button onclick="openEditModal('${tab}', '${dataId}')" class="text-blue-500 hover:text-blue-700 p-2 rounded hover:bg-blue-50 transition" title="수정"><i class="fa-solid fa-pen-to-square fa-lg"></i></button>`;
                    actions += `<button onclick="deleteItem('${tab}', ${row.id})" class="text-red-400 hover:text-red-600 p-2 rounded hover:bg-red-50 transition" title="삭제"><i class="fa-solid fa-trash-can fa-lg"></i></button></div>`;
                }

                if (tab === 'partners') {
                    const fileIcon = row.biz_file_url ? `<a href="${row.biz_file_url}" target="_blank" class="text-green-600 hover:text-green-800 ml-2"><i class="fa-solid fa-file-pdf"></i></a>` : '';
                    tr += `<td>${row.name} ${fileIcon}</td><td class="text-center">${row.manager_name||'-'}</td><td class="text-center">${row.phone||'-'}</td><td>${row.note||''}</td><td>${actions}</td>`;
                }
                else if (tab === 'products') tr += `<td class="font-mono text-center text-cyan-600">${row.code}</td><td>${row.name}</td><td>${row.spec||'-'}</td><td class="text-center font-bold text-slate-600">${row.unit||'EA'}</td><td>${actions}</td>`;
                else if (tab === 'purchase_orders') {
                    const itemsSummary = row.items && row.items.length > 0 ? `${row.items[0].name} 외 ${row.items.length-1}건` : '-';
                    tr += `<td class="font-bold text-blue-600 text-center">${row.po_number}</td><td>${row.partner_name}</td><td class="text-center">${row.end_user||'-'}</td><td>${itemsSummary}</td><td class="font-bold text-right">${(row.total_amount||0).toLocaleString()}</td><td class="text-center">${row.date}</td><td>${actions}</td>`;
                } 
                else if (tab === 'purchases') {
                    tr += `<td class="text-center">${row.date}</td><td class="text-center">${row.manufacturer||'-'}</td><td>${row.partner_name}</td><td>${row.item_name}</td><td class="text-center font-bold">${row.qty}</td><td class="text-right">${(row.unit_price||0).toLocaleString()}</td><td class="text-right font-bold">${(row.total_amount||0).toLocaleString()}</td><td class="text-center">${row.serial_no||'-'}</td><td>${actions}</td>`;
                } 
                // [추가] 수금 관리 로직
                else if (tab === 'collections') {
                    const total = row.total_amount || 0;
                    const collected = row.collected_amount || 0;
                    const balance = total - collected;
                    
                    const balanceClass = balance > 0 ? 'text-red-600 font-bold' : 'text-slate-400';
                    
                    tr += `
                        <td class="text-center">${row.date}</td>
                        <td class="font-bold text-slate-700">${row.partner_name}</td>
                        <td class="text-right font-bold">${total.toLocaleString()}</td>
                        <td class="text-center">
                            <input type="number" id="col_${row.id}" value="${collected}" class="border rounded px-2 py-1 w-24 text-right font-bold text-blue-600 bg-blue-50 focus:bg-white transition" placeholder="0">
                        </td>
                        <td class="text-right ${balanceClass}">${balance.toLocaleString()}</td>
                        <td><input type="text" id="cnote_${row.id}" value="${row.collection_note || ''}" class="border rounded px-2 py-1 w-full text-xs" placeholder="메모"></td>
                        <td class="text-center">
                            <button onclick="updateCollection(${row.id})" class="bg-slate-700 hover:bg-slate-900 text-white px-3 py-1 rounded text-xs font-bold transition">저장</button>
                        </td>
                    `;
                }

                else if (tab === 'bookkeeping') {
                        tr += `<td class="text-center">${row.date}</td>
                               <td class="text-center font-bold text-slate-600">${row.category}</td>
                               <td>${row.usage_desc}</td>
                               <td class="text-center"><span class="px-2 py-1 rounded text-xs ${row.payment_method==='법인카드'?'bg-blue-100 text-blue-700':'bg-slate-100'}">${row.payment_method||'-'}</span></td>
                               <td class="text-right font-bold">${(row.amount||0).toLocaleString()}원</td>
                               <td>${row.note||''}</td>
                               <td>${actions}</td>`;
                    }
                else if (tab === 'inventory') { } 
                else {
                    tr += `<td class="text-center">${row.date}</td><td class="font-bold">${row.partner_name||'-'}</td><td class="text-center">${row.manager||'-'}</td><td class="text-right text-slate-600">${(row.total_supply||0).toLocaleString()}</td><td class="text-right text-slate-400 text-xs">${(row.total_vat||0).toLocaleString()}</td><td class="text-right font-bold text-cyan-700">${(row.total_amount||0).toLocaleString()}</td><td>${row.note||''}</td><td>${actions}</td>`;
                }
                
                if(tab !== 'inventory') tbody.innerHTML += tr;
            });
        }

        // [신규] 수금 내역 업데이트 함수
        async function updateCollection(id) {
            const collectedAmount = parseInt(document.getElementById(`col_${id}`).value) || 0;
            const note = document.getElementById(`cnote_${id}`).value;
            
            if (!confirm('수금 정보를 저장하시겠습니까?')) return;
            
            // Sales 테이블에 collected_amount와 collection_note 업데이트
            const { error } = await supabase
                .from('sales')
                .update({ 
                    collected_amount: collectedAmount,
                    collection_note: note 
                })
                .eq('id', id);
                
            if (error) {
                alert("저장 중 오류가 발생했습니다: " + error.message);
            } else {
                alert("저장되었습니다.");
                runSearch('collections'); // 화면 새로고침
            }
        }

        function openEditModal(tab, dataId) {
            const row = getRowData(dataId);
            if (!row) return alert('데이터 오류');
            currentEditId = row.id;
            
            // 모달 폼 열기
            openNewModal(tab, true);
            
            // 폼이 렌더링된 후 데이터를 채워넣기 위해 setTimeout 사용
            setTimeout(() => {
                if(tab === 'partners') { 
                    document.getElementById('pName').value = row.name; 
                    document.getElementById('pBiz').value = row.biz_num||''; 
                    document.getElementById('pOwner').value = row.owner_name||''; 
                    document.getElementById('pManager').value = row.manager_name||''; 
                    document.getElementById('pPhone').value = row.phone||''; 
                    document.getElementById('pEmail').value = row.email||''; 
                    document.getElementById('pAddr').value = row.address||'';
                    document.getElementById('pNote').value = row.note||''; 
                    const linkDiv = document.getElementById('pCurrentFileLink');
                    if(row.biz_file_url) linkDiv.innerHTML = `<a href="${row.biz_file_url}" target="_blank" class="text-blue-600 hover:underline font-bold ml-2">[기존 파일 보기]</a>`;
                    else linkDiv.innerHTML = `<span class="text-slate-400 ml-2">(파일 없음)</span>`;
                }
                else if(tab === 'products') { 
                    document.getElementById('prodName').value = row.name; 
                    document.getElementById('prodCode').value = row.code; 
                    document.getElementById('prodUnit').value = row.unit||''; 
                    document.getElementById('prodSpec').value = row.spec||''; 
                    document.getElementById('prodMaker').value = row.manufacturer||''; 
                }

                else if(tab === 'bookkeeping') {
                    document.getElementById('bkDate').value = row.date;
                    document.getElementById('bkCategory').value = row.category;
                    document.getElementById('bkUsage').value = row.usage_desc;
                    document.getElementById('bkMethod').value = row.payment_method;
                    document.getElementById('bkAmount').value = row.amount;
                    document.getElementById('bkNote').value = row.note || '';
                }
                else if(tab === 'purchases') { 
                    document.getElementById('purDate').value = row.date; 
                    document.getElementById('purPartner').value = row.partner_name; 
                    document.getElementById('purItem').value = row.item_name; 
                    document.getElementById('purQty').value = row.qty; 
                    document.getElementById('purPrice').value = row.unit_price; 
                    document.getElementById('purSerial').value = row.serial_no||''; 
                    document.getElementById('purNote').value = row.note||''; 
                }
                else if(tab === 'purchase_orders') { 
                    document.getElementById('poNum').value = row.po_number; 
                    document.getElementById('poDate').value = row.date; 
                    document.getElementById('poPartner').value = row.partner_name; 
                    document.getElementById('poEndUser').value = row.end_user||''; 
                    document.getElementById('poManager').value = row.manager||''; 
                    document.getElementById('poPreOrder').value = row.is_pre_order||''; 
                    document.getElementById('poNote').value = row.note||'';
                    document.getElementById('poPManager').value = row.partner_manager || ''; 
                    document.getElementById('poPhone').value = row.phone || ''; 
                    document.getElementById('poEmail').value = row.email || ''; 
                    document.getElementById('poAddr').value = row.partner_address || '';
                    
                    tempItems = (row.items || []).map(item => {
                        if (!item.spec) {
                            const prod = productList.find(p => p.name === item.name);
                            if (prod) item.spec = prod.spec;
                        }
                        return item;
                    });
                    renderGrid(); 
                }
                // [추가됨] 견적(quotes), 주문(orders), 판매(sales) 수정 로직
                else {
                    document.getElementById('sDate').value = row.date;
                    document.getElementById('sPartner').value = row.partner_name;
                    document.getElementById('sManager').value = row.manager || '';
                    
                    // 거래처 상세 정보
                    if(document.getElementById('sPManager')) document.getElementById('sPManager').value = row.partner_manager || '';
                    if(document.getElementById('sContact')) document.getElementById('sContact').value = row.phone || '';
                    if(document.getElementById('sAddr')) document.getElementById('sAddr').value = row.partner_address || '';
                    if(document.getElementById('sEmail')) document.getElementById('sEmail').value = row.email || '';
                    if(document.getElementById('sNote')) document.getElementById('sNote').value = row.note || '';

                    // 품목 리스트 복원
                    tempItems = (row.items || []).map(item => {
                        // 규격이 비어있으면 품목 마스터에서 찾아 채움
                        if (!item.spec) {
                            const prod = productList.find(p => p.name === item.name);
                            if (prod) item.spec = prod.spec;
                        }
                        return item;
                    });
                    renderGrid();
                }
            }, 50);
        }

        async function openNewModal(tab, isEdit = false) {
    if(!isEdit) { currentEditId = null; tempItems = []; }
    const modal = document.getElementById('genericModal');
    document.getElementById('modalTitle').innerText = getTitle(tab) + (isEdit ? ' 수정' : ' 등록');
    const body = document.getElementById('modalBody');
    modal.classList.add('active');
    let html = ''; const today = new Date().toISOString().split('T')[0];
    
    if (tab === 'purchase_orders') {
        let autoPO = '';
        if (!isEdit) {
            const { count } = await supabase.from('purchase_orders').select('*', { count: 'exact', head: true }).eq('date', today);
            const nextSeq = (count || 0) + 1;
            const seqStr = String(nextSeq).padStart(2, '0');
            const yymmdd = today.slice(2).replace(/-/g,'');
            autoPO = `ASPEC-${yymmdd}-P${seqStr}`;
        }
        html = `<div class="bg-slate-50 p-4 rounded mb-4 border"><div class="grid grid-cols-3 gap-3 mb-2"><div><label class="text-xs text-slate-500">PO# (자동생성)</label><input id="poNum" class="input-box bg-gray-100" value="${autoPO}"></div><div><label class="text-xs text-slate-500">수주일자</label><input type="date" id="poDate" class="input-box" value="${today}"></div><div><label class="text-xs text-slate-500">발주업체 </label><input id="poPartner" class="input-box" list="dl_part" onchange="fillPOPart(this.value)"></div></div><div class="grid grid-cols-3 gap-3 mb-2"><div><label class="text-xs text-slate-500">거래처 담당자</label><input id="poPManager" class="input-box"></div><div><label class="text-xs text-slate-500">연락처</label><input id="poPhone" class="input-box"></div><div><label class="text-xs text-slate-500">선발주여부</label><select id="poPreOrder" class="input-box"><option>N</option><option>Y</option></select></div></div><div class="mb-2"><label class="text-xs text-slate-500">주소</label><input id="poAddr" class="input-box"></div><div class="grid grid-cols-2 gap-3 mb-2"><div><label class="text-xs text-slate-500">이메일</label><input id="poEmail" class="input-box"></div><div><label class="text-xs text-slate-500">비고</label><input id="poNote" class="input-box"></div></div><div class="grid grid-cols-2 gap-3 mb-2"><div><label class="text-xs text-slate-500">EndUser</label><input id="poEndUser" class="input-box"></div><div><label class="text-xs text-slate-500">담당자(우리측)</label><input id="poManager" class="input-box"></div></div></div>${renderItemInputArea(tab)}`;
    }
    else if (tab === 'partners') html = `<div class="grid grid-cols-2 gap-3"><div><label class="text-xs">상호 (필수)</label><input id="pName" class="input-box"></div><div><label class="text-xs">사업자번호</label><input id="pBiz" class="input-box"></div><div><label class="text-xs">대표자</label><input id="pOwner" class="input-box"></div><div><label class="text-xs">담당자</label><input id="pManager" class="input-box"></div><div><label class="text-xs">전화번호</label><input id="pPhone" class="input-box"></div><div><label class="text-xs">이메일</label><input id="pEmail" class="input-box"></div><div class="col-span-2"><label class="text-xs">주소</label><input id="pAddr" class="input-box" placeholder="주소를 입력하세요"></div><div class="col-span-2 border p-2 rounded bg-slate-50"><label class="text-xs font-bold">사업자등록증 (PDF/이미지)</label><div class="flex gap-2 mt-1"><input type="file" id="pFile" class="text-xs w-full" accept=".pdf,.jpg,.png,.jpeg"><div id="pCurrentFileLink" class="text-xs flex items-center"></div></div></div><div class="col-span-2"><label class="text-xs">비고</label><input id="pNote" class="input-box"></div></div><button onclick="saveSimpleData('partners')" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold">저장</button>`;
    else if (tab === 'products') html = `<div class="grid grid-cols-2 gap-3"><div class="col-span-2"><label class="text-xs">품목명 (필수)</label><input id="prodName" class="input-box" oninput="autoGenCode(this.value)"></div><div><label class="text-xs">품목코드 (자동)</label><input id="prodCode" class="input-box bg-slate-100" readonly></div><div><label class="text-xs">단위</label><input id="prodUnit" class="input-box" placeholder="EA"></div><div class="col-span-2"><label class="text-xs">규격</label><input id="prodSpec" class="input-box"></div><div class="col-span-2"><label class="text-xs">제조사</label><input id="prodMaker" class="input-box"></div></div><button onclick="saveSimpleData('products')" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold">저장</button>`;
    
    // [수정됨] 구매(입고) 관리: 여러 품목 등록이 가능한 UI로 변경
    else if (tab === 'purchases') {
        html = `
        <div class="bg-slate-50 p-4 rounded mb-4 border">
            <div class="grid grid-cols-2 gap-3 mb-2">
                <div><label class="text-xs text-slate-500">입고일자</label><input type="date" id="purDate" class="input-box" value="${today}"></div>
                <div><label class="text-xs text-slate-500">매입처 (공통)</label><input id="purPartner" class="input-box" list="dl_part"></div>
            </div>
            <div><label class="text-xs text-slate-500">비고 (공통)</label><input id="purNote" class="input-box"></div>
        </div>

        <div class="bg-white border p-3 rounded mb-4 shadow-sm">
            <div class="flex flex-wrap gap-2 items-end">
                <div class="w-1/4"><label class="text-xs">품목명</label><input id="purItem" class="input-box" list="dl_prod"></div>
                <div class="w-1/6"><label class="text-xs">제조사</label><input id="purMaker" class="input-box"></div>
                <div class="w-1/6"><label class="text-xs">시리얼</label><input id="purSerial" class="input-box"></div>
                <div class="w-16"><label class="text-xs">수량</label><input type="number" id="purQty" class="input-box" value="1"></div>
                <div class="w-24"><label class="text-xs">단가</label><input type="number" id="purPrice" class="input-box"></div>
                <button onclick="addPurchaseItem()" class="bg-slate-700 text-white px-4 py-2 rounded font-bold text-sm h-9">추가</button>
            </div>
        </div>

        <table class="w-full text-sm border-collapse border text-center mb-4">
            <thead class="bg-slate-100">
                <tr>
                    <th>품목명</th> <th>제조사</th> <th>시리얼</th> <th>수량</th> <th>단가</th> <th>합계</th> <th>삭제</th>
                </tr>
            </thead>
            <tbody id="purItemGrid"></tbody>
        </table>
        
        <div class="text-right text-lg font-bold text-cyan-700">총 합계: <span id="purGrandTotal">0</span>원</div>
        <button onclick="savePurchase()" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold shadow-lg">입고 처리 (저장)</button>
        <datalist id="dl_part"></datalist><datalist id="dl_prod"></datalist>`;
    }
else if (tab === 'bookkeeping') {
    html = `
    <div class="bg-yellow-50 p-4 rounded mb-4 border border-yellow-200">
        <h3 class="text-sm font-bold text-yellow-800 mb-2"><i class="fa-solid fa-lightbulb"></i> 비용 처리 가이드</h3>
        <p class="text-xs text-slate-600 mb-1">· <strong>식대</strong>: 직원 식사 및 회식 비용</p>
        <p class="text-xs text-slate-600 mb-1">· <strong>여비교통비</strong>: 출장비, 주유비, 주차비, 톨게이트비 등 차량 관련 비용</p>
        <p class="text-xs text-slate-600">· <strong>소모품비</strong>: 사무용품, 청소용품 등 100만원 이하 물품</p>
    </div>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="text-xs font-bold text-slate-700">지출 일자</label>
            <input type="date" id="bkDate" class="input-box" value="${today}">
        </div>
        <div>
            <label class="text-xs font-bold text-slate-700">계정 과목 (비용 분류)</label>
            <select id="bkCategory" class="input-box">
                <option value="식대">식대 (복리후생)</option>
                <option value="여비교통비">여비교통비 (차량/출장)</option>
                <option value="소모품비">소모품비 (사무용품 등)</option>
                <option value="도서인쇄비">도서인쇄비</option>
                <option value="접대비">접대비 (거래처)</option>
                <option value="통신비">통신비 (인터넷/전화)</option>
                <option value="임차료">임차료 (월세)</option>
                <option value="지급수수료">지급수수료</option>
                <option value="기타">기타</option>
            </select>
        </div>
        <div class="col-span-2">
            <label class="text-xs font-bold text-slate-700">사용처 / 적요 (필수)</label>
            <input id="bkUsage" class="input-box" placeholder="예: OO식당 점심식사, OO주유소 주유">
        </div>
        <div>
            <label class="text-xs font-bold text-slate-700">결제 수단</label>
            <select id="bkMethod" class="input-box">
                <option value="법인카드">법인카드</option>
                <option value="개인카드">개인카드</option>
                <option value="현금영수증">현금영수증</option>
                <option value="계좌이체">계좌이체</option>
                <option value="기타">기타</option>
            </select>
        </div>
        <div>
            <label class="text-xs font-bold text-slate-700">공급대가 (VAT포함 총액)</label>
            <input type="number" id="bkAmount" class="input-box" placeholder="숫자만 입력">
        </div>
        <div class="col-span-2">
            <label class="text-xs font-bold text-slate-700">비고</label>
            <input id="bkNote" class="input-box" placeholder="메모 사항">
        </div>
    </div>
    <button onclick="saveSimpleData('bookkeeping')" class="w-full mt-6 bg-slate-800 text-white py-3 rounded font-bold hover:bg-slate-900 transition">저장하기</button>
    `;
}
    else { renderComplexForm(tab, body); return; }
    body.innerHTML = html;
    if(tab === 'purchases' || tab === 'purchase_orders') { fillDL('dl_part', partnerList); fillDL('dl_prod', productList); }
}

        async function saveData(tab, data) {
            let res;
            if (currentEditId) res = await supabase.from(tab).update(data).eq('id', currentEditId);
            else res = await supabase.from(tab).insert(data);
            if(res.error) { alert("오류: " + res.error.message); return false; }
            return true;
        }

        async function saveSimpleData(tab) {
            let data = {};
            if(tab === 'partners') {
                data = { name: el('pName'), biz_num: el('pBiz'), owner_name: el('pOwner'), manager_name: el('pManager'), phone: el('pPhone'), email: el('pEmail'), address: el('pAddr'), note: el('pNote') };
                const fileInput = document.getElementById('pFile');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0]; const fileName = `biz_${Date.now()}.${file.name.split('.').pop()}`; 
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('erp').upload(fileName, file);
                    if (uploadError) { alert("파일 업로드 실패: " + uploadError.message); return; }
                    const { data: publicUrlData } = supabase.storage.from('erp').getPublicUrl(fileName);
                    data.biz_file_url = publicUrlData.publicUrl; 
                }
            }
            else if(tab === 'products') {
                data = { name: el('prodName'), code: el('prodCode'), spec: el('prodSpec'), unit: el('prodUnit'), manufacturer: el('prodMaker') };
            }

            else if(tab === 'bookkeeping') {
                const usage = el('bkUsage');
                const amount = el('bkAmount');
                if(!usage || !amount) { alert("사용처와 금액은 필수입니다."); return; }
                
                data = {
                    date: el('bkDate'),
                    category: el('bkCategory'),
                    usage_desc: usage,
                    payment_method: el('bkMethod'),
                    amount: parseInt(amount) || 0,
                    note: el('bkNote')
                };
            }
            if(await saveData(tab, data)) { closeModal(); runSearch(tab); }
        }

        // [수정] 여러 품목을 한 번에 저장하도록 변경
        async function savePurchase() {
            if (tempItems.length === 0) return alert("입고할 품목을 추가해주세요.");
        
            const dateVal = document.getElementById('purDate').value;
            const partnerVal = document.getElementById('purPartner').value;
            const noteVal = document.getElementById('purNote').value;
        
            if (!dateVal || !partnerVal) return alert("날짜와 매입처를 입력해주세요.");
        
            let successCount = 0;
        
            // 추가된 모든 품목을 하나씩 DB에 저장
            for (const item of tempItems) {
                const data = {
                    date: dateVal,
                    partner_name: partnerVal,
                    item_name: item.name,
                    manufacturer: item.manufacturer, // 제조사 저장
                    qty: item.qty,
                    unit_price: item.unit_price,
                    supply_price: item.unit_price * item.qty,
                    vat: Math.floor(item.unit_price * item.qty * 0.1),
                    total_amount: item.total_amount,
                    serial_no: item.serial_no,
                    note: noteVal
                };
        
                const { error } = await supabase.from('purchases').insert(data);
                
                if (!error) {
                    successCount++;
                    // 품목 재고 및 정보 업데이트
                    const prod = productList.find(p => p.name === item.name);
                    if (prod) {
                        // [핵심 수정] DB에 업데이트하기 전에, 현재 메모리에 있는 재고도 즉시 늘려준다.
                        // 그래야 다음 루프에서 늘어난 재고를 기준으로 더하기를 할 수 있음.
                        prod.stock = prod.stock + item.qty; 
        
                        await supabase.from('products').update({
                            stock: prod.stock, // 늘어난 재고로 저장
                            last_vendor: partnerVal,
                            last_price: item.unit_price,
                            last_serial_no: item.serial_no,
                            manufacturer: item.manufacturer || prod.manufacturer 
                        }).eq('id', prod.id);
                    }
                }
            }
        
            if (successCount > 0) {
                alert(`${successCount}건의 품목이 입고 처리되었습니다.`);
                closeModal();
                runSearch('purchases');
            } else {
                alert("저장에 실패했습니다.");
            }
        }

            // [수정] 판매 저장 시 '세트(BOM)' 여부를 확인하여 구성품 재고를 차감하는 로직 추가
        async function saveComplexData(tab) {
            if(tempItems.length === 0) return alert("품목 없음");
            let tSupply=0, tVat=0, tTotal=0; tempItems.forEach(i => { tSupply+=i.supply; tVat+=i.vat; tTotal+=i.total; });
            let dateVal = el(tab === 'purchase_orders' ? 'poDate' : 'sDate') || new Date().toISOString().split('T')[0];
            let data = { items: tempItems, total_supply: tSupply, total_vat: tVat, total_amount: tTotal, date: dateVal, partner_name: el('sPartner'), manager: el('sManager'), note: el('sNote') };
            
            if(tab === 'purchase_orders') { 
                data.po_number = el('poNum'); data.partner_name = el('poPartner'); data.end_user = el('poEndUser'); data.manager = el('poManager'); data.is_pre_order = el('poPreOrder'); data.note = el('poNote'); 
                data.partner_manager = el('poPManager'); data.phone = el('poPhone'); data.email = el('poEmail'); data.partner_address = el('poAddr');
                
                if (!currentEditId) {
                    const { count } = await supabase.from(tab).select('*', { count: 'exact', head: true }).eq('date', dateVal);
                    const seq = (count || 0) + 1; 
                    const yymmdd = dateVal.slice(2).replace(/-/g, ''); 
                    data.po_number = `ASPEC-${yymmdd}-P${String(seq).padStart(2, '0')}`;
                }
            } else { 
                data.email = el('sEmail'); data.partner_manager = el('sPManager'); data.phone = el('sContact'); data.partner_address = el('sAddr'); 
                if(tab === 'orders') data.po_number = 'AUTO'; 
            }
        
            // 데이터 저장 (Sales, Orders, Quotes 공통)
            if(await saveData(tab, data)) { 
                
                // [핵심 수정 1] 판매(Sales)일 때만 재고 차감 로직 실행
                if(tab === 'sales' && !currentEditId) { 
                    
                    // 1. BOM(세트 구성) 정보를 가져옴
                    const { data: bomList } = await supabase.from('bom').select('*');
        
                    for(const item of tempItems) { 
                        // 이 품목이 세트(부모)인지 확인
                        const relatedParts = bomList ? bomList.filter(b => b.parent_name === item.name) : [];
        
                        if (relatedParts.length > 0) {
                            // [Case A] 세트 품목인 경우 -> 구성품(자식)들의 재고를 차감
                            for (const part of relatedParts) {
                                const childProd = productList.find(p => p.name === part.child_name);
                                if (childProd) {
                                    await supabase.from('products').update({ stock: childProd.stock - (item.qty * part.qty) }).eq('id', childProd.id);
                                }
                            }
                        } else {
                            // [Case B] 일반 품목인 경우 -> 해당 품목의 재고를 직접 차감
                            const prod = productList.find(p => p.name === item.name); 
                            if(prod) {
                                await supabase.from('products').update({ stock: prod.stock - item.qty }).eq('id', prod.id); 
                            }
                        }
                    } // 반복문 종료

                    // [신규 추가] 주문서를 불러와서 판매한 경우, 원본 주문서를 '완료' 처리하여 예약 해제
                    if (currentLoadedOrderId) {
                        await supabase.from('orders').update({ status: 'completed' }).eq('id', currentLoadedOrderId);
                        currentLoadedOrderId = null; // 초기화
                    }
                } // <--- [오류 원인 해결] 이 괄호가 빠져 있어서 전체 스크립트가 멈췄었습니다.
                
                alert("저장되었습니다."); closeModal(); runSearch(tab);
            }
        }

        async function deleteItem(table, id) { 
            if(!confirm("정말 삭제하시겠습니까?")) return; 
            
            // [수정] 판매(Sales) 삭제 시 재고 복구 로직
            if (table === 'sales') {
                const { data: saleData } = await supabase.from('sales').select('items').eq('id', id).single();
                if (saleData && saleData.items) {
                    for (const item of saleData.items) {
                        const prod = productList.find(p => p.name === item.name);
                        if (prod) {
                            await supabase.from('products').update({ stock: prod.stock + item.qty }).eq('id', prod.id);
                        }
                    }
                }
            }

            const { error } = await supabase.from(table).delete().eq('id', id); 
            if(error) alert("삭제 실패"); else runSearch(table); 
        }

        async function printDocument(tab, dataId) {
            const row = getRowData(dataId); if (!row) return alert('데이터 오류');
            const isPO = (tab === 'purchase_orders');
            
            // 견적서일 때만 주소 행 숨김
            const addrRow1 = document.getElementById('print_row_addr_1');
            const addrRow2 = document.getElementById('print_row_addr_2');
            if (tab === 'quotes') {
                if(addrRow1) addrRow1.style.display = 'none';
                if(addrRow2) addrRow2.style.display = 'none';
            } else {
                if(addrRow1) addrRow1.style.display = 'table-row';
                if(addrRow2) addrRow2.style.display = 'table-row';
            }

            let titleKo="거래명세서", titleEn="TRANSACTION STATEMENT", prefix="T"; 
            if (tab==='quotes') { titleKo="견적서"; titleEn="QUOTATION"; prefix="Q"; }
            else if (tab==='orders') { titleKo="주문서"; titleEn="ORDER SHEET"; prefix="D"; }
            else if (tab==='purchase_orders') { titleKo="발주서"; titleEn="PURCHASE ORDER"; prefix="P"; }

            document.getElementById('p_title_ko').innerText = titleKo; document.getElementById('p_title_en').innerText = titleEn;
            document.getElementById('p_date').innerText = row.date;
            
            // 문서 번호 생성 로직
            if (isPO && row.po_number && row.po_number.startsWith('ASPEC')) document.getElementById('p_no').innerText = row.po_number;
            else {
                const { count } = await supabase.from(tab).select('*', { count: 'exact', head: true }).eq('date', row.date).lte('id', row.id);
                const d = new Date(row.date); const yymmdd = d.getFullYear().toString().slice(2) + (d.getMonth()+1).toString().padStart(2,'0') + d.getDate().toString().padStart(2,'0');
                document.getElementById('p_no').innerText = `ASPEC-${yymmdd}-${prefix}${String(count).padStart(2,'0')}`;
            }

            // 공급받는자 / 공급자 정보 채우기
            if (isPO) {
                document.getElementById('p_left_role').innerText = "수 주 처";
                document.getElementById('p_left_name').innerText = row.partner_name;
                document.getElementById('p_left_manager').innerText = row.partner_manager||''; 
                document.getElementById('p_left_email').innerText = row.email||''; 
                document.getElementById('p_left_phone').innerText = row.phone||'';
                document.getElementById('p_left_addr').innerText = row.partner_address||'';
                document.getElementById('p_right_role').innerText = "발 주 처";
            } else {
                document.getElementById('p_left_role').innerText = "공 급 받 는 자";
                document.getElementById('p_left_name').innerText = row.partner_name;
                document.getElementById('p_left_manager').innerText = row.partner_manager||''; 
                document.getElementById('p_left_email').innerText = row.email||''; 
                document.getElementById('p_left_phone').innerText = row.phone||'';
                document.getElementById('p_left_addr').innerText = row.partner_address||''; 
                document.getElementById('p_right_role').innerText = "공 급 자";
            }
            document.getElementById('p_right_name').innerText = "아스펙 (ASPEC)";
            document.getElementById('p_right_manager').innerText = "이창현 프로";
            document.getElementById('p_right_email').innerText = currentUserEmail;
            document.getElementById('p_right_mp').innerText = "010-5919-1810"; 

            // 테이블 본문 생성
            const tableContainer = document.querySelector('.print-items-table');
            
            // [수정] tfoot 영역을 아예 새로 구성합니다. (공급가액, 부가세, 합계 분리)
            tableContainer.innerHTML = `
                <colgroup><col style="width: 5%;"><col style="width: 25%;"><col style="width: 30%;"><col style="width: 8%;"><col style="width: 8%;"><col style="width: 12%;"><col style="width: 12%;"></colgroup>
                <thead><tr><th>No</th><th>품명</th><th>규격</th><th>단위</th><th>수량</th><th>단가</th><th>공급가액</th></tr></thead>
                <tbody id="p_tbody"></tbody>
                <tfoot>
                    <tr style="background: #f8f8f8;">
                        <td colspan="4" style="text-align: center; border-right: 1px solid black; font-weight: bold;">합 계 (Total)</td>
                        <td style="text-align: center; border-right: 1px solid black; font-weight: bold;" id="p_total_qty"></td>
                        <td style="text-align: right; border-right: 1px solid black; font-size: 11px;">공급가액</td>
                        <td style="text-align: right; font-weight: bold;" id="p_sum_supply"></td>
                    </tr>
                    <tr>
                        <td colspan="5" style="border-right: 1px solid black; border-bottom: 1px solid black;"></td>
                        <td style="text-align: right; border-right: 1px solid black; background: #f8f8f8; font-size: 11px;">부가세 (VAT)</td>
                        <td style="text-align: right;" id="p_sum_vat"></td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td colspan="5" style="border-right: 1px solid black; border-bottom: 1px solid black;"></td>
                        <td style="text-align: right; border-right: 1px solid black; background: #e6e6e6;">총 합계</td>
                        <td style="text-align: right; background: #e6e6e6;" id="p_total_amt"></td>
                    </tr>
                    <tr style="background: #fff; border-top: 2px double black;">
                        <td colspan="7" style="padding: 10px; text-align: left;"><strong>[비고]</strong> <span id="p_note"></span></td>
                    </tr>
                </tfoot>
            `;

            const tbody = document.getElementById('p_tbody'); 
            tbody.innerHTML = ''; 
            let sumQty=0, sumAmt=0;

            if (row.items) {
                row.items.forEach((item, idx) => {
                    let spec = item.spec;
                    if (!spec) {
                        const prod = productList.find(p => p.name === item.name);
                        if (prod) spec = prod.spec;
                    }
                    sumQty += parseInt(item.qty)||0; 
                    sumAmt += parseInt(item.supply)||0; // 공급가액 합계
                    tbody.innerHTML += `<tr class="items-row"><td style="text-align:center">${idx+1}</td><td>${item.name}</td><td style="font-size:10px">${spec||'-'}</td><td style="text-align:center">${item.unit||'EA'}</td><td style="text-align:center">${item.qty}</td><td style="text-align:right">${(item.price||0).toLocaleString()}</td><td style="text-align:right">${(item.supply||0).toLocaleString()}</td></tr>`;
                });
            }
            
            // 빈 행 채우기
            for (let i=0; i<10-(row.items?.length||0); i++) tbody.innerHTML += `<tr class="items-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;

            // [수정] 금액 계산 및 할당
            const vatAmt = Math.floor(sumAmt * 0.1); // 부가세 10%
            const totalAmt = row.total_amount || (sumAmt + vatAmt);

            document.getElementById('p_total_qty').innerText = sumQty.toLocaleString();
            document.getElementById('p_sum_supply').innerText = sumAmt.toLocaleString(); // 공급가액 합계
            document.getElementById('p_sum_vat').innerText = vatAmt.toLocaleString();   // 부가세
            document.getElementById('p_total_amt').innerText = "₩ " + totalAmt.toLocaleString(); // 총 합계
            document.getElementById('p_note').innerText = row.note || '';

            document.getElementById('printContainer').classList.remove('hidden');
            setTimeout(() => { window.print(); document.getElementById('printContainer').classList.add('hidden'); }, 100);
        }
        
        function getTitle(tab) { const map = {'partners':'거래처','products':'품목','purchase_orders':'발주','purchases':'구매(입고)','quotes':'견적','orders':'주문','sales':'판매'}; return map[tab] || ''; }
        function closeModal() { document.getElementById('genericModal').classList.remove('active'); }
        function autoGenCode(val) { if(val && !currentEditId) document.getElementById('prodCode').value = 'P-' + Date.now().toString().slice(-6); }
        function el(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
        function fillDL(id, list) { document.getElementById(id).innerHTML = list.map(i=>`<option value="${i.name}">`).join(''); }
        function fillPart(val) { const f = partnerList.find(x=>x.name===val); if(f) { if(document.getElementById('sPManager')) document.getElementById('sPManager').value = f.manager_name||''; if(document.getElementById('sContact')) document.getElementById('sContact').value = f.phone||''; if(document.getElementById('sAddr')) document.getElementById('sAddr').value = f.address||''; if(document.getElementById('sEmail')) document.getElementById('sEmail').value = f.email||''; } }
        function fillPOPart(val) { const f = partnerList.find(x=>x.name===val); if(f) { if(document.getElementById('poPManager')) document.getElementById('poPManager').value = f.manager_name||''; if(document.getElementById('poPhone')) document.getElementById('poPhone').value = f.phone||''; if(document.getElementById('poEmail')) document.getElementById('poEmail').value = f.email||''; if(document.getElementById('poAddr')) document.getElementById('poAddr').value = f.address||''; } }
        function fillProd(val) { const f = productList.find(x=>x.name===val); if(f) { if(document.getElementById('iSpec')) document.getElementById('iSpec').value = f.spec || ''; } }
        
        async function loadInventoryData(isSearch = false) {
            const tbody = document.getElementById('listBody'); 
            const ordersRes = await supabase.from('orders').select('*'); 
            const allOrders = ordersRes.data || [];
            tbody.innerHTML = '';
            
            let filteredProducts = productList;
            if (isSearch) {
                const sName = document.getElementById('search_sName').value.toLowerCase(); 
                const sCode = document.getElementById('search_sCode').value.toLowerCase();
                filteredProducts = productList.filter(p => (sName ? p.name.toLowerCase().includes(sName) : true) && (sCode ? p.code.toLowerCase().includes(sCode) : true));
            }
            
            // 재고0개품목제외 체크박스 확인
            const hideZeroStock = document.getElementById('hideZeroStock')?.checked;
            if (hideZeroStock) {
                filteredProducts = filteredProducts.filter(p => (p.stock || 0) > 0);
            }
            
            filteredProducts.forEach(prod => {
                let reservedQty = 0; 
                
                // 예약 수량 계산
                allOrders.forEach(ord => { 
                    if (ord.status === 'completed') return;

                    if(ord.items) { 
                        ord.items.forEach(item => { 
                            if(item.name === prod.name) { 
                                reservedQty += item.qty; 
                            } 
                        }); 
                    } 
                });
                
                const availableStock = prod.stock - reservedQty;
                const stockClass = availableStock < 0 ? 'text-red-600' : 'text-blue-600';
                
                let reservedText = reservedQty > 0 
                    ? `<span class="text-red-500 font-bold">(${reservedQty}개)</span>` 
                    : '<span class="text-gray-300">-</span>';
        
                // [수정됨] 시리얼 제외, 순서 변경, 상세 버튼 연결(openInventoryDetailModal)
                tbody.innerHTML += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="font-bold">${prod.name}</td>
                    <td class="text-center text-xs">${prod.manufacturer||'-'}</td>
                    <td class="text-center text-xs text-gray-500">${prod.last_vendor||'-'}</td>
                    <td class="text-right text-xs">${(prod.last_price||0).toLocaleString()}</td>
                    
                    <td class="text-center">
                        <input type="number" id="stock_${prod.id}" value="${prod.stock}" class="border rounded px-2 py-1 w-16 text-center font-bold">
                    </td>
                    
                    <td class="text-center font-bold ${stockClass}">${availableStock}</td>
                    
                    <td><input type="text" id="note_${prod.id}" value="${prod.inventory_note||''}" class="border rounded px-2 py-1 w-full text-xs"></td>
                    
                    <td class="text-xs text-center">${reservedText}</td>
                    
                    <td class="text-center flex gap-1 justify-center">
                        <button onclick="openInventoryDetailModal('${prod.name}')" class="bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600">상세</button>
                        <button onclick="updateInventory(${prod.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">저장</button>
                    </td>
                </tr>`;
            });
        }

        // [수정됨] 상세 보기: 입고(시리얼) 내역 + 예약 내역 통합 표시
async function openInventoryDetailModal(prodName) {
    const modal = document.getElementById('genericModal');
    document.getElementById('modalTitle').innerText = `[${prodName}] 상세 현황`;
    const body = document.getElementById('modalBody');
    modal.classList.add('active');
    
    body.innerHTML = '<div class="p-4 text-center">데이터 로딩중...</div>';

    // 1. 입고 내역(시리얼) 조회
    const { data: purchases } = await supabase.from('purchases').select('*').eq('item_name', prodName).order('date', { ascending: false });
    
    // 2. 예약 내역 조회
    const { data: orders } = await supabase.from('orders').select('*').order('date', { ascending: false });
    let reservedList = [];
    if (orders) {
        orders.forEach(ord => {
            if (ord.items) {
                ord.items.forEach(item => {
                    if (item.name === prodName) {
                        reservedList.push({ date: ord.date, partner: ord.partner_name, qty: item.qty });
                    }
                });
            }
        });
    }

    // 3. 입고 내역 정렬 (시리얼 있는 것을 위로)
    const sortedPurchases = (purchases || []).sort((a, b) => {
        const aHasSerial = a.serial_no && a.serial_no.trim() !== '' ? 1 : 0;
        const bHasSerial = b.serial_no && b.serial_no.trim() !== '' ? 1 : 0;
        return bHasSerial - aHasSerial; // 내림차순 (있는 게 위로)
    });

    // 4. HTML 생성 (스크롤 적용: max-h-96 overflow-y-auto)
    let html = `<div class="grid grid-cols-2 gap-4 max-h-[600px] overflow-y-auto">`;

    // 왼쪽: 입고 및 시리얼 현황
    html += `<div>
        <h3 class="font-bold text-sm mb-2 text-blue-700"><i class="fa-solid fa-box-open"></i> 입고 및 시리얼 현황</h3>
        <table class="w-full text-xs text-left border-collapse border">
            <thead class="bg-blue-50"><tr><th class="p-2 border">입고일</th><th class="p-2 border">시리얼번호</th><th class="p-2 border text-right">수량</th></tr></thead>
            <tbody>`;
    
    if (sortedPurchases.length === 0) html += `<tr><td colspan="3" class="p-2 text-center text-gray-400">입고 내역 없음</td></tr>`;
    else {
        sortedPurchases.forEach(p => {
            const serialDisplay = p.serial_no ? `<span class="font-bold text-blue-600">${p.serial_no}</span>` : '<span class="text-gray-300">-</span>';
            html += `<tr><td class="p-2 border">${p.date}</td><td class="p-2 border">${serialDisplay}</td><td class="p-2 border text-right">${p.qty}</td></tr>`;
        });
    }
    html += `</tbody></table></div>`;

    // 오른쪽: 출고 예약 현황
    html += `<div>
        <h3 class="font-bold text-sm mb-2 text-red-700"><i class="fa-solid fa-truck-ramp-box"></i> 출고 예약 현황</h3>
        <table class="w-full text-xs text-left border-collapse border">
            <thead class="bg-red-50"><tr><th class="p-2 border">수주일자</th><th class="p-2 border">거래처</th><th class="p-2 border text-right">예약</th></tr></thead>
            <tbody>`;
            
    if (reservedList.length === 0) html += `<tr><td colspan="3" class="p-2 text-center text-gray-400">예약 내역 없음</td></tr>`;
    else {
        reservedList.forEach(r => {
            html += `<tr><td class="p-2 border">${r.date}</td><td class="p-2 border">${r.partner}</td><td class="p-2 border text-right font-bold text-red-500">${r.qty}</td></tr>`;
        });
    }
    html += `</tbody></table></div></div>`;
    
    html += `<div class="mt-6 text-right"><button onclick="closeModal()" class="bg-slate-600 text-white px-6 py-2 rounded font-bold hover:bg-slate-700">닫기</button></div>`;
    
    body.innerHTML = html;
}
        
        async function updateInventory(id) { 
            const note = document.getElementById(`note_${id}`).value; 
            const newStock = parseInt(document.getElementById(`stock_${id}`).value) || 0; 
            const { error } = await supabase.from('products').update({ inventory_note: note, stock: newStock }).eq('id', id); 
            if(error) alert("저장 실패: " + error.message); else { alert("수정되었습니다."); fetchData().then(() => loadInventoryData(true)); }
        }

        function renderComplexForm(tab, container) {
            const today = new Date().toISOString().split('T')[0];
            let loadBtn = '';
            if(tab === 'orders') loadBtn = `<button onclick="openLoadModal('quotes')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-orange-600">견적 불러오기</button>`;
            if(tab === 'sales') loadBtn = `<button onclick="openLoadModal('orders')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-blue-600">주문 불러오기</button>`;
            
            container.innerHTML = `
            <div class="bg-slate-50 p-4 rounded mb-4 border">
                <div class="grid grid-cols-3 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">일자</label><input type="date" id="sDate" class="input-box" value="${today}"></div>
                    <div><label class="text-xs text-slate-500 flex items-center">거래처 ${loadBtn}</label><input id="sPartner" class="input-box" list="dl_part" onchange="fillPart(this.value)"></div>
                    <div><label class="text-xs text-slate-500">담당자(우리측)</label><input id="sManager" class="input-box"></div>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">거래처담당자</label><input id="sPManager" class="input-box"></div>
                    <div><label class="text-xs text-slate-500">연락처</label><input id="sContact" class="input-box"></div>
                    <div class="col-span-2"><label class="text-xs text-slate-500">주소</label><input id="sAddr" class="input-box"></div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">거래처이메일</label><input id="sEmail" class="input-box"></div>
                    <div><label class="text-xs text-slate-500">비고</label><input id="sNote" class="input-box"></div>
                </div>
            </div>${renderItemInputArea(tab)}`;
            fillDL('dl_part', partnerList); fillDL('dl_prod', productList);
        }
        function renderItemInputArea(tab) { 
            return `
            <div class="bg-white border p-3 rounded mb-4 shadow-sm">
                <div class="flex gap-2 items-end">
                    <div class="w-1/4"><label class="text-xs">품목명</label><input id="iName" class="input-box" list="dl_prod" onchange="fillProd(this.value)"></div>
                    <div class="flex-grow"><label class="text-xs">규격 (수정가능)</label><input id="iSpec" class="input-box"></div>
                    <div class="w-20"><label class="text-xs">수량</label><input type="number" id="iQty" class="input-box" value="1"></div>
                    <div class="w-28"><label class="text-xs">단가</label><input type="number" id="iPrice" class="input-box"></div>
                    <button onclick="addItemToGrid('${tab}')" class="bg-slate-700 text-white px-4 py-2 rounded font-bold text-sm h-9">추가</button>
                </div>
            </div>
            
            <table class="w-full text-sm border-collapse border text-center mb-4">
                <thead class="bg-slate-100">
                    <tr><th>품목명</th><th style="width:30%">규격</th><th>수량</th><th>단가</th><th>공급가액</th><th>부가세</th><th>합계</th><th>삭제</th></tr>
                </thead>
                <tbody id="itemGrid"></tbody>
            </table>
            
            <div class="flex flex-col items-end gap-1 mt-4 mb-6 pr-2">
                <div class="flex justify-between w-64 text-sm">
                    <span class="text-slate-500 font-medium">공급가액</span> 
                    <span class="font-bold text-slate-700"><span id="sTotalSupply">0</span>원</span>
                </div>
                <div class="flex justify-between w-64 text-sm">
                    <span class="text-slate-500 font-medium">부가세</span> 
                    <span class="font-bold text-slate-700"><span id="sTotalVat">0</span>원</span>
                </div>
                <div class="flex justify-between w-64 border-t border-slate-300 pt-2 mt-1 text-lg text-cyan-700 font-bold">
                    <span>총 합계</span> 
                    <span><span id="sGrandTotal">0</span>원</span>
                </div>
            </div>

            <button onclick="saveComplexData('${tab}')" class="w-full bg-cyan-600 text-white py-3 rounded font-bold shadow-lg hover:bg-cyan-700 transition">문서 저장</button>
            <datalist id="dl_part"></datalist><datalist id="dl_prod"></datalist>`; 
        }
        
        function addItemToGrid(tab) {
            const name = el('iName'); 
            const qty = parseInt(el('iQty'))||0; 
            const price = parseInt(el('iPrice'))||0;
            
            // [수정] 입력된 규격 값(iSpec)을 우선 사용하고, 없으면 품목 정보(prod.spec) 사용
            const prod = productList.find(p => p.name === name);
            const inputSpec = el('iSpec');
            const spec = inputSpec ? inputSpec : (prod ? prod.spec : ''); 
            
            if(!name || qty <= 0) return alert("품목명과 수량을 확인해주세요.");
        
            const supply = qty * price; 
            const vat = Math.floor(supply * 0.1); 
            const total = supply + vat;
            const unit = prod ? prod.unit : 'EA';
        
            tempItems.push({ name, qty, price, supply, vat, total, spec, unit });
            
            renderGrid(); 
            document.getElementById('iName').value=''; 
            document.getElementById('iQty').value='1';
            document.getElementById('iSpec').value=''; 
        }
        function renderGrid() {
            const tbody = document.getElementById('itemGrid'); 
            tbody.innerHTML = ''; 
            
            // [수정됨] 공급가액, 부가세, 총합계 변수 각각 선언
            let totalSupply = 0;
            let totalVat = 0;
            let grandTotal = 0;
            
            tempItems.forEach((item, idx) => {
                // 각각 누적 계산
                totalSupply += item.supply;
                totalVat += item.vat;
                grandTotal += item.total;
                
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition border-b">
                        <td class="py-2">${item.name}</td>
                        <td class="text-left px-2 text-slate-600 text-xs">${item.spec||''}</td>
                        <td>${item.qty}</td>
                        <td class="text-right px-2">${item.price.toLocaleString()}</td>
                        <td class="text-right px-2 text-slate-600">${item.supply.toLocaleString()}</td>
                        <td class="text-right px-2 text-slate-400 text-xs">${item.vat.toLocaleString()}</td>
                        <td class="text-right px-2 font-bold">${item.total.toLocaleString()}</td>
                        <td onclick="tempItems.splice(${idx},1); renderGrid()" class="cursor-pointer text-red-400 hover:text-red-600">
                            <i class="fa-solid fa-trash"></i>
                        </td>
                    </tr>`;
            });
            
            // [수정됨] 화면에 각각의 합계 표시
            document.getElementById('sTotalSupply').innerText = totalSupply.toLocaleString();
            document.getElementById('sTotalVat').innerText = totalVat.toLocaleString();
            document.getElementById('sGrandTotal').innerText = grandTotal.toLocaleString();
        }
        
        // [신규] 구매 관리 전용: 품목 추가 함수
        function addPurchaseItem() {
            const name = document.getElementById('purItem').value;
            const maker = document.getElementById('purMaker').value;
            const serial = document.getElementById('purSerial').value;
            const qty = parseInt(document.getElementById('purQty').value) || 0;
            const price = parseInt(document.getElementById('purPrice').value) || 0;
        
            if (!name || qty <= 0) return alert("품목명과 수량을 확인해주세요.");
        
            const total = qty * price;
            // tempItems에 구매 전용 데이터 구조로 저장
            tempItems.push({ name, manufacturer: maker, serial_no: serial, qty, unit_price: price, total_amount: total });
        
            renderPurchaseGrid();
            
            // 입력창 초기화
            document.getElementById('purItem').value = '';
            document.getElementById('purMaker').value = '';
            document.getElementById('purSerial').value = '';
            document.getElementById('purQty').value = '1';
        }

        // [신규] 구매 관리 전용: 그리드 렌더링 함수
        function renderPurchaseGrid() {
            const tbody = document.getElementById('purItemGrid');
            tbody.innerHTML = '';
            let grandTotal = 0;
        
            tempItems.forEach((item, idx) => {
                grandTotal += item.total_amount;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.manufacturer || '-'}</td>
                        <td>${item.serial_no || '-'}</td>
                        <td>${item.qty}</td>
                        <td>${item.unit_price.toLocaleString()}</td>
                        <td class="font-bold">${item.total_amount.toLocaleString()}</td>
                        <td onclick="tempItems.splice(${idx},1); renderPurchaseGrid()" class="cursor-pointer text-red-400"><i class="fa-solid fa-trash"></i></td>
                    </tr>
                `;
            });
            document.getElementById('purGrandTotal').innerText = grandTotal.toLocaleString();
        }
        // [신규] 세트(BOM) 관리 팝업 열기
        async function openBOMModal() {
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = "세트(BOM) 구성 관리";
            const body = document.getElementById('modalBody');
            modal.classList.add('active');
        
            // BOM 데이터 불러오기
            const { data: bomList } = await supabase.from('bom').select('*').order('parent_name');
        
            let html = `
            <div class="bg-purple-50 p-4 rounded border border-purple-200 mb-4">
                <p class="text-sm text-purple-700 mb-2 font-bold"><i class="fa-solid fa-circle-info"></i> 세트 품목 등록 방법</p>
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-xs text-slate-500">세트 품목 (보여지는 것)</label>
                        <input id="bomParent" class="input-box" list="dl_prod" placeholder="예: 머신시스템">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-slate-500">구성 부품 (실제 나가는 것)</label>
                        <input id="bomChild" class="input-box" list="dl_prod" placeholder="예: IS모델">
                    </div>
                    <div class="w-20">
                        <label class="text-xs text-slate-500">소요 수량</label>
                        <input type="number" id="bomQty" class="input-box" value="1">
                    </div>
                    <button onclick="saveBOM()" class="bg-purple-600 text-white px-4 py-2 rounded font-bold text-sm h-9 hover:bg-purple-700">추가</button>
                </div>
            </div>
        
            <div class="overflow-y-auto max-h-96">
                <table class="w-full text-sm text-left border-collapse border">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-2 border">세트 품목명</th>
                            <th class="p-2 border">구성 부품명</th>
                            <th class="p-2 border text-center">수량</th>
                            <th class="p-2 border text-center">삭제</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
            if (!bomList || bomList.length === 0) {
                html += `<tr><td colspan="4" class="p-4 text-center text-gray-400">등록된 세트 구성이 없습니다.</td></tr>`;
            } else {
                bomList.forEach(item => {
                    html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-2 border font-bold text-purple-700">${item.parent_name}</td>
                        <td class="p-2 border">${item.child_name}</td>
                        <td class="p-2 border text-center">${item.qty}</td>
                        <td class="p-2 border text-center">
                            <button onclick="deleteBOM(${item.id})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }
            html += `</tbody></table></div>
            <datalist id="dl_prod">${productList.map(p => `<option value="${p.name}">`).join('')}</datalist>`; // 품목 자동완성 연결
        
            body.innerHTML = html;
        }
        
        // [신규] BOM 저장
        async function saveBOM() {
            const parent = document.getElementById('bomParent').value;
            const child = document.getElementById('bomChild').value;
            const qty = parseInt(document.getElementById('bomQty').value) || 0;
        
            if (!parent || !child || qty <= 0) return alert("모든 항목을 정확히 입력해주세요.");
        
            const { error } = await supabase.from('bom').insert({ 
                parent_name: parent, 
                child_name: child, 
                qty: qty 
            });
        
            if (error) alert("저장 실패: " + error.message);
            else openBOMModal(); // 화면 새로고침
        }
        
        // [신규] BOM 삭제
        async function deleteBOM(id) {
            if (!confirm("이 구성을 삭제하시겠습니까?")) return;
            const { error } = await supabase.from('bom').delete().eq('id', id);
            if (error) alert("삭제 실패");
            else openBOMModal(); // 화면 새로고침
        }

        // 1. 데이터 불러오기 팝업 열기 (견적/주문 불러오기)
async function openLoadModal(srcTab) { 
    currentLoadSource = srcTab; // [추가] 현재 불러오는 소스(orders/quotes) 저장
    const modal = document.getElementById('loadDataModal');
    if (!modal) return alert("모달창을 찾을 수 없습니다.");
    
    modal.classList.add('active'); 
    document.getElementById('loadModalTitle').innerText = (srcTab === 'quotes' ? '견적서' : '주문서') + ' 불러오기'; 
    
    const tbody = document.getElementById('loadDataBody'); 
    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">데이터를 불러오는 중...</td></tr>'; 
    
    try {
        const { data, error } = await supabase.from(srcTab).select('*').order('created_at', {ascending:false}); 
        
        if (error) throw error;
        
        tbody.innerHTML = ''; 
        if(!data || data.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">데이터가 없습니다.</td></tr>'; 
            return; 
        } 
        
        data.forEach(row => { 
            // 작은따옴표 이스케이프 처리 후 ID 전달
            const rowId = storeRowData(row);
            tbody.innerHTML += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-3">${row.date}</td>
                    <td class="p-3">${row.partner_name}</td>
                    <td class="p-3 text-right font-bold">${(row.total_amount||0).toLocaleString()}</td>
                    <td class="p-3 text-center">
                        <button onclick="applyDataById('${rowId}')" class="bg-blue-500 text-white px-3 py-1 text-xs rounded hover:bg-blue-600">선택</button>
                    </td>
                </tr>`; 
        });
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">오류 발생: ${e.message}</td></tr>`;
    }
}

// 2. ID로 데이터 찾아서 적용하기
function applyDataById(id) { 
    const row = getRowData(id); 
    if (row) {
        applyData(row); 
    } else {
        alert("데이터를 찾을 수 없습니다.");
    }
}

// 3. 선택한 데이터(견적/주문)를 현재 화면에 채우기
function applyData(row) { 
    // [추가] 만약 불러온 것이 '주문서(orders)'라면 ID를 기억해둠
    if (currentLoadSource === 'orders') {
        currentLoadedOrderId = row.id;
    } else {
        currentLoadedOrderId = null;
    }
    document.getElementById('sPartner').value = row.partner_name || ''; 
    document.getElementById('sManager').value = row.manager || ''; 
    
    if(row.partner_address || row.phone || row.partner_manager) {
        if(document.getElementById('sPManager')) document.getElementById('sPManager').value = row.partner_manager || '';
        if(document.getElementById('sContact')) document.getElementById('sContact').value = row.phone || '';
        if(document.getElementById('sAddr')) document.getElementById('sAddr').value = row.partner_address || '';
        if(document.getElementById('sEmail')) document.getElementById('sEmail').value = row.email || '';
    } else {
        fillPart(row.partner_name); 
    }

    if(row.items) { 
        tempItems = row.items; 
        renderGrid(); 
    } 
    document.getElementById('loadDataModal').classList.remove('active'); 
}

// 4. 주문/판매 입력 폼 렌더링 (버튼 생성 부분 확인용)
function renderComplexForm(tab, container) {
    const today = new Date().toISOString().split('T')[0];
    
    // [중요] 불러오기 버튼 생성 로직
    let loadBtn = '';
    if(tab === 'orders') loadBtn = `<button onclick="openLoadModal('quotes')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-orange-600">견적 불러오기</button>`;
    if(tab === 'sales') loadBtn = `<button onclick="openLoadModal('orders')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-blue-600">주문 불러오기</button>`;
    
    container.innerHTML = `
    <div class="bg-slate-50 p-4 rounded mb-4 border">
        <div class="grid grid-cols-3 gap-3 mb-2">
            <div><label class="text-xs text-slate-500">일자</label><input type="date" id="sDate" class="input-box" value="${today}"></div>
            <div><label class="text-xs text-slate-500 flex items-center">거래처 ${loadBtn}</label><input id="sPartner" class="input-box" list="dl_part" onchange="fillPart(this.value)"></div>
            <div><label class="text-xs text-slate-500">담당자(우리측)</label><input id="sManager" class="input-box"></div>
        </div>
        <div class="grid grid-cols-4 gap-3 mb-2">
            <div><label class="text-xs text-slate-500">거래처담당자</label><input id="sPManager" class="input-box"></div>
            <div><label class="text-xs text-slate-500">연락처</label><input id="sContact" class="input-box"></div>
            <div class="col-span-2"><label class="text-xs text-slate-500">주소</label><input id="sAddr" class="input-box"></div>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-2">
            <div><label class="text-xs text-slate-500">거래처이메일</label><input id="sEmail" class="input-box"></div>
            <div><label class="text-xs text-slate-500">비고</label><input id="sNote" class="input-box"></div>
        </div>
    </div>${renderItemInputArea(tab)}`;
    
    fillDL('dl_part', partnerList); 
    fillDL('dl_prod', productList);
}

        // ============= 캘린더 관련 함수들 =============
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let calendarEvents = [];
        let selectedColor = 'green';
        let editingEventId = null;

        // 캘린더 렌더링
        async function renderCalendar() {
            // 데이터가 없으면 로드 (최초 1회 혹은 필요시)
            if(calendarEvents.length === 0) await loadCalendarEvents();
            
            const contentArea = document.getElementById('contentArea');
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            
            // 현재 검색어 상태 확인 (재렌더링 시 검색어 유지 여부 판단)
            const existingSearch = document.getElementById('calendarSearchInput') ? document.getElementById('calendarSearchInput').value : '';
        
            let html = `
                <div class="calendar-container h-full flex flex-col">
                    <div class="calendar-header flex-none">
                        <h2 class="text-2xl font-bold text-slate-800">${currentYear}년 ${monthNames[currentMonth]}</h2>
                        
                        <div class="flex items-center gap-3">
                            <div class="relative group">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 group-hover:text-blue-500 transition"></i>
                                <input type="text" id="calendarSearchInput" value="${existingSearch}"
                                    placeholder="일정 검색 (제목, 내용)" 
                                    onkeyup="if(window.event.keyCode==13){ runCalendarSearch(this.value) } else if(this.value==''){ runCalendarSearch('') }"
                                    class="pl-10 pr-4 py-2 bg-slate-100 border-transparent focus:bg-white border focus:border-blue-500 rounded-full text-sm transition-all w-64 focus:w-80 outline-none shadow-sm"
                                >
                                ${existingSearch ? '<button onclick="clearCalendarSearch()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>' : ''}
                            </div>
        
                            <div class="flex gap-1 ml-2">
                                <button onclick="changeMonth(-1)" class="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded hover:bg-slate-50 font-semibold shadow-sm">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>
                                <button onclick="goToToday()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded hover:bg-slate-50 font-semibold shadow-sm text-sm">
                                    오늘
                                </button>
                                <button onclick="changeMonth(1)" class="px-3 py-2 bg-white border border-slate-300 text-slate-600 rounded hover:bg-slate-50 font-semibold shadow-sm">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
        
            // 검색어가 있으면 검색 결과 뷰(리스트), 없으면 달력 그리드 뷰 표시
            if (existingSearch.trim() !== '') {
                html += renderSearchResultsView(existingSearch); // 하단에 새로 추가할 함수
            } else {
                html += `
                    <div class="calendar-grid flex-1 overflow-auto">
                        ${dayNames.map(day => `<div class="calendar-day-header sticky top-0 bg-slate-50 z-10">${day}</div>`).join('')}
                        ${renderCalendarDays()}
                    </div>`;
            }
        
            html += `</div>`;
            contentArea.innerHTML = html;
            
            // 검색 후 입력창에 포커스 유지
            if(existingSearch) {
                const input = document.getElementById('calendarSearchInput');
                if(input) input.focus();
            }
        }

    // [신규] 캘린더 검색 실행
    function runCalendarSearch(keyword) {
        // renderCalendar를 호출하면 내부에서 input 값을 읽어 분기 처리함
        // 다만, 입력값 업데이트를 위해 DOM 요소 값이 변경된 상태여야 함
        renderCalendar();
    }
    
    // [신규] 검색어 초기화
    function clearCalendarSearch() {
        const input = document.getElementById('calendarSearchInput');
        if(input) input.value = '';
        renderCalendar();
    }
    
    // [신규] 구글 캘린더 스타일 리스트 뷰 렌더링 (이미지 참고)
    function renderSearchResultsView(keyword) {
        if (!keyword) return '';
    
        const lowerKey = keyword.toLowerCase();
        // 전체 기간 데이터에서 검색 (제목 또는 내용 일치)
        const filtered = calendarEvents.filter(e => 
            (e.title && e.title.toLowerCase().includes(lowerKey)) || 
            (e.description && e.description.toLowerCase().includes(lowerKey))
        );
    
        // 날짜순 정렬
        filtered.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
    
        if (filtered.length === 0) {
            return `<div class="flex flex-col items-center justify-center h-96 text-slate-400">
                <i class="fa-solid fa-magnifying-glass text-4xl mb-4"></i>
                <p>검색 결과가 없습니다.</p>
            </div>`;
        }
    
        let listHtml = `<div class="overflow-y-auto flex-1 p-4"><div class="max-w-4xl mx-auto bg-white rounded-lg shadow-sm border border-slate-200 divide-y divide-slate-100">`;
    
        filtered.forEach(evt => {
            // 날짜 포맷팅 (예: 24 2025년 11월, 월)
            const dateObj = new Date(evt.start_date);
            const dayNum = dateObj.getDate();
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            const dayStr = days[dateObj.getDay()];
            const yearMonth = `${dateObj.getFullYear()}년 ${dateObj.getMonth() + 1}월`;
    
            // 시간 포맷팅
            let timeHtml = '';
            if (evt.all_day) {
                timeHtml = `<span class="inline-block w-2 h-2 rounded-full bg-${evt.color || 'blue'}-500 mr-2"></span>종일`;
            } else {
                // 오전/오후 변환
                const formatTime = (t) => {
                    if (!t) return '';
                    const [h, m] = t.split(':');
                    const hour = parseInt(h);
                    const ampm = hour >= 12 ? '오후' : '오전';
                    const showHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    return `${ampm} ${showHour}:${m}`;
                };
                const start = formatTime(evt.start_time);
                const end = formatTime(evt.end_time);
                timeHtml = `<span class="inline-block w-2 h-2 rounded-full bg-${evt.color || 'blue'}-500 mr-2"></span>${start} ~ ${end}`;
            }
    
            // 클릭 시 수정 모달 열기
            listHtml += `
            <div class="flex hover:bg-slate-50 transition cursor-pointer group" onclick="editEvent(${evt.id})">
                <div class="w-48 p-4 flex flex-col justify-center border-r border-transparent group-hover:border-slate-100 shrink-0">
                    <div class="flex items-baseline gap-2">
                        <span class="text-2xl font-bold text-slate-700">${dayNum}</span>
                        <span class="text-xs text-slate-500 font-medium">${yearMonth}, ${dayStr}</span>
                    </div>
                </div>
    
                <div class="flex-1 p-4 flex flex-col justify-center">
                    <div class="flex items-center text-sm font-bold text-slate-600 mb-1">
                        ${timeHtml}
                    </div>
                    <div class="text-base font-bold text-slate-800 mb-1">${evt.title}</div>
                    ${evt.description ? `<div class="text-sm text-slate-400 truncate">${evt.description}</div>` : ''}
                </div>
                
                <div class="w-12 flex items-center justify-center text-slate-300 opacity-0 group-hover:opacity-100 transition">
                    <i class="fa-solid fa-chevron-right"></i>
                </div>
            </div>
            `;
        });
    
        listHtml += `</div></div>`;
        return listHtml;
    }
        
        // 캘린더 날짜 렌더링
        function renderCalendarDays() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            // 오늘 날짜 계산
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            let html = '';
            
            // 이전 달 날짜
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const date = prevLastDate - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${date}</div></div>`;
            }
            
            // 현재 달 날짜
            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const dayEvents = getEventsForDate(dateStr);
                
                // 오늘 날짜 강조 클래스
                const isToday = dateStr === todayStr;
                const todayClass = isToday ? 'today' : '';
                
                // 일정 표시 로직 (최대 2개, 나머지는 "N개 더보기")
                const maxVisible = 2;
                const visibleEvents = dayEvents.slice(0, maxVisible);
                const hiddenCount = dayEvents.length - maxVisible;
                
                html += `
                    <div class="calendar-day ${todayClass}" ondblclick="openEventModal('${dateStr}')">
                        <div class="calendar-day-number">${date}</div>
                        ${visibleEvents.map(evt => {
                            const timeStr = evt.all_day ? '' : evt.start_time ? evt.start_time.substring(0, 5) + ' ' : '';
                            
                            // [핵심 수정] ondblclick -> onclick 변경 (한 번 클릭으로 수정)
                            // event.stopPropagation()은 클릭 시 부모(날짜 칸)의 더블클릭 이벤트가 발동되는 것을 막아줍니다.
                            return `<div class="calendar-event event-${evt.color} ${evt.all_day ? 'allday' : ''}" 
                                    onclick="editEvent(${evt.id}); event.stopPropagation();"
                                    title="${evt.title}">
                                        ${timeStr}${evt.title}
                                   </div>`;
                        }).join('')}
                        
                        ${hiddenCount > 0 ? 
                            `<div class="calendar-more-events" onclick="showAllEvents('${dateStr}'); event.stopPropagation();">
                                +${hiddenCount}개 더보기
                            </div>` : ''}
                    </div>
                `;
            }
            
            // 다음 달 날짜
            const totalCells = firstDayOfWeek + lastDate;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let date = 1; date <= remainingCells; date++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${date}</div></div>`;
            }
            
            return html;
        }

        // 특정 날짜의 이벤트 가져오기
        function getEventsForDate(dateStr) {
            return calendarEvents.filter(evt => {
                const start = evt.start_date;
                const end = evt.end_date;
                return dateStr >= start && dateStr <= end;
            }).sort((a, b) => {
                if (a.all_day && !b.all_day) return -1;
                if (!a.all_day && b.all_day) return 1;
                if (a.start_time && b.start_time) return a.start_time.localeCompare(b.start_time);
                return 0;
            });
        }

        // 월 변경
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }

        // 오늘로 이동
        function goToToday() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            renderCalendar();
        }

        // 이벤트 로드
        async function loadCalendarEvents() {
            try {
                // 데이터 불러오기
                const { data, error } = await supabase
                    .from('calendar_events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                // 전역 변수에 최신 데이터 저장
                calendarEvents = data || [];
                
            } catch (e) {
                console.error('일정 로드 오류:', e);
                calendarEvents = []; // 에러 시 빈 배열로 초기화
            }
        }

        // 이벤트 모달 열기 (새 일정)
        function openEventModal(dateStr = null) {
            editingEventId = null;
            selectedColor = 'green';
            
            const today = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('eventModalTitle').innerText = '일정 추가';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventAllDay').checked = false;
            document.getElementById('eventStartDate').value = today;
            document.getElementById('eventEndDate').value = today;
            document.getElementById('eventStartTime').value = '09:00';
            document.getElementById('eventEndTime').value = '10:00';
            document.getElementById('eventDescription').value = '';
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            toggleAllDay();
            selectColor('green');
            
            document.getElementById('eventModal').classList.add('active');

            document.getElementById('eventStartDate').addEventListener('change', function() {
                const start = this.value;
                const endInput = document.getElementById('eventEndDate');
                if(endInput.value < start) {
                    endInput.value = start;
                }
            });
        }

        // 이벤트 편집
        function editEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;
            
            editingEventId = eventId;
            selectedColor = event.color || 'green';
            
            document.getElementById('eventModalTitle').innerText = '일정 수정';
            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventAllDay').checked = event.all_day || false;
            document.getElementById('eventStartDate').value = event.start_date || '';
            document.getElementById('eventEndDate').value = event.end_date || '';
            document.getElementById('eventStartTime').value = event.start_time || '09:00';
            document.getElementById('eventEndTime').value = event.end_time || '10:00';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('deleteEventBtn').style.display = 'block';
            
            toggleAllDay();
            selectColor(event.color || 'green');
            
            document.getElementById('eventModal').classList.add('active');
        }

        // 하루종일 토글
        function toggleAllDay() {
            const allDay = document.getElementById('eventAllDay').checked;
            document.getElementById('eventStartTime').disabled = allDay;
            document.getElementById('eventEndTime').disabled = allDay;
            
            if (allDay) {
                document.getElementById('eventStartTime').style.opacity = '0.5';
                document.getElementById('eventEndTime').style.opacity = '0.5';
            } else {
                document.getElementById('eventStartTime').style.opacity = '1';
                document.getElementById('eventEndTime').style.opacity = '1';
            }
        }

        // 색상 선택
        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            const colorOpt = document.querySelector(`[data-color="${color}"]`);
            if (colorOpt) colorOpt.classList.add('selected');
        }

        // 이벤트 저장
        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) {
                alert('일정 제목을 입력해주세요.');
                return;
            }
            
            // 날짜 값 가져오기
            const startDate = document.getElementById('eventStartDate').value;
            let endDate = document.getElementById('eventEndDate').value;

            // [버그 수정 코드] 시작일이 종료일보다 늦으면, 종료일을 시작일과 같게 맞춤
            if (startDate > endDate) {
                endDate = startDate; // 종료일을 시작일로 강제 변경
                // 또는 alert("종료일이 시작일보다 빠를 수 없습니다."); return; // 경고를 띄우고 중단할 수도 있습니다.
            }
            
            const isAllDay = document.getElementById('eventAllDay').checked;
            
            const eventData = {
                title: title,
                start_date: startDate,
                end_date: endDate, // 수정된 endDate 사용
                
                // 하루 종일일 경우 시간 처리
                start_time: isAllDay ? '00:00' : document.getElementById('eventStartTime').value,
                end_time: isAllDay ? '23:59' : document.getElementById('eventEndTime').value,
                
                all_day: isAllDay,
                description: document.getElementById('eventDescription').value.trim(),
                color: selectedColor
            };
            
            try {
                if (editingEventId) {
                    // 수정
                    const { error } = await supabase
                        .from('calendar_events')
                        .update(eventData)
                        .eq('id', editingEventId);
                    
                    if (error) throw error;
                    alert('일정이 수정되었습니다.');
                } else {
                    // 추가
                    const { error } = await supabase
                        .from('calendar_events')
                        .insert([eventData]);
                    
                    if (error) throw error;
                    alert('일정이 추가되었습니다.');
                }
                
                closeEventModal();
                await loadCalendarEvents();
                renderCalendar();
            } catch (e) {
                console.error('일정 저장 오류:', e);
                alert('일정 저장 중 오류가 발생했습니다: ' + e.message);
            }
        }

        // 이벤트 삭제
        async function deleteEvent() {
            // ID가 없는 경우(오류 방지)
            if (!editingEventId) {
                alert("선택된 일정이 없습니다.");
                return;
            }
            
            if (!confirm('정말 이 일정을 삭제하시겠습니까?')) return;
            
            try {
                const { error } = await supabase
                    .from('calendar_events')
                    .delete()
                    .eq('id', editingEventId);
                
                if (error) throw error;
                
                alert('일정이 삭제되었습니다.');
                closeEventModal();
                
                // [핵심 수정] 삭제 후 DB에서 최신 데이터를 다시 불러와야 화면에서도 사라집니다.
                await loadCalendarEvents(); 
                renderCalendar();
                
            } catch (e) {
                console.error('일정 삭제 오류:', e);
                alert('일정 삭제 중 오류가 발생했습니다: ' + e.message);
            }
        }

        // 이벤트 모달 닫기
        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            editingEventId = null;
        }

        // 특정 날짜의 모든 일정 표시
        function showAllEvents(dateStr) {
            const events = getEventsForDate(dateStr);
            const modal = document.getElementById('allEventsModal');
            const body = document.getElementById('allEventsModalBody');
            const title = document.getElementById('allEventsModalTitle');
            
            // 날짜 포맷
            const [year, month, day] = dateStr.split('-');
            title.innerText = `${year}년 ${parseInt(month)}월 ${parseInt(day)}일 일정`;
            
            if (events.length === 0) {
                body.innerHTML = '<p class="text-center text-slate-500 py-8">일정이 없습니다.</p>';
            } else {
                body.innerHTML = events.map(evt => {
                    const timeStr = evt.all_day ? '하루 종일' : evt.start_time ? evt.start_time.substring(0, 5) : '';
                    
                    // [수정된 부분] 
                    // 1. ondblclick -> onclick (한 번 클릭으로 변경)
                    // 2. editEvent('${evt.id}') -> editEvent(${evt.id}) (따옴표 제거하여 숫자로 전달)
                    return `
                        <div class="calendar-event event-${evt.color} mb-2 cursor-pointer hover:opacity-80 transition" 
                             onclick="editEvent(${evt.id}); closeAllEventsModal();" 
                             style="padding: 10px; font-size: 14px; border-radius: 4px;">
                            <div class="font-bold flex justify-between">
                                <span>${evt.title}</span>
                                <span class="text-xs font-normal opacity-70 flex items-center"><i class="fa-solid fa-pen"></i></span>
                            </div>
                            ${timeStr ? `<div class="text-xs mt-1 font-semibold opacity-90">${timeStr}</div>` : ''}
                            ${evt.description ? `<div class="text-xs mt-1 opacity-80 whitespace-pre-wrap border-t border-black/10 pt-1 mt-1">${evt.description}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.add('active');
        }

        // 일정 더보기 모달 닫기
        function closeAllEventsModal() {
            document.getElementById('allEventsModal').classList.remove('active');
        }
        // ============= 캘린더 관련 함수들 끝 =============

        // [복구] 로그아웃 함수
    async function logout() {
        if (!confirm("정말 로그아웃 하시겠습니까?")) return;
        try {
            await supabase.auth.signOut();
        } catch (e) {
            console.error("로그아웃 오류 (무시):", e);
        } finally {
            alert("로그아웃 되었습니다.");
            window.location.href = 'index.html'; 
        }
    }
        
    </script>
</body>
</html>
