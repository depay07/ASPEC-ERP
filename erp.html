<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASPEC ERP - Î©îÏù∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* Î©îÎâ¥ ÌôúÏÑ±Ìôî Ïä§ÌÉÄÏùº */
        .nav-btn.active { background-color: #1e293b; color: #22d3ee; border-right: 4px solid #22d3ee; }
        
        /* Ïù∏ÏáÑ ÏÑ§Ï†ï */
        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 20mm; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col z-20 shadow-xl">
            <div class="p-6 border-b border-slate-800">
                 <svg width="120" height="40" viewBox="0 0 400 150">
                    <rect x="30" y="50" width="12" height="50" fill="#06b6d4"/>
                    <rect x="48" y="40" width="12" height="60" fill="#0891b2"/>
                    <rect x="66" y="45" width="12" height="55" fill="#0e7490"/>
                    <text x="95" y="90" font-family="Arial" font-size="60" font-weight="bold" fill="white">ASPEC</text>
                </svg>
            </div>
            
            <nav class="flex-1 py-4 space-y-1">
                <button onclick="switchTab('sales')" id="btn-sales" class="nav-btn active w-full text-left px-6 py-4 hover:bg-slate-800 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-cart-shopping"></i> Í≤¨Ï†Å/Ï£ºÎ¨∏/ÌåêÎß§
                </button>
                <button onclick="switchTab('inventory')" id="btn-inventory" class="nav-btn w-full text-left px-6 py-4 hover:bg-slate-800 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-boxes-stacked"></i> Ïû¨Í≥† Í¥ÄÎ¶¨
                </button>
                <button onclick="switchTab('history')" id="btn-history" class="nav-btn w-full text-left px-6 py-4 hover:bg-slate-800 hover:text-white transition flex items-center gap-3">
                    <i class="fa-solid fa-list"></i> Í±∞Îûò ÎÇ¥Ïó≠
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="w-full bg-slate-800 text-slate-400 py-2 rounded hover:bg-slate-700 hover:text-white transition text-sm">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Î°úÍ∑∏ÏïÑÏõÉ
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto relative">
            <header class="bg-white h-16 border-b flex items-center justify-between px-8 sticky top-0 z-10">
                <h1 class="text-xl font-bold text-slate-800" id="headerTitle">ÌåêÎß§ Í¥ÄÎ¶¨</h1>
                <div class="text-sm text-slate-500">Logged in as <span id="userEmail" class="font-bold text-cyan-600">User</span></div>
            </header>

            <div class="p-8">
                <section id="sec-sales" class="tab-content">
                    <div class="grid grid-cols-12 gap-6">
                        <div class="col-span-8 bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Î¨∏ÏÑú Íµ¨Î∂Ñ</label>
                                    <select id="txType" class="w-full mt-1 p-2 bg-slate-50 border border-slate-300 rounded focus:border-cyan-500 outline-none">
                                        <option value="Í≤¨Ï†ÅÏÑú">üìÑ Í≤¨Ï†ÅÏÑú (Ïû¨Í≥†Ïú†ÏßÄ)</option>
                                        <option value="Ï£ºÎ¨∏ÏÑú">üì¶ Ï£ºÎ¨∏ÏÑú (Î∞úÏ£º)</option>
                                        <option value="Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú">üí∞ ÌåêÎß§/Ï∂úÍ≥† (Ïû¨Í≥†Ï∞®Í∞ê)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Í±∞ÎûòÏ≤òÎ™Ö</label>
                                    <input type="text" id="partnerName" class="w-full mt-1 p-2 border border-slate-300 rounded focus:border-cyan-500 outline-none" placeholder="(Ï£º)Í±∞ÎûòÏ≤ò">
                                </div>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-lg mb-6 flex gap-2 border border-slate-200">
                                <select id="productSelect" class="flex-1 p-2 border border-slate-300 rounded outline-none">
                                    <option>ÏÉÅÌíà Î°úÎî©Ï§ë...</option>
                                </select>
                                <input type="number" id="qtyInput" class="w-24 p-2 border border-slate-300 rounded outline-none" placeholder="ÏàòÎüâ">
                                <button onclick="addToCart()" class="bg-slate-800 text-white px-4 rounded hover:bg-slate-700 font-bold">+</button>
                            </div>

                            <table class="w-full text-sm">
                                <thead class="bg-slate-100 text-slate-500 border-b">
                                    <tr>
                                        <th class="p-3 text-left">ÌíàÎ™©</th>
                                        <th class="p-3 text-right">Îã®Í∞Ä</th>
                                        <th class="p-3 text-center">ÏàòÎüâ</th>
                                        <th class="p-3 text-right">Ìï©Í≥Ñ</th>
                                        <th class="p-3 text-center">ÏÇ≠Ï†ú</th>
                                    </tr>
                                </thead>
                                <tbody id="cartBody">
                                    </tbody>
                            </table>
                            <div id="emptyCartMsg" class="text-center py-10 text-slate-400">Ïû•Î∞îÍµ¨ÎãàÍ∞Ä ÎπÑÏóàÏäµÎãàÎã§.</div>
                        </div>

                        <div class="col-span-4 space-y-4">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                <div class="text-slate-500 text-sm mb-1">Total Amount</div>
                                <div class="text-3xl font-bold text-cyan-600 text-right mb-6" id="totalPrice">0 Ïõê</div>
                                
                                <button onclick="saveData()" class="w-full bg-cyan-600 text-white py-3 rounded-lg font-bold hover:bg-cyan-700 mb-3 shadow-lg shadow-cyan-500/30 transition transform active:scale-95">
                                    Ï†ÄÏû• Î∞è ÌôïÏ†ï
                                </button>
                                <button onclick="printDoc()" class="w-full bg-white border-2 border-slate-200 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-print"></i> Ïù∏ÏáÑ / PDF Ï†ÄÏû•
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="sec-inventory" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 border-b text-slate-500">
                                <tr>
                                    <th class="p-4">ÏÉÅÌíàÎ™Ö</th>
                                    <th class="p-4">Í∑úÍ≤©</th>
                                    <th class="p-4 text-right">Îã®Í∞Ä</th>
                                    <th class="p-4 text-right">ÌòÑÏû¨Í≥†</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryBody"></tbody>
                        </table>
                    </div>
                </section>

                <section id="sec-history" class="tab-content hidden">
                    <div id="historyList" class="space-y-3"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="printArea" class="hidden">
        <div class="h-full border-2 border-black p-8 flex flex-col justify-between text-black">
            <div>
                <div class="flex justify-between items-end border-b-2 border-black pb-4 mb-8">
                    <h1 id="printTitle" class="text-4xl font-serif font-bold">Í±∞ Îûò Î™Ö ÏÑ∏ ÏÑú</h1>
                    <div class="text-right">
                         <svg width="100" height="30" viewBox="0 0 400 150">
                            <rect x="30" y="50" width="12" height="50" fill="#000"/>
                            <rect x="48" y="40" width="12" height="60" fill="#333"/>
                            <rect x="66" y="45" width="12" height="55" fill="#666"/>
                            <text x="95" y="90" font-family="Arial" font-size="60" font-weight="bold" fill="#000">ASPEC</text>
                        </svg>
                    </div>
                </div>

                <div class="flex mb-8 text-sm border border-black">
                    <div class="w-1/2 border-r border-black p-2">
                        <table class="w-full">
                            <tr><td class="font-bold w-16">Í≥µÍ∏âÏûê</td><td>ASPEC (ÏïÑÏä§Ìéô)</td></tr>
                            <tr><td class="font-bold">ÎåÄÌëú</td><td>ÌôçÍ∏∏Îèô</td></tr>
                        </table>
                    </div>
                    <div class="w-1/2 p-2">
                        <table class="w-full">
                            <tr><td class="font-bold w-16">Í∑ÄÌïò</td><td id="printPartner"></td></tr>
                            <tr><td class="font-bold">ÎÇ†Ïßú</td><td id="printDate"></td></tr>
                        </table>
                    </div>
                </div>

                <table class="w-full border-collapse border border-black text-sm mb-4">
                    <thead>
                        <tr class="bg-gray-100 text-center">
                            <th class="border border-black p-2">ÌíàÎ™©</th>
                            <th class="border border-black p-2 w-16">ÏàòÎüâ</th>
                            <th class="border border-black p-2 w-24">Îã®Í∞Ä</th>
                            <th class="border border-black p-2 w-28">Í∏àÏï°</th>
                        </tr>
                    </thead>
                    <tbody id="printBody"></tbody>
                    <tfoot>
                        <tr class="font-bold">
                            <td colspan="3" class="border border-black p-2 text-center">Ìï© Í≥Ñ</td>
                            <td id="printTotal" class="border border-black p-2 text-right"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="text-center text-sm">ÏúÑÏôÄ Í∞ôÏù¥ Ï≤≠Íµ¨(ÏòÅÏàò)Ìï©ÎãàÎã§.</div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ÏÑ§Ï†ï] index.htmlÍ≥º ÎòëÍ∞ôÏùÄ ÌÇ§Î•º ÎÑ£ÏúºÏÑ∏Ïöî!
        // ==========================================
        const SUPABASE_URL = https://gqttpmdpqotrkbdbstuu.supabase.co;
        const SUPABASE_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdHRwbWRwcW90cmtiZGJzdHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjU4MjIsImV4cCI6MjA3ODk0MTgyMn0.pR6dL8yU2lpugzYWpdDkQh_l5WcVO4YMlOPhMlCJmP8;
        // ==========================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let cart = [];
        let products = [];

        // 1. Î≥¥Ïïà Í≤ÄÏÇ¨ (Î°úÍ∑∏Ïù∏ ÏïàÌñàÏúºÎ©¥ Ï´ìÏïÑÎÉÑ)
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                window.location.href = 'index.html';
            } else {
                document.getElementById('userEmail').innerText = session.user.email.split('@')[0];
                loadProducts();
                loadHistory();
            }
        }

        // 2. ÌÉ≠ Ï†ÑÌôò (Î©îÎâ¥ ÎàÑÎ•¥Î©¥ ÏûëÎèô)
        function switchTab(tabName) {
            // Î™®Îì† ÏÑπÏÖò Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // ÏÑ†ÌÉùÌïú ÏÑπÏÖò Î≥¥Ïù¥Í∏∞
            document.getElementById('sec-' + tabName).classList.remove('hidden');
            
            // Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active', 'bg-slate-800', 'text-white'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                // Tailwind Í∏∞Î≥∏ hover ÌÅ¥ÎûòÏä§Îäî Ïú†ÏßÄÌï¥Ïïº Ìï®
            });
            
            // ÏÑ†ÌÉùÎêú Î≤ÑÌäº ÌôúÏÑ±Ìôî
            const activeBtn = document.getElementById('btn-' + tabName);
            activeBtn.classList.add('active');

            // Ï†úÎ™© Î≥ÄÍ≤Ω
            const titles = { 'sales': 'ÌåêÎß§ Í¥ÄÎ¶¨', 'inventory': 'Ïû¨Í≥† Í¥ÄÎ¶¨', 'history': 'Í±∞Îûò ÎÇ¥Ïó≠' };
            document.getElementById('headerTitle').innerText = titles[tabName];

            if(tabName === 'inventory') loadProducts();
            if(tabName === 'history') loadHistory();
        }

        // 3. Îç∞Ïù¥ÌÑ∞ Î°úÏßÅ (Ïù¥Ï†ÑÍ≥º ÎèôÏùºÌïòÎÇò ÏµúÏ†ÅÌôîÎê®)
        async function loadProducts() {
            const { data, error } = await supabase.from('products').select('*').order('name');
            if(error) return console.error(error);
            products = data;
            
            // ÏÖÄÎ†âÌä∏Î∞ïÏä§ Í∞±Ïã†
            const select = document.getElementById('productSelect');
            select.innerHTML = '';
            products.forEach(p => {
                select.innerHTML += `<option value="${p.id}">${p.name} (${p.spec}) - ${p.stock}Í∞ú</option>`;
            });

            // Ïû¨Í≥†ÌÖåÏù¥Î∏î Í∞±Ïã†
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            products.forEach(p => {
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 font-medium">${p.name}</td>
                        <td class="p-4 text-slate-500">${p.spec}</td>
                        <td class="p-4 text-right">${p.price.toLocaleString()}</td>
                        <td class="p-4 text-right font-bold ${p.stock < 10 ? 'text-red-500' : 'text-cyan-600'}">${p.stock}</td>
                    </tr>`;
            });
        }

        function addToCart() {
            const pid = document.getElementById('productSelect').value;
            const qty = parseInt(document.getElementById('qtyInput').value);
            if(!pid || !qty) return;

            const product = products.find(p => p.id == pid);
            const exist = cart.find(i => i.id == pid);
            if(exist) exist.qty += qty;
            else cart.push({ ...product, qty });

            renderCart();
            document.getElementById('qtyInput').value = '';
        }

        function renderCart() {
            const tbody = document.getElementById('cartBody');
            const msg = document.getElementById('emptyCartMsg');
            tbody.innerHTML = '';
            
            if(cart.length === 0) {
                msg.classList.remove('hidden');
            } else {
                msg.classList.add('hidden');
                let total = 0;
                cart.forEach((item, idx) => {
                    const sum = item.price * item.qty;
                    total += sum;
                    tbody.innerHTML += `
                        <tr class="border-b">
                            <td class="p-3">${item.name}</td>
                            <td class="p-3 text-right text-slate-400">${item.price.toLocaleString()}</td>
                            <td class="p-3 text-center font-bold">${item.qty}</td>
                            <td class="p-3 text-right">${sum.toLocaleString()}</td>
                            <td class="p-3 text-center text-red-400 cursor-pointer hover:text-red-600" onclick="cart.splice(${idx},1); renderCart()">
                                <i class="fa-solid fa-trash"></i>
                            </td>
                        </tr>`;
                });
                document.getElementById('totalPrice').innerText = total.toLocaleString() + " Ïõê";
            }
        }

        async function saveData() {
            if(cart.length === 0) return alert('Ïû•Î∞îÍµ¨ÎãàÍ∞Ä ÎπÑÏóàÏäµÎãàÎã§.');
            const type = document.getElementById('txType').value;
            const partner = document.getElementById('partnerName').value;
            const total = parseInt(document.getElementById('totalPrice').innerText.replace(/[^0-9]/g,''));

            // Ìä∏ÎûúÏû≠ÏÖò Ï†ÄÏû•
            await supabase.from('transactions').insert({
                type, partner_name: partner, items: cart, total_amount: total
            });

            // Ïû¨Í≥† Ï∞®Í∞ê (Í±∞ÎûòÎ™ÖÏÑ∏ÏÑúÏùº ÎïåÎßå)
            if(type === 'Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú') {
                for(const item of cart) {
                    await supabase.from('products').update({ stock: item.stock - item.qty }).eq('id', item.id);
                }
            }

            alert('Ï†ÄÏû• ÏôÑÎ£å!');
            cart = []; renderCart(); loadProducts(); switchTab('history');
        }

        async function loadHistory() {
            const { data } = await supabase.from('transactions').select('*').order('created_at', { ascending: false }).limit(20);
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            data.forEach(tx => {
                const colors = {'Í≤¨Ï†ÅÏÑú':'bg-yellow-100 text-yellow-700', 'Ï£ºÎ¨∏ÏÑú':'bg-blue-100 text-blue-700', 'Í±∞ÎûòÎ™ÖÏÑ∏ÏÑú':'bg-green-100 text-green-700'};
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border border-slate-200 flex justify-between items-center hover:shadow-md transition">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-bold px-2 py-1 rounded ${colors[tx.type] || 'bg-gray-100'}">${tx.type}</span>
                            <span class="font-bold text-slate-700">${tx.partner_name || 'Î¨¥Î™Ö'}</span>
                            <span class="text-xs text-slate-400">${tx.created_at.slice(0,10)}</span>
                        </div>
                        <div class="font-bold text-slate-800">${tx.total_amount.toLocaleString()}Ïõê</div>
                    </div>`;
            });
        }

        function printDoc() {
            if(cart.length === 0) return alert('Ïù∏ÏáÑÌï† ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
            
            const type = document.getElementById('txType').value;
            document.getElementById('printTitle').innerText = type === 'Í≤¨Ï†ÅÏÑú' ? 'Í≤¨ Ï†Å ÏÑú' : 'Í±∞ Îûò Î™Ö ÏÑ∏ ÏÑú';
            document.getElementById('printPartner').innerText = document.getElementById('partnerName').value;
            document.getElementById('printDate').innerText = new Date().toISOString().slice(0,10);
            
            const tbody = document.getElementById('printBody');
            tbody.innerHTML = '';
            let total = 0;
            
            cart.forEach(item => {
                const sum = item.price * item.qty;
                total += sum;
                tbody.innerHTML += `
                    <tr>
                        <td class="border border-black p-2 text-left">${item.name} <span class="text-xs text-gray-500">(${item.spec})</span></td>
                        <td class="border border-black p-2 text-center">${item.qty}</td>
                        <td class="border border-black p-2 text-right">${item.price.toLocaleString()}</td>
                        <td class="border border-black p-2 text-right">${sum.toLocaleString()}</td>
                    </tr>`;
            });
            
            // Îπà Ï§Ñ 5Í∞ú Ï∂îÍ∞Ä (Î™®ÏñëÏÉà Ïú†ÏßÄ)
            for(let i=0; i<5; i++) tbody.innerHTML += `<tr><td class="border border-black p-2">&nbsp;</td><td class="border border-black p-2"></td><td class="border border-black p-2"></td><td class="border border-black p-2"></td></tr>`;
            
            document.getElementById('printTotal').innerText = total.toLocaleString();
            window.print();
        }

        function logout() {
            supabase.auth.signOut().then(() => window.location.href = 'index.html');
        }

        // Ïã§Ìñâ
        checkAuth();
    </script>
</body>
</html>
