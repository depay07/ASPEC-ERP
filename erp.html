<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ASPEC ERP System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; font-size: 13px; background-color: #f1f5f9; }
        
        /* 모달 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 8px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal.active { display: flex; }

        /* 테이블 */
        .data-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .data-table th { background-color: #e2e8f0; color: #475569; font-weight: 700; padding: 12px 8px; border-bottom: 2px solid #cbd5e1; text-align: center; font-size: 14px; }
        .data-table td { padding: 12px 8px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
        
        .input-box { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 4px; transition: all 0.2s; font-size: 14px; }
        .input-box:focus { outline: none; border-color: #06b6d4; ring: 2px solid #e0f2fe; }
        .search-panel { background-color: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .search-label { font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 6px; display: block; text-transform: uppercase; }

        /* [수정] 인쇄 전용 스타일 (헤더/푸터 삭제 및 레이아웃 정밀 조정) */
        @media print {
            @page { 
                size: A4; 
                margin: 0; /* [해결 1,2] 브라우저 기본 헤더(날짜, 제목) 및 푸터(URL) 제거 */
            }
            body { margin: 0; padding: 0; background: white; }
            body * { visibility: hidden; }
            
            #printContainer, #printContainer * { 
                visibility: visible; 
                box-sizing: border-box; 
            }
        
            #printContainer { 
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: "Malgun Gothic", dotum, sans-serif; color: black !important;
            }
            
            /* 여백을 margin 대신 padding으로 주어 짤림 방지 */
            .print-wrap { width: 100%; padding: 15mm; margin: 0 auto; }
            
            .print-title-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; border-bottom: 2px solid black; padding-bottom: 5px; }
            .print-title-main { font-size: 36px; font-weight: 900; letter-spacing: -1px; }
            .print-title-sub { font-size: 16px; font-weight: normal; font-style: italic; margin-left: 10px; }
            .print-meta { text-align: right; font-size: 11px; line-height: 1.4; }
        
            /* 상단 그리드 박스 */
            .print-grid-box { 
                display: flex; 
                width: 100%; 
                border: 1px solid black; 
                margin-bottom: 10px;
            }
        
            .print-half { 
                width: 50%; 
                padding: 0;
                flex: 1;
            }
        
            /* 중앙 세로선 */
            .print-half:first-child { 
                border-right: 1px solid black; 
            }
        
            /* 정보 테이블 */
            .print-info-table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 11px; 
                table-layout: fixed; 
                border: none;
            }
        
            .print-info-table th { 
                background-color: #f3f3f3 !important; 
                text-align: center; 
                padding: 5px; 
                border-bottom: 1px solid black; 
                border-right: 1px solid black;
                width: 20%; 
                font-weight: bold; 
                height: 30px; 
                -webkit-print-color-adjust: exact; 
            }
        
            .print-info-table td { 
                padding: 2px 5px; 
                border-bottom: 1px solid black; 
                height: 30px; 
                vertical-align: middle; 
                font-size: 11px;
                word-break: break-all;
                overflow: hidden;
            }

            /* [해결 4] 마지막 줄의 테두리를 없애서 바깥 박스 테두리와 겹치지 않게 함 (선 두께 정상화) */
            .print-info-table tr:last-child th, 
            .print-info-table tr:last-child td {
                border-bottom: none;
            }
        
            .print-header-cell { 
                text-align: center; font-weight: bold; padding: 5px; 
                border-bottom: 1px solid black; font-size: 14px; 
                background-color: #e6e6e6 !important; -webkit-print-color-adjust: exact; 
            }
        
            /* 품목 테이블 */
            .print-items-table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 10px; 
                font-size: 11px; 
                table-layout: fixed; 
            }
        
            .print-items-table th { 
                border: 1px solid black; 
                background-color: #f3f3f3 !important; 
                padding: 5px; 
                text-align: center; 
                -webkit-print-color-adjust: exact; 
            }
        
            /* [해결 3] 품목 칸 높이 통일 및 자동 줄바꿈 */
            .print-items-table td { 
                border: 1px solid black; 
                padding: 5px; 
                height: 35px; /* 기본 높이를 35px로 고정 (빈 칸도 이 높이 유지) */
                word-break: keep-all;
                white-space: normal; /* 내용 많으면 줄바꿈 */
                vertical-align: middle;
            }
            
            /* 주소 칸 높이 강제 고정 */
            .addr-cell {
                height: 55px !important; 
                vertical-align: top !important;
                padding-top: 5px !important;
                line-height: 1.4;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="flex h-screen overflow-hidden no-print">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800">
                <a href="erp.html" class="block cursor-pointer hover:opacity-80 transition"><h1 class="text-2xl font-bold text-white">ASPEC <span class="text-cyan-400 text-sm">ERP</span></h1></a>
            </div>
            <nav class="flex-1 py-4 overflow-y-auto text-base">
                <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-4 mb-2">기초 등록</div>
                <button onclick="switchTab('partners')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-building w-5"></i> 거래처 관리</button>
                <button onclick="switchTab('products')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-box w-5"></i> 품목 관리</button>
                
                <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">자재/발주</div>
                <button onclick="switchTab('purchase_orders')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-import w-5"></i> 발주 관리 (PO)</button>
                <button onclick="switchTab('purchases')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-dolly w-5"></i> 구매 관리 (입고)</button>
                <button onclick="switchTab('inventory')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-warehouse w-5"></i> 재고 관리 현황</button>
                
                <div class="px-6 text-xs font-bold text-slate-500 uppercase mt-6 mb-2">영업 관리</div>
                <button onclick="switchTab('quotes')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-invoice w-5"></i> 견적 관리</button>
                <button onclick="switchTab('orders')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-file-signature w-5"></i> 주문 관리</button>
                <button onclick="switchTab('sales')" class="nav-btn w-full text-left px-6 py-3 hover:bg-slate-800 hover:text-white flex items-center gap-3"><i class="fa-solid fa-truck-fast w-5"></i> 판매 관리</button>
            </nav>
            <div class="p-6 border-t border-slate-800"><button onclick="logout()" class="w-full bg-slate-800 py-3 rounded text-sm hover:text-white font-bold">로그아웃</button></div>
        </aside>
        <main class="flex-1 overflow-y-auto p-8" id="mainContent">
            <div id="searchContainer"></div>
            <div id="contentArea"></div>
        </main>
    </div>

    <div id="genericModal" class="modal no-print"><div class="modal-content"><div class="flex justify-between items-center mb-6 border-b pb-4"><h2 id="modalTitle" class="text-2xl font-bold text-slate-800">입력</h2><button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-times text-2xl"></i></button></div><div id="modalBody"></div></div></div>
    <div id="loadDataModal" class="modal no-print" style="z-index: 60;"><div class="modal-content" style="max-width: 800px;"><h3 class="text-xl font-bold mb-4" id="loadModalTitle">데이터 불러오기</h3><div class="overflow-y-auto max-h-96 border rounded"><table class="w-full text-left text-sm"><thead class="bg-slate-50"><tr><th class="p-3">날짜</th><th class="p-3">거래처</th><th class="p-3">총액</th><th class="p-3">선택</th></tr></thead><tbody id="loadDataBody"></tbody></table></div><div class="mt-6 text-right"><button onclick="document.getElementById('loadDataModal').classList.remove('active')" class="px-6 py-2 bg-slate-200 rounded text-sm font-bold">닫기</button></div></div></div>

    <div id="printContainer" class="hidden">
        <div class="print-wrap">
            <div class="print-title-area">
                <div>
                    <span id="p_title_ko" class="print-title-main">견 적 서</span>
                    <span id="p_title_en" class="print-title-sub">QUOTATION</span>
                </div>
                <div class="print-meta">
                    <div>문서번호: <span id="p_no"></span></div>
                    <div>작성일자: <span id="p_date"></span></div>
                    <div id="p_valid_date_row">유효기간: <span id="p_valid_date"></span></div>
                </div>
            </div>
    
            <div class="print-grid-box">
                <div class="print-half">
                    <div class="print-header-cell" id="p_left_role">공 급 받 는 자</div>
                    <table class="print-info-table">
                        <colgroup><col style="width: 20%;"><col style="width: 80%;"></colgroup>
                        <tr><th>상호</th><td id="p_left_name"></td></tr>
                        <tr><th>주소</th><td id="p_left_addr" class="addr-cell"></td></tr>
                        <tr><th>담당자</th><td id="p_left_manager"></td></tr>
                        <tr><th>TEL</th><td id="p_left_phone"></td></tr>
                        <tr><th>E-mail</th><td id="p_left_email"></td></tr>
                    </table>
                </div>
            
                <div class="print-half">
                    <div class="print-header-cell" id="p_right_role">공 급 자</div>
                    <table class="print-info-table">
                        <colgroup><col style="width: 20%;"><col style="width: 80%;"></colgroup>
                        <tr><th>상호</th><td id="p_right_name">아스펙 (ASPEC)</td></tr>
                        <tr><th>주소</th><td class="addr-cell" style="font-size: 10px;">경기도 화성시 메타폴리스로 42, 9층 902호<br>(반송동, 디앤씨빌딩)</td></tr>                        
                        <tr><th>담당자</th><td id="p_right_manager"></td></tr>
                        <tr><th>TEL</th><td id="p_right_mp"></td></tr>
                        <tr><th>E-mail</th><td id="p_right_email"></td></tr>
                    </table>
                </div>
            </div>
    
            <table class="print-items-table">
                <colgroup>
                    <col style="width: 5%;"> 
                    <col style="width: 25%;"> 
                    <col style="width: 30%;"> <col style="width: 8%;"> 
                    <col style="width: 8%;"> 
                    <col style="width: 12%;"> 
                    <col style="width: 12%;"> 
                </colgroup>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>품명</th>
                        <th>규격</th>
                        <th>단위</th>
                        <th>수량</th>
                        <th>단가</th>
                        <th>공급가액</th>
                    </tr>
                </thead>
                <tbody id="p_tbody"></tbody>
                <tfoot>
                    <tr style="background: #f8f8f8; font-weight: bold;">
                        <td colspan="4" style="text-align: center; border-right: 1px solid black;">합 계 (Total)</td>
                        <td style="text-align: center; border-right: 1px solid black;" id="p_total_qty"></td>
                        <td style="text-align: right; border-right: 1px solid black;">VAT 포함</td>
                        <td style="text-align: right;" id="p_total_amt"></td>
                    </tr>
                    <tr style="background: #fff; border-top: 2px double black;">
                        <td colspan="7" style="padding: 10px; text-align: left;">
                            <strong>[비고]</strong> <span id="p_note"></span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gqttpmdpqotrkbdbstuu.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdHRwbWRwcW90cmtiZGJzdHV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNjU4MjIsImV4cCI6MjA3ODk0MTgyMn0.pR6dL8yU2lpugzYWpdDkQh_l5WcVO4YMlOPhMlCJmP8'; 

        if(!SUPABASE_URL || SUPABASE_URL.includes('YOUR_URL')) alert("API 키를 설정해주세요.");

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentTab = 'partners';
        let tempItems = []; 
        let partnerList = []; 
        let productList = [];
        let currentEditId = null; 
        let currentUserEmail = ""; 
        let globalDataStore = {};

        window.onload = async () => { 
            try { 
                const { data: { user } } = await supabase.auth.getUser();
                if(user) currentUserEmail = user.email;
                await fetchData(); 
                switchTab('partners'); 
            } 
            catch (e) { console.error(e); }
        };

        async function fetchData() {
            const pRes = await supabase.from('partners').select('*');
            const prodRes = await supabase.from('products').select('*').order('name');
            if(!pRes.error) partnerList = pRes.data || [];
            if(!prodRes.error) productList = prodRes.data || [];
        }

        function storeRowData(row) {
            const id = 'row_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            globalDataStore[id] = row;
            return id;
        }
        function getRowData(id) { return globalDataStore[id]; }

        function renderSearchPanel(tab) {
            const panel = document.getElementById('searchContainer');
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const currentDay = today.toISOString().split('T')[0];
            let html = `<div class="search-panel no-print"><div class="flex flex-wrap gap-6 items-end">`;

            if (!['partners', 'products', 'inventory'].includes(tab)) {
                html += `<div><span class="search-label">기간 조회</span><div class="flex items-center gap-2"><input type="date" id="searchStartDate" class="input-box" value="${firstDay}"><span class="text-slate-400">~</span><input type="date" id="searchEndDate" class="input-box" value="${currentDay}"></div></div>`;
            }

            if (tab === 'purchase_orders') {
                html += `<div><span class="search-label">납품업체</span><input type="text" id="search_sPartner" class="input-box" placeholder="업체명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">EndUser</span><input type="text" id="search_sEndUser" class="input-box" placeholder="EndUser" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">품목명</span><input type="text" id="search_sItem" class="input-box" placeholder="품목명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            } else if (tab === 'purchases') {
                html += `<div><span class="search-label">매입처</span><input type="text" id="search_sPartner" class="input-box" placeholder="매입처" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">품목명</span><input type="text" id="search_sItem" class="input-box" placeholder="품목명" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            } else if (tab === 'partners') {
                html += `<div><span class="search-label">상호명</span><input type="text" id="search_sName" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">담당자</span><input type="text" id="search_sManager" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            } else if (tab === 'products' || tab === 'inventory') {
                html += `<div><span class="search-label">품목명</span><input type="text" id="search_sName" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">코드</span><input type="text" id="search_sCode" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            } else {
                html += `<div><span class="search-label">거래처</span><input type="text" id="search_sPartner" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">담당자</span><input type="text" id="search_sManager" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div><div><span class="search-label">비고</span><input type="text" id="search_sNote" class="input-box" onkeypress="handleSearchKeyPress(event, '${tab}')"></div>`;
            }
            html += `<div class="ml-auto"><button onclick="runSearch('${tab}')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2.5 rounded font-bold shadow transition flex items-center gap-2 text-sm"><i class="fa-solid fa-magnifying-glass"></i> 조회</button></div></div></div>`;
            panel.innerHTML = html;
        }

        function handleSearchKeyPress(event, tab) { if (event.key === 'Enter') runSearch(tab); }

        async function runSearch(tab) {
            const tbody = document.getElementById('listBody');
            tbody.innerHTML = '<tr><td colspan="10" class="text-center p-8">데이터를 불러오는 중입니다...</td></tr>';
            if(tab === 'inventory') { await loadInventoryData(true); return; }
            let query = supabase.from(tab).select('*').order('created_at', { ascending: false });
            const sDate = document.getElementById('searchStartDate')?.value;
            const eDate = document.getElementById('searchEndDate')?.value;
            if(sDate && eDate) query = query.gte('date', sDate).lte('date', eDate);

            if(tab === 'purchase_orders') {
                const p = document.getElementById('search_sPartner').value; const e = document.getElementById('search_sEndUser').value;
                if(p) query = query.ilike('partner_name', `%${p}%`); if(e) query = query.ilike('end_user', `%${e}%`);
            } else if (tab === 'purchases') {
                const p = document.getElementById('search_sPartner').value; const i = document.getElementById('search_sItem').value;
                if(p) query = query.ilike('partner_name', `%${p}%`); if(i) query = query.ilike('item_name', `%${i}%`);
            } else if (tab === 'partners') {
                const n = document.getElementById('search_sName').value; const m = document.getElementById('search_sManager').value;
                if(n) query = query.ilike('name', `%${n}%`); if(m) query = query.ilike('manager_name', `%${m}%`);
            } else if (tab === 'products') {
                const n = document.getElementById('search_sName').value; const c = document.getElementById('search_sCode').value;
                if(n) query = query.ilike('name', `%${n}%`); if(c) query = query.ilike('code', `%${c}%`);
            } else {
                const p = document.getElementById('search_sPartner').value; const m = document.getElementById('search_sManager').value; const n = document.getElementById('search_sNote').value;
                if(p) query = query.ilike('partner_name', `%${p}%`); if(m) query = query.ilike('manager', `%${m}%`); if(n) query = query.ilike('note', `%${n}%`);
            }

            const { data, error } = await query;
            if(error) { alert("검색실패: "+error.message); return; }
            
            let resultData = data;
            if(tab === 'purchase_orders' || tab === 'purchases') {
                 const sItem = document.getElementById('search_sItem') ? document.getElementById('search_sItem').value.toLowerCase() : '';
                 if(sItem) {
                     if(tab === 'purchases') resultData = data.filter(r => r.item_name && r.item_name.toLowerCase().includes(sItem));
                     else resultData = data.filter(r => r.items && r.items.some(i => i.name.toLowerCase().includes(sItem)));
                 }
            }
            renderTable(tab, resultData);
        }

        async function switchTab(tab) {
            currentTab = tab; await fetchData(); renderSearchPanel(tab);
            const container = document.getElementById('contentArea');
            const titles = {'partners':'거래처 관리','products':'품목 관리','purchase_orders':'발주 관리 (PO)','purchases':'구매 관리 (입고)','inventory':'재고 관리 현황','quotes':'견적 관리','orders':'주문 관리 (수주)','sales':'판매 관리 (출고)'};
            let html = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-slate-800 border-l-8 border-cyan-500 pl-4">${titles[tab]}</h2>`;
            if(tab === 'inventory') html += `<button onclick="openNewModal('purchases')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded font-bold shadow-md text-sm flex items-center gap-2"><i class="fa-solid fa-plus"></i> 제품 입고</button>`;
            else html += `<button onclick="openNewModal('${tab}')" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2.5 rounded font-bold shadow-md text-sm flex items-center gap-2"><i class="fa-solid fa-plus"></i> 신규 등록</button>`;
            html += `</div><div class="bg-white rounded-lg shadow border border-slate-200 overflow-hidden"><table class="data-table">`;

            if (tab === 'partners') html += `<thead><tr><th style="width:20%">상호</th><th style="width:15%">담당자</th><th style="width:20%">전화번호</th><th>비고</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'products') html += `<thead><tr><th style="width:15%">품목코드</th><th style="width:25%">품목명</th><th>규격</th><th style="width:8%">단위</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'purchase_orders') html += `<thead><tr><th style="width:12%">PO#</th><th style="width:15%">납품업체</th><th style="width:15%">EndUser</th><th>품목요약</th><th style="width:12%">총액</th><th style="width:10%">일자</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'purchases') html += `<thead><tr><th style="width:10%">일자</th><th style="width:15%">매입처</th><th>품목명</th><th style="width:6%">수량</th><th style="width:10%">단가</th><th style="width:10%">합계</th><th style="width:10%">시리얼</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            else if (tab === 'inventory') html += `<thead>
    <tr>
        <th style="width:12%">품목코드</th>
        <th style="width:20%">품목명</th>
        <th>규격</th>
        <th style="width:6%">단위</th>
        <th style="width:8%">총재고</th>  <th style="width:8%">가용재고</th> <th>비고</th>
        <th style="width:15%">예약현황</th> <th style="width:10%">관리</th>
    </tr></thead><tbody id="listBody"></tbody>`;
            else html += `<thead><tr><th style="width:10%">일자</th><th style="width:18%">거래처</th><th style="width:12%">담당자</th><th style="width:12%">공급가액</th><th style="width:10%">부가세</th><th style="width:12%">합계</th><th>비고</th><th style="width:15%">관리</th></tr></thead><tbody id="listBody"></tbody>`;
            
            html += `</table></div>`;
            container.innerHTML = html;
            runSearch(tab);
        }

        function renderTable(tab, data) {
            const tbody = document.getElementById('listBody'); tbody.innerHTML = '';
            if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="10" class="text-center p-8 text-slate-500">데이터가 없습니다.</td></tr>'; return; }

            data.forEach(row => {
                let tr = `<tr class="hover:bg-slate-50 border-b transition">`;
                const dataId = storeRowData(row);
                
                let actions = '<div class="flex justify-center items-center gap-3">';
                if(['quotes', 'orders', 'sales', 'purchase_orders'].includes(tab)) {
                     actions += `<button onclick="printDocument('${tab}', '${dataId}')" class="text-slate-600 hover:text-black p-2 rounded hover:bg-slate-200 transition" title="인쇄"><i class="fa-solid fa-print fa-lg"></i></button>`;
                }
                if(tab !== 'inventory') {
                    actions += `<button onclick="openEditModal('${tab}', '${dataId}')" class="text-blue-500 hover:text-blue-700 p-2 rounded hover:bg-blue-50 transition" title="수정"><i class="fa-solid fa-pen-to-square fa-lg"></i></button>`;
                }
                actions += `<button onclick="deleteItem('${tab}', ${row.id})" class="text-red-400 hover:text-red-600 p-2 rounded hover:bg-red-50 transition" title="삭제"><i class="fa-solid fa-trash-can fa-lg"></i></button>`;
                actions += '</div>';

                if (tab === 'partners') {
                    const fileIcon = row.biz_file_url 
                        ? `<a href="${row.biz_file_url}" target="_blank" class="text-green-600 hover:text-green-800 ml-2" title="사업자등록증 보기"><i class="fa-solid fa-file-pdf"></i></a>` 
                        : '';
                    tr += `<td>${row.name} ${fileIcon}</td><td class="text-center">${row.manager_name||'-'}</td><td class="text-center">${row.phone||'-'}</td><td>${row.note||''}</td><td>${actions}</td>`;
                }
                else if (tab === 'products') tr += `<td class="font-mono text-center text-cyan-600">${row.code}</td><td>${row.name}</td><td>${row.spec||'-'}</td><td class="text-center font-bold text-slate-600">${row.unit||'EA'}</td><td>${actions}</td>`;
                else if (tab === 'purchase_orders') {
                    const itemsSummary = row.items && row.items.length > 0 ? `${row.items[0].name} 외 ${row.items.length-1}건` : '-';
                    tr += `<td class="font-bold text-blue-600 text-center">${row.po_number}</td><td>${row.partner_name}</td><td class="text-center">${row.end_user||'-'}</td><td>${itemsSummary}</td><td class="font-bold text-right">${(row.total_amount||0).toLocaleString()}</td><td class="text-center">${row.date}</td><td>${actions}</td>`;
                } else if (tab === 'purchases') {
                    tr += `<td class="text-center">${row.date}</td><td>${row.partner_name}</td><td>${row.item_name}</td><td class="text-center font-bold">${row.qty}</td><td class="text-right">${(row.unit_price||0).toLocaleString()}</td><td class="text-right font-bold">${(row.total_amount||0).toLocaleString()}</td><td class="text-center">${row.serial_no||'-'}</td><td>${actions}</td>`;
                } else if (tab === 'inventory') { 
                } else {
                    tr += `<td class="text-center">${row.date}</td><td class="font-bold">${row.partner_name||'-'}</td><td class="text-center">${row.manager||'-'}</td><td class="text-right text-slate-600">${(row.total_supply||0).toLocaleString()}</td><td class="text-right text-slate-400 text-xs">${(row.total_vat||0).toLocaleString()}</td><td class="text-right font-bold text-cyan-700">${(row.total_amount||0).toLocaleString()}</td><td>${row.note||''}</td><td>${actions}</td>`;
                }
                if(tab !== 'inventory') tbody.innerHTML += tr;
            });
        }

        function openEditModal(tab, dataId) {
            const row = getRowData(dataId);
            if (!row) return alert('데이터 오류');
            currentEditId = row.id;
            openNewModal(tab, true);
            setTimeout(() => {
                if(tab === 'partners') { 
                    document.getElementById('pName').value = row.name; 
                    document.getElementById('pBiz').value = row.biz_num||''; 
                    document.getElementById('pOwner').value = row.owner_name||''; 
                    document.getElementById('pManager').value = row.manager_name||''; 
                    document.getElementById('pPhone').value = row.phone||''; 
                    document.getElementById('pEmail').value = row.email||''; 
                    document.getElementById('pAddr').value = row.address||'';
                    document.getElementById('pNote').value = row.note||''; 
                    const linkDiv = document.getElementById('pCurrentFileLink');
                    if(row.biz_file_url) {
                        linkDiv.innerHTML = `<a href="${row.biz_file_url}" target="_blank" class="text-blue-600 hover:underline font-bold ml-2">[기존 파일 보기]</a>`;
                    } else {
                        linkDiv.innerHTML = `<span class="text-slate-400 ml-2">(파일 없음)</span>`;
                    }
                }
                else if(tab === 'products') { document.getElementById('prodName').value = row.name; document.getElementById('prodCode').value = row.code; document.getElementById('prodUnit').value = row.unit||''; document.getElementById('prodSpec').value = row.spec||''; }
                else if(tab === 'purchases') { document.getElementById('purDate').value = row.date; document.getElementById('purPartner').value = row.partner_name; document.getElementById('purItem').value = row.item_name; document.getElementById('purQty').value = row.qty; document.getElementById('purPrice').value = row.unit_price; document.getElementById('purSerial').value = row.serial_no||''; document.getElementById('purNote').value = row.note||''; }
                else if(tab === 'purchase_orders') { 
                    document.getElementById('poNum').value = row.po_number; 
                    document.getElementById('poDate').value = row.date; 
                    document.getElementById('poPartner').value = row.partner_name; 
                    document.getElementById('poEndUser').value = row.end_user||''; 
                    document.getElementById('poManager').value = row.manager||''; 
                    document.getElementById('poPreOrder').value = row.is_pre_order||''; 
                    document.getElementById('poNote').value = row.note||'';
                    document.getElementById('poPManager').value = row.partner_manager || '';
                    document.getElementById('poPhone').value = row.phone || '';
                    document.getElementById('poEmail').value = row.email || '';
                    document.getElementById('poAddr').value = row.partner_address || '';
                    tempItems = row.items || []; renderGrid(); 
                }
                else { 
                    document.getElementById('sDate').value = row.date; 
                    document.getElementById('sPartner').value = row.partner_name; 
                    document.getElementById('sManager').value = row.manager||''; 
                    document.getElementById('sNote').value = row.note||''; 
                    if(document.getElementById('sPManager')) document.getElementById('sPManager').value = row.partner_manager || ''; 
                    if(document.getElementById('sContact')) document.getElementById('sContact').value = row.phone || ''; 
                    if(document.getElementById('sAddr')) document.getElementById('sAddr').value = row.partner_address || ''; 
                    if(document.getElementById('sEmail')) document.getElementById('sEmail').value = row.email || ''; 
                    tempItems = row.items || []; renderGrid(); 
                }
            }, 50);
        }

        async function openNewModal(tab, isEdit = false) {
            if(!isEdit) { currentEditId = null; tempItems = []; }
            const modal = document.getElementById('genericModal');
            document.getElementById('modalTitle').innerText = getTitle(tab) + (isEdit ? ' 수정' : ' 등록');
            const body = document.getElementById('modalBody');
            modal.classList.add('active');
            let html = ''; const today = new Date().toISOString().split('T')[0];
            
            if (tab === 'purchase_orders') {
                let autoPO = '';
                if (!isEdit) {
                    const { count } = await supabase.from('purchase_orders').select('*', { count: 'exact', head: true }).eq('date', today);
                    const nextSeq = (count || 0) + 1;
                    const seqStr = String(nextSeq).padStart(2, '0');
                    const yymmdd = today.slice(2).replace(/-/g,'');
                    autoPO = `ASPEC-${yymmdd}-P${seqStr}`;
                }
                
                html = `<div class="bg-slate-50 p-4 rounded mb-4 border">
                    <div class="grid grid-cols-3 gap-3 mb-2">
                        <div><label class="text-xs text-slate-500">PO# (자동생성)</label><input id="poNum" class="input-box bg-gray-100" value="${autoPO}"></div>
                        <div><label class="text-xs text-slate-500">수주일자</label><input type="date" id="poDate" class="input-box" value="${today}"></div>
                        <div><label class="text-xs text-slate-500">납품업체 (자동연동)</label><input id="poPartner" class="input-box" list="dl_part" onchange="fillPOPart(this.value)"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-2">
                        <div><label class="text-xs text-slate-500">거래처 담당자</label><input id="poPManager" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">연락처</label><input id="poPhone" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">선발주여부</label><select id="poPreOrder" class="input-box"><option>N</option><option>Y</option></select></div>
                    </div>
                    <div class="mb-2"><label class="text-xs text-slate-500">주소</label><input id="poAddr" class="input-box"></div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div><label class="text-xs text-slate-500">이메일</label><input id="poEmail" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">비고</label><input id="poNote" class="input-box"></div>
                    </div>
        
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div><label class="text-xs text-slate-500">EndUser</label><input id="poEndUser" class="input-box"></div>
                        <div><label class="text-xs text-slate-500">담당자(우리측)</label><input id="poManager" class="input-box"></div>
                    </div>
                </div>${renderItemInputArea(tab)}`;
            }
            else if (tab === 'partners') html = `
            <div class="grid grid-cols-2 gap-3">
                <div><label class="text-xs">상호 (필수)</label><input id="pName" class="input-box"></div>
                <div><label class="text-xs">사업자번호</label><input id="pBiz" class="input-box"></div>
                <div><label class="text-xs">대표자</label><input id="pOwner" class="input-box"></div>
                <div><label class="text-xs">담당자</label><input id="pManager" class="input-box"></div>
                <div><label class="text-xs">전화번호</label><input id="pPhone" class="input-box"></div>
                <div><label class="text-xs">이메일</label><input id="pEmail" class="input-box"></div>
                <div class="col-span-2"><label class="text-xs">주소</label><input id="pAddr" class="input-box" placeholder="주소를 입력하세요"></div>
                
                <div class="col-span-2 border p-2 rounded bg-slate-50">
                    <label class="text-xs font-bold">사업자등록증 (PDF/이미지)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="file" id="pFile" class="text-xs w-full" accept=".pdf,.jpg,.png,.jpeg">
                        <div id="pCurrentFileLink" class="text-xs flex items-center"></div>
                    </div>
                </div>
        
                <div class="col-span-2"><label class="text-xs">비고</label><input id="pNote" class="input-box"></div>
            </div>
            <button onclick="saveSimpleData('partners')" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold">저장</button>`;
            else if (tab === 'products') html = `<div class="grid grid-cols-2 gap-3"><div class="col-span-2"><label class="text-xs">품목명 (필수)</label><input id="prodName" class="input-box" oninput="autoGenCode(this.value)"></div><div><label class="text-xs">품목코드 (자동)</label><input id="prodCode" class="input-box bg-slate-100" readonly></div><div><label class="text-xs">단위</label><input id="prodUnit" class="input-box" placeholder="EA"></div><div class="col-span-2"><label class="text-xs">규격</label><input id="prodSpec" class="input-box"></div></div><button onclick="saveSimpleData('products')" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold">저장</button>`;
            else if (tab === 'purchases') html = `<div class="grid grid-cols-2 gap-3"><div><label class="text-xs">입고일자</label><input type="date" id="purDate" class="input-box" value="${today}"></div><div><label class="text-xs">매입처</label><input id="purPartner" class="input-box" list="dl_part"></div><div><label class="text-xs">품목명</label><input id="purItem" class="input-box" list="dl_prod"></div><div><label class="text-xs">수량</label><input type="number" id="purQty" class="input-box" value="0"></div><div><label class="text-xs">단가 (VAT별도)</label><input type="number" id="purPrice" class="input-box" value="0"></div><div><label class="text-xs">시리얼번호 (선택)</label><input type="text" id="purSerial" class="input-box"></div><div class="col-span-2"><label class="text-xs">비고</label><input id="purNote" class="input-box"></div></div><button onclick="savePurchase()" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold">저장</button><datalist id="dl_part"></datalist><datalist id="dl_prod"></datalist>`;
            else { renderComplexForm(tab, body); return; }
            body.innerHTML = html;
            if(tab === 'purchases' || tab === 'purchase_orders') { fillDL('dl_part', partnerList); fillDL('dl_prod', productList); }
        }

        async function saveData(tab, data) {
            let res;
            if (currentEditId) res = await supabase.from(tab).update(data).eq('id', currentEditId);
            else res = await supabase.from(tab).insert(data);
            if(res.error) { alert("오류: " + res.error.message); return false; }
            return true;
        }

        async function saveSimpleData(tab) {
            let data = {};
        
            if(tab === 'partners') {
                data = { 
                    name: el('pName'), biz_num: el('pBiz'), owner_name: el('pOwner'), 
                    manager_name: el('pManager'), phone: el('pPhone'), email: el('pEmail'), 
                    address: el('pAddr'), note: el('pNote') 
                };
        
                const fileInput = document.getElementById('pFile');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `biz_${Date.now()}.${fileExt}`; 
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('erp')
                        .upload(fileName, file);
        
                    if (uploadError) {
                        alert("파일 업로드 실패: " + uploadError.message);
                        return;
                    }
        
                    const { data: publicUrlData } = supabase.storage
                        .from('erp')
                        .getPublicUrl(fileName);
                    
                    data.biz_file_url = publicUrlData.publicUrl; 
                }
            }
            else if(tab === 'products') {
                data = { name: el('prodName'), code: el('prodCode'), spec: el('prodSpec'), unit: el('prodUnit') };
            }
        
            if(await saveData(tab, data)) { 
                closeModal(); 
                runSearch(tab); 
            }
        }

        async function savePurchase() {
            const qty = parseInt(el('purQty'))||0; const price = parseInt(el('purPrice'))||0; const supply = qty * price; const vat = Math.floor(supply * 0.1);
            const data = { date: el('purDate'), partner_name: el('purPartner'), item_name: el('purItem'), qty: qty, unit_price: price, supply_price: supply, vat: vat, total_amount: supply + vat, serial_no: el('purSerial'), note: el('purNote') };
            if(await saveData('purchases', data)) {
                if(!currentEditId) { const prod = productList.find(p => p.name === data.item_name); if(prod) await supabase.from('products').update({ stock: prod.stock + qty }).eq('id', prod.id); }
                alert("저장 완료"); closeModal(); runSearch('purchases');
            }
        }

        async function saveComplexData(tab) {
            if(tempItems.length === 0) return alert("품목 없음");
            let tSupply=0, tVat=0, tTotal=0; tempItems.forEach(i => { tSupply+=i.supply; tVat+=i.vat; tTotal+=i.total; });
            let dateVal = el(tab === 'purchase_orders' ? 'poDate' : 'sDate') || new Date().toISOString().split('T')[0];
            
            let data = { items: tempItems, total_supply: tSupply, total_vat: tVat, total_amount: tTotal, date: dateVal, partner_name: el('sPartner'), manager: el('sManager'), note: el('sNote') };
            
            if(tab === 'purchase_orders') { 
                data.po_number = el('poNum'); data.partner_name = el('poPartner'); data.end_user = el('poEndUser'); data.manager = el('poManager'); data.is_pre_order = el('poPreOrder'); data.note = el('poNote'); 
                data.partner_manager = el('poPManager');
                data.phone = el('poPhone');
                data.email = el('poEmail');
                data.partner_address = el('poAddr');
            } else { 
                data.email = el('sEmail'); 
                data.partner_manager = el('sPManager'); 
                data.phone = el('sContact');            
                data.partner_address = el('sAddr');     
                if(tab === 'orders') data.po_number = 'AUTO'; 
            }

            if(await saveData(tab, data)) { 
                if(tab === 'sales' && !currentEditId) { for(const item of tempItems) { const prod = productList.find(p => p.name === item.name); if(prod) await supabase.from('products').update({ stock: prod.stock - item.qty }).eq('id', prod.id); } }
                alert("저장되었습니다."); closeModal(); runSearch(tab);
            }
        }

        async function printDocument(tab, dataId) {
            const row = getRowData(dataId);
            if (!row) return alert('데이터 오류');

            const isPO = (tab === 'purchase_orders');
            
            let titleKo = "거 래 명 세 서", titleEn = "TRANSACTION STATEMENT";
            let prefix = "T"; 

            if (tab === 'quotes') { 
                titleKo = "견 적 서"; titleEn = "QUOTATION"; prefix = "Q";
            } else if (tab === 'orders') { 
                titleKo = "주 문 서"; titleEn = "ORDER SHEET"; prefix = "D";
            } else if (tab === 'sales') {
                titleKo = "거 래 명 세 서"; titleEn = "TRANSACTION STATEMENT"; prefix = "T";
            } else if (tab === 'purchase_orders') { 
                titleKo = "발 주 서"; titleEn = "PURCHASE ORDER"; prefix = "P";
            }

            document.getElementById('p_title_ko').innerText = titleKo;
            document.getElementById('p_title_en').innerText = titleEn;
            document.getElementById('p_date').innerText = row.date;

            if (isPO && row.po_number && row.po_number.startsWith('ASPEC')) {
                document.getElementById('p_no').innerText = row.po_number;
            } else {
                const { count, error } = await supabase.from(tab).select('*', { count: 'exact', head: true }).eq('date', row.date).lte('id', row.id);
                if (error) { alert("문서 번호 생성 중 오류 발생"); return; }
                const d = new Date(row.date);
                const yymmdd = d.getFullYear().toString().slice(2) + (d.getMonth() + 1).toString().padStart(2, '0') + d.getDate().toString().padStart(2, '0');
                const sequence = String(count).padStart(2, '0');
                document.getElementById('p_no').innerText = `ASPEC-${yymmdd}-${prefix}${sequence}`;
            }

            if (tab === 'quotes') {
                const d = new Date(row.date);
                const validDate = new Date(d); validDate.setDate(d.getDate() + 14);
                document.getElementById('p_valid_date').innerText = validDate.toISOString().split('T')[0];
                document.getElementById('p_valid_date_row').style.display = 'block';
            } else {
                document.getElementById('p_valid_date_row').style.display = 'none';
            }

            if (isPO) {
                document.getElementById('p_left_role').innerText = "공 급 받 는 자";
                document.getElementById('p_left_name').innerText = row.partner_name;
                document.getElementById('p_left_manager').innerText = row.partner_manager || ''; 
                document.getElementById('p_left_email').innerText = row.email || ''; 
                document.getElementById('p_left_phone').innerText = row.phone || '';
                document.getElementById('p_left_addr').innerText = row.partner_address || '';
                
                document.getElementById('p_right_role').innerText = "공 급 자";
                document.getElementById('p_right_name').innerText = "아스펙 (ASPEC)";
                document.getElementById('p_right_manager').innerText = "이창현";
                document.getElementById('p_right_email').innerText = currentUserEmail;
                document.getElementById('p_right_mp').innerText = "010-5919-1810";
            } else {
                document.getElementById('p_left_role').innerText = "공 급 받 는 자";
                document.getElementById('p_left_name').innerText = row.partner_name;
                document.getElementById('p_left_manager').innerText = row.partner_manager || '';
                document.getElementById('p_left_email').innerText = row.email || ''; 
                document.getElementById('p_left_phone').innerText = row.phone || '';
                document.getElementById('p_left_addr').innerText = row.partner_address || ''; 
                
                document.getElementById('p_right_role').innerText = "공 급 자";
                document.getElementById('p_right_name').innerText = "아스펙 (ASPEC)";
                document.getElementById('p_right_manager').innerText = "이창현";
                document.getElementById('p_right_email').innerText = currentUserEmail;
                document.getElementById('p_right_mp').innerText = "010-5919-1810"; 
            }

            const tbody = document.getElementById('p_tbody'); tbody.innerHTML = '';
            let sumQty = 0, sumAmt = 0;
            if (row.items) {
                row.items.forEach((item, idx) => {
                    sumQty += parseInt(item.qty) || 0; sumAmt += parseInt(item.supply) || 0;
                    tbody.innerHTML += `<tr class="items-row"><td style="text-align:center">${idx + 1}</td><td>${item.name}</td><td style="font-size:10px">${item.spec || '-'}</td><td style="text-align:center">${item.unit || 'EA'}</td><td style="text-align:center">${item.qty}</td><td style="text-align:right">${(item.price || 0).toLocaleString()}</td><td style="text-align:right">${(item.supply || 0).toLocaleString()}</td></tr>`;
                });
            }
            for (let i = 0; i < 10 - (row.items?.length || 0); i++) { tbody.innerHTML += `<tr class="items-row"><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`; }
            document.getElementById('p_total_qty').innerText = sumQty.toLocaleString();
            document.getElementById('p_total_amt').innerText = "₩ " + (row.total_amount || 0).toLocaleString();
            document.getElementById('p_note').innerText = row.note || '';

            document.getElementById('printContainer').classList.remove('hidden');
            setTimeout(() => { window.print(); document.getElementById('printContainer').classList.add('hidden'); }, 100);
        }

        function getTitle(tab) { const map = {'partners':'거래처','products':'품목','purchase_orders':'발주','purchases':'구매(입고)','quotes':'견적','orders':'주문','sales':'판매'}; return map[tab] || ''; }
        function closeModal() { document.getElementById('genericModal').classList.remove('active'); }
        function autoGenCode(val) { if(val && !currentEditId) document.getElementById('prodCode').value = 'P-' + Date.now().toString().slice(-6); }
        function el(id) { return document.getElementById(id) ? document.getElementById(id).value : ''; }
        function fillDL(id, list) { document.getElementById(id).innerHTML = list.map(i=>`<option value="${i.name}">`).join(''); }
        
        function fillPart(val) { 
            const f = partnerList.find(x=>x.name===val); 
            if(f) { 
                if(document.getElementById('sPManager')) document.getElementById('sPManager').value = f.manager_name||''; 
                if(document.getElementById('sContact')) document.getElementById('sContact').value = f.phone||'';
                if(document.getElementById('sAddr')) document.getElementById('sAddr').value = f.address||'';
                if(document.getElementById('sEmail')) document.getElementById('sEmail').value = f.email||'';
            } 
        }

        function fillPOPart(val) {
            const f = partnerList.find(x=>x.name===val);
            if(f) {
                if(document.getElementById('poPManager')) document.getElementById('poPManager').value = f.manager_name||'';
                if(document.getElementById('poPhone')) document.getElementById('poPhone').value = f.phone||'';
                if(document.getElementById('poEmail')) document.getElementById('poEmail').value = f.email||'';
                if(document.getElementById('poAddr')) document.getElementById('poAddr').value = f.address||'';
            }
        }

        function fillProd(val) { 
            const f = productList.find(x=>x.name===val); 
            if(f) {
                if(document.getElementById('iSpec')) document.getElementById('iSpec').value = f.spec || '';
            }
        }
        
        async function loadInventoryData(isSearch = false) {
            const tbody = document.getElementById('listBody'); 
            const ordersRes = await supabase.from('orders').select('*'); 
            const allOrders = ordersRes.data || []; 
            tbody.innerHTML = '';
            
            let filteredProducts = productList;
            if (isSearch) {
                const sName = document.getElementById('search_sName').value.toLowerCase(); 
                const sCode = document.getElementById('search_sCode').value.toLowerCase();
                filteredProducts = productList.filter(p => (sName ? p.name.toLowerCase().includes(sName) : true) && (sCode ? p.code.toLowerCase().includes(sCode) : true));
            }
            
            filteredProducts.forEach(prod => {
                let reservedQty = 0; 
                let partners = [];
                
                allOrders.forEach(ord => { 
                    if(ord.items) { 
                        ord.items.forEach(item => { 
                            if(item.name === prod.name) { 
                                reservedQty += item.qty; 
                                if(!partners.includes(ord.partner_name)) partners.push(ord.partner_name); 
                            } 
                        }); 
                    } 
                });
                
                const availableStock = prod.stock - reservedQty;
                const stockClass = availableStock < 0 ? 'text-red-600' : 'text-blue-600';
                
                let reservedText = reservedQty > 0 
                    ? `<span class="text-red-500 font-bold">(${reservedQty}개 예약)</span>` 
                    : '<span class="text-gray-300">-</span>';
        
                tbody.innerHTML += `
                <tr class="border-b hover:bg-slate-50">
                    <td class="font-mono text-center text-slate-500">${prod.code}</td>
                    <td class="font-bold">${prod.name}</td>
                    <td>${prod.spec||''}</td>
                    <td class="text-center text-xs">${prod.unit||'EA'}</td>
                    <td class="text-center">
                        <input type="number" id="stock_${prod.id}" value="${prod.stock}" class="border rounded px-2 py-1 w-16 text-center font-bold">
                    </td>
                    <td class="text-center font-bold ${stockClass}">${availableStock}</td>
                    <td><input type="text" id="note_${prod.id}" value="${prod.inventory_note||''}" class="border rounded px-2 py-1 w-full text-xs"></td>
                    <td class="text-xs text-center">${reservedText}</td>
                    <td class="text-center flex gap-1 justify-center">
                        <button onclick="showInventoryDetail(${prod.id})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs hover:bg-gray-600">상세</button>
                        <button onclick="updateInventory(${prod.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">저장</button>
                    </td>
                </tr>`;
            });
        }
        
        function showInventoryDetail(id) {
            const prod = productList.find(p => p.id === id);
            if(!prod) return;
            alert(`[ ${prod.name} 상세 정보 ]\n\n- 최근 입고일: ${prod.last_incoming_date || '기록 없음'}\n- 시리얼 번호: ${prod.last_serial_no || '없음'}\n- 규격: ${prod.spec || '-'}`);
        }
        
        async function updateInventory(id) { 
            const note = document.getElementById(`note_${id}`).value; 
            const newStock = parseInt(document.getElementById(`stock_${id}`).value) || 0; 
        
            const { error } = await supabase
                .from('products')
                .update({ 
                    inventory_note: note,
                    stock: newStock
                })
                .eq('id', id); 
                
            if(error) {
                alert("저장 실패: " + error.message); 
            } else {
                alert("재고 및 비고가 수정되었습니다.");
                fetchData().then(() => loadInventoryData(true));
            }
        }
        async function deleteItem(table, id) { if(!confirm("정말 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.")) return; const { error } = await supabase.from(table).delete().eq('id', id); if(error) alert("삭제 실패"); else { runSearch(table); } }
        async function openLoadModal(srcTab) { document.getElementById('loadDataModal').classList.add('active'); document.getElementById('loadModalTitle').innerText = (srcTab === 'quotes' ? '견적서' : '주문서') + ' 불러오기'; const tbody = document.getElementById('loadDataBody'); tbody.innerHTML = '<tr><td colspan="4">로딩중...</td></tr>'; const { data } = await supabase.from(srcTab).select('*').order('created_at', {ascending:false}); tbody.innerHTML = ''; if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4">데이터 없음</td></tr>'; return; } data.forEach(row => { tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td>${row.date}</td><td>${row.partner_name}</td><td class="text-right font-bold">${(row.total_amount||0).toLocaleString()}</td><td><button onclick='applyDataById("${storeRowData(row)}")' class="bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600">선택</button></td></tr>`; }); }
        function applyDataById(id) { const row = getRowData(id); applyData(row); }
        function applyData(row) { 
            document.getElementById('sPartner').value = row.partner_name || ''; 
            document.getElementById('sManager').value = row.manager || ''; 
            
            if(row.partner_address || row.phone || row.partner_manager) {
                if(document.getElementById('sPManager')) document.getElementById('sPManager').value = row.partner_manager || '';
                if(document.getElementById('sContact')) document.getElementById('sContact').value = row.phone || '';
                if(document.getElementById('sAddr')) document.getElementById('sAddr').value = row.partner_address || '';
                if(document.getElementById('sEmail')) document.getElementById('sEmail').value = row.email || '';
            } else {
                fillPart(row.partner_name); 
            }

            if(row.items) { tempItems = row.items; renderGrid(); } 
            document.getElementById('loadDataModal').classList.remove('active'); 
        }
        function logout() { supabase.auth.signOut().then(()=>window.location.href='index.html'); }
        function renderComplexForm(tab, container) {
            const today = new Date().toISOString().split('T')[0];
            let loadBtn = '';
            if(tab === 'orders') loadBtn = `<button onclick="openLoadModal('quotes')" class="bg-orange-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-orange-600">견적 불러오기</button>`;
            if(tab === 'sales') loadBtn = `<button onclick="openLoadModal('orders')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2 hover:bg-blue-600">주문 불러오기</button>`;
            
            container.innerHTML = `
            <div class="bg-slate-50 p-4 rounded mb-4 border">
                <div class="grid grid-cols-3 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">일자</label><input type="date" id="sDate" class="input-box" value="${today}"></div>
                    <div><label class="text-xs text-slate-500 flex items-center">거래처 ${loadBtn}</label><input id="sPartner" class="input-box" list="dl_part" onchange="fillPart(this.value)"></div>
                    <div><label class="text-xs text-slate-500">담당자(우리측)</label><input id="sManager" class="input-box"></div>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">거래처담당자</label><input id="sPManager" class="input-box"></div>
                    <div><label class="text-xs text-slate-500">연락처</label><input id="sContact" class="input-box"></div>
                    <div class="col-span-2"><label class="text-xs text-slate-500">주소</label><input id="sAddr" class="input-box"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <div><label class="text-xs text-slate-500">거래처이메일</label><input id="sEmail" class="input-box"></div>
                    <div><label class="text-xs text-slate-500">비고</label><input id="sNote" class="input-box"></div>
                </div>
            </div>${renderItemInputArea(tab)}`;
            fillDL('dl_part', partnerList); fillDL('dl_prod', productList);
        }
        function renderItemInputArea(tab) { 
            return `
            <div class="bg-white border p-3 rounded mb-4 shadow-sm">
                <div class="flex gap-2 items-end">
                    <div class="w-1/4"><label class="text-xs">품목명</label><input id="iName" class="input-box" list="dl_prod" onchange="fillProd(this.value)"></div>
                    <div class="flex-grow"><label class="text-xs">규격 (수정가능)</label><input id="iSpec" class="input-box"></div>
                    <div class="w-20"><label class="text-xs">수량</label><input type="number" id="iQty" class="input-box" value="1"></div>
                    <div class="w-28"><label class="text-xs">단가</label><input type="number" id="iPrice" class="input-box"></div>
                    <button onclick="addItemToGrid('${tab}')" class="bg-slate-700 text-white px-4 py-2 rounded font-bold text-sm h-9">추가</button>
                </div>
            </div>
            <table class="w-full text-sm border-collapse border text-center mb-4">
                <thead class="bg-slate-100">
                    <tr>
                        <th>품목명</th>
                        <th style="width:30%">규격</th> <th>수량</th>
                        <th>단가</th>
                        <th>공급가액</th>
                        <th>부가세</th>
                        <th>합계</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody id="itemGrid"></tbody>
            </table>
            <div class="text-right text-lg font-bold text-cyan-700">총 합계: <span id="sGrandTotal">0</span>원</div>
            <button onclick="saveComplexData('${tab}')" class="w-full mt-4 bg-cyan-600 text-white py-3 rounded font-bold shadow-lg">문서 저장</button>
            <datalist id="dl_part"></datalist><datalist id="dl_prod"></datalist>`; 
        }
        function addItemToGrid(tab) {
            const name = el('iName'); 
            const qty = parseInt(el('iQty'))||0; 
            const price = parseInt(el('iPrice'))||0;
            const spec = el('iSpec').value; 
            
            if(!name || qty <= 0) return alert("품목명과 수량을 확인해주세요.");
        
            const prod = productList.find(p => p.name === name);
            
            const supply = qty * price; 
            const vat = Math.floor(supply * 0.1); 
            const total = supply + vat;
            
            const unit = prod ? prod.unit : 'EA';
        
            tempItems.push({ name, qty, price, supply, vat, total, spec, unit });
            
            renderGrid(); 
            document.getElementById('iName').value=''; 
            document.getElementById('iQty').value='1';
            document.getElementById('iSpec').value=''; 
        }
        function renderGrid() {
            const tbody = document.getElementById('itemGrid'); tbody.innerHTML = ''; let grandTotal = 0;
            tempItems.forEach((item, idx) => {
                grandTotal += item.total;
                tbody.innerHTML += `<tr><td>${item.name}</td><td class="text-left px-2 text-slate-600 text-xs">${item.spec||''}</td><td>${item.qty}</td><td>${item.price.toLocaleString()}</td><td>${item.supply.toLocaleString()}</td><td>${item.vat.toLocaleString()}</td><td class="font-bold">${item.total.toLocaleString()}</td><td onclick="tempItems.splice(${idx},1); renderGrid()" class="cursor-pointer text-red-400"><i class="fa-solid fa-trash"></i></td></tr>`;
            });
            document.getElementById('sGrandTotal').innerText = grandTotal.toLocaleString();
        }
    </script>
</body>
</html>
